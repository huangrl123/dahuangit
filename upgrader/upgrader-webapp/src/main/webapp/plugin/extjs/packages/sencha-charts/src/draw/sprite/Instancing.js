Ext.define("Ext.draw.sprite.Instancing",{extend:"Ext.draw.sprite.Sprite",alias:"sprite.instancing",type:"instancing",isInstancing:true,config:{template:null},instances:null,applyTemplate:function(A){if(!Ext.isObject(A)){Ext.Error.raise("A template of an instancing sprite must either be a sprite instance  or a valid config object from which a template sprite will be created.")}else{if(A.isInstancing){Ext.Error.raise("Can't use an instancing sprite as a template for an instancing sprite.")}}if(!A.isSprite){if(!A.xclass&&!A.type){A.type="circle"}A=Ext.create(A.xclass||"sprite."+A.type,A)}A.setParent(this);A.attr.children=[];return A},updateTemplate:function(A){A.setSurface(this.getSurface());this.instances=[];this.position=0},updateSurface:function(B){var A=this.getTemplate();if(A){A.setSurface(B)}},createInstance:function(C,G,B,D){var E=this.getTemplate(),A=E.attr,F=Ext.Object.chain(A);E.topModifier.prepareAttributes(F);E.attr=F;E.setAttributes(C,B,D);F.data=G;this.instances.push(F);E.attr=A;this.position++;A.children.push(F);return F},getBBox:function(){return null},getBBoxFor:function(D,B){var C=this.getTemplate(),A=C.attr,E;C.attr=this.instances[D];E=C.getBBox(B);C.attr=A;return E},render:function(G,I,H,D){if(!this.getTemplate()){Ext.Error.raise("An instancing sprite must have a template.")}var A=this,B=A.getTemplate(),K=A.attr.matrix,E=B.attr,C=A.instances,J,F=A.position;K.toContext(I);B.preRender(G,I,H,D);B.useAttributes(I,D);for(J=0;J<F;J++){if(C[J].dirtyZIndex){break}}for(J=0;J<F;J++){if(C[J].hidden){continue}I.save();B.attr=C[J];B.applyTransformations();B.useAttributes(I,D);B.render(G,I,H,D);I.restore()}B.attr=E},setAttributesFor:function(E,D,B){var F=this.getTemplate(),A=F.attr,G=this.instances[E];F.attr=G;try{if(B){D=Ext.apply({},D)}else{D=F.self.def.normalize(D)}F.topModifier.pushDown(G,D);F.updateDirtyFlags(G)}catch(C){Ext.log.error(this.$className+": Unhandled Exception: ",C.description||C.message);throw C}finally{F.attr=A}},destroy:function(){this.callParent();this.instances.length=0;this.instances=null;if(this.getTemplate()){this.getTemplate().destroy()}}});
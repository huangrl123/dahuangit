Ext.define("Ext.data.proxy.WebStorage",{extend:"Ext.data.proxy.Client",alternateClassName:"Ext.data.WebStorageProxy",requires:["Ext.data.identifier.Sequential"],config:{id:undefined},constructor:function(A){this.callParent(arguments);this.cache={};if(this.getStorageObject()===undefined){Ext.Error.raise("Local Storage is not supported in this browser, please use another type of data proxy")}if(this.getId()===undefined){Ext.Error.raise("No unique id was provided to the local storage proxy. See Ext.data.proxy.LocalStorage documentation for details")}this.initialize()},create:function(C){var F=this,B=C.getRecords(),A=B.length,H=F.getIds(),E,G,D;C.setStarted();if(F.isHierarchical===undefined){F.isHierarchical=!!B[0].isNode;if(F.isHierarchical){F.getStorageObject().setItem(F.getTreeKey(),true)}}for(D=0;D<A;D++){G=B[D];if(G.phantom){G.phantom=false;E=F.getNextId()}else{E=G.getId()}F.setRecord(G,E);G.commit();H.push(E)}F.setIds(H);C.setSuccessful(true)},read:function(S){var F=this,Q,J=[],P=true,G=F.getModel(),M=0,H,L,E,R,D,B,K,A,N,C,O,I;S.setStarted();if(F.isHierarchical){J=F.getTreeData()}else{K=F.getIds();A=K.length;C=S.getId();if(C){N=F.getRecord(C);if(N!==null){B=new G(N)}if(B){J.push(B)}else{P=false}}else{L=S.getSorters();H=S.getFilters();E=S.getLimit();Q=[];for(O=0;O<A;O++){Q.push(new G(F.getRecord(K[O])))}if(L){Ext.Array.sort(Q,Ext.util.Sorter.createComparator(L))}for(O=S.getStart()||0;O<A;O++){B=Q[O];D=true;if(H){for(I=0,R=H.length;I<R;I++){D=H[I].filter(B)}}if(D){J.push(B);M++}if(E&&M===E){break}}}}if(P){S.setResultSet(new Ext.data.ResultSet({records:J,total:J.length,loaded:true}));S.setSuccessful(true)}else{S.setException("Unable to load records")}},update:function(E){var B=E.getRecords(),A=B.length,F=this.getIds(),D,G,C;E.setStarted();for(C=0;C<A;C++){D=B[C];this.setRecord(D);D.commit();G=D.getId();if(G!==undefined&&Ext.Array.indexOf(F,G)===-1){F.push(G)}}this.setIds(F);E.setSuccessful(true)},erase:function(E){var A=this,D=E.getRecords(),I=A.getIds(),B=I.length,C=[],H={},F=D.length,G;E.setStarted();for(;F--;){Ext.apply(H,A.removeRecord(D[F]))}for(F=0;F<B;F++){G=I[F];if(!H[G]){C.push(G)}}A.setIds(C);E.setSuccessful(true)},getRecord:function(D){var C=this,A=C.cache,B=!A[D]?Ext.decode(C.getStorageObject().getItem(C.getRecordKey(D))):A[D];if(!B){return null}A[D]=B;B[C.getModel().prototype.idProperty]=D;return Ext.merge({},B)},setRecord:function(K,H){if(H){K.set("id",H,{commit:true})}else{H=K.getId()}var I=this,B=K.getData(),D={},M=I.getModel(),L=M.getFields(),E=L.length,F=0,G,C,A,J;for(;F<E;F++){G=L[F];C=G.name;if(G.persist){D[C]=B[C]}}delete D[M.prototype.idProperty];if(K.isNode&&K.get("depth")===1){delete D.parentId}A=I.getStorageObject();J=I.getRecordKey(H);I.cache[H]=D;A.removeItem(J);A.setItem(J,Ext.encode(D))},removeRecord:function(D){var A=this,F=D.getId(),B={},C,E;B[F]=D;A.getStorageObject().removeItem(A.getRecordKey(F));delete A.cache[F];if(D.childNodes){E=D.childNodes;for(C=E.length;C--;){Ext.apply(B,A.removeRecord(E[C]))}}return B},getRecordKey:function(A){if(A.isModel){A=A.getId()}return Ext.String.format("{0}-{1}",this.getId(),A)},getRecordCounterKey:function(){return Ext.String.format("{0}-counter",this.getId())},getTreeKey:function(){return Ext.String.format("{0}-tree",this.getId())},getIds:function(){var D=this,E=(D.getStorageObject().getItem(D.getId())||"").split(","),A=E.length,C=this.getIdField().isStringField,B;if(A===1&&E[0]===""){E=[]}else{for(B=0;B<A;B++){E[B]=C?E[B]:+E[B]}}return E},getIdField:function(){return this.getModel().prototype.idField},setIds:function(C){var A=this.getStorageObject(),B=C.join(","),D=this.getId();A.removeItem(D);if(!Ext.isEmpty(B)){A.setItem(D,B)}},getNextId:function(){var D=this,B=D.getStorageObject(),A=D.getRecordCounterKey(),C=D.getIdField().isStringField,E;E=D.idGenerator.generate();B.setItem(A,E);if(C){E=E+""}return E},getTreeData:function(){var K=this,N=K.getIds(),D=N.length,A=[],L={},E=[],G=0,M=K.getModel(),I=M.prototype.idProperty,B,F,H,O,C,J;for(;G<D;G++){J=N[G];F=K.getRecord(J);A.push(F);L[J]=F;if(!F.parentId){E.push(F)}}B=E.length;Ext.Array.sort(A,K.sortByParentId);for(G=B;G<D;G++){F=A[G];O=F.parentId;if(!H||H[I]!==O){H=L[O];H.children=C=[]}C.push(F)}for(G=D;G--;){F=A[G];if(!F.children&&!F.leaf){F.loaded=true}}for(G=B;G--;){F=E[G];E[G]=new M(F)}return E},sortByParentId:function(A,B){return(A.parentId||0)-(B.parentId||0)},initialize:function(){var B=this,C=B.getStorageObject(),A=+C.getItem(B.getRecordCounterKey()),D=B.getId();C.setItem(D,C.getItem(D)||"");if(C.getItem(B.getTreeKey())){B.isHierarchical=true}B.idGenerator=new Ext.data.identifier.Sequential({seed:A?A+1:1})},clear:function(){var C=this,B=C.getStorageObject(),E=C.getIds(),D=E.length,A;for(A=0;A<D;A++){B.removeItem(C.getRecordKey(E[A]))}B.removeItem(C.getRecordCounterKey());B.removeItem(C.getTreeKey());B.removeItem(C.getId());C.cache={}},getStorageObject:function(){Ext.Error.raise("The getStorageObject function has not been defined in your Ext.data.proxy.WebStorage subclass")}});
Ext.define("Ext.data.proxy.Sql",{alias:"proxy.sql",extend:"Ext.data.proxy.Client",alternateClassName:"Ext.data.proxy.SQL",isSQLProxy:true,config:{reader:null,writer:null,table:null,database:"Sencha",columns:"",uniqueIdStrategy:false,tableExists:false,defaultDateFormat:"Y-m-d H:i:s.u"},updateModel:function(C){if(C){var D=C.modelName,A=this.getDefaultDateFormat(),B=D.slice(D.lastIndexOf(".")+1);C.getFields().each(function(E){if(E.isDateField&&!E.getDateFormat()){E.dateFormat=A}});this.setUniqueIdStrategy(C.getIdentifier().isUnique);if(!this.getTable()){this.setTable(B)}this.setColumns(this.getPersistedModelColumns(C))}this.callParent(arguments)},setException:function(A,B){A.setException(B)},create:function(E,A,C){var D=this,G=D.getDatabaseObject(),B=E.getRecords(),F=D.getTableExists();E.setStarted();G.transaction(function(H){if(!F){D.createTable(H)}D.insertRecords(B,H,function(I,J){if(E.process(E.getAction(),I)===false){D.fireEvent("exception",D,E)}if(J){E.setException(J)}},D)},function(H,I){D.setException(E,I);if(typeof A=="function"){A.call(C||D,E)}},function(H){if(typeof A=="function"){A.call(C||D,E)}})},read:function(N,A,F){var E=this,D=E.getDatabaseObject(),B=E.getModel(),P=B.getIdProperty(),I=E.getTableExists(),H=N.getParams()||{},L=H[P],Q=N.getSorters(),K=N.getFilters(),G=N.getPage(),R=N.getStart(),C=N.getLimit(),J,O,M;H=Ext.apply(H,{page:G,start:R,limit:C,sorters:Q,filters:K});N.setStarted();D.transaction(function(S){if(!I){E.createTable(S)}E.selectRecords(S,L!==undefined?L:H,function(T,U){if(N.process(N.getAction(),T)===false){E.fireEvent("exception",E,N)}if(U){N.setException(U)}if(K&&K.length){J=Ext.create("Ext.util.Collection",function(V){return V.getId()});J.setFilterRoot("data");for(O=0,M=K.length;O<M;O++){if(K[O].getProperty()===null){J.addFilter(K[O])}}J.addAll(N.getRecords());N.setRecords(J.items.slice());T.setRecords(N.getRecords());T.setCount(J.items.length);T.setTotal(J.items.length)}})},function(S,T){E.setException(N,T);if(typeof A=="function"){A.call(F||E,N)}},function(S){if(typeof A=="function"){A.call(F||E,N)}})},update:function(E,A,C){var D=this,B=E.getRecords(),G=D.getDatabaseObject(),F=D.getTableExists();E.setStarted();G.transaction(function(H){if(!F){D.createTable(H)}D.updateRecords(H,B,function(J,I){if(E.process(E.getAction(),J)===false){D.fireEvent("exception",D,E)}if(I){E.setException(I)}})},function(H,I){D.setException(E,I);if(typeof A=="function"){A.call(C||D,E)}},function(H){if(typeof A=="function"){A.call(C||D,E)}})},erase:function(E,A,C){var D=this,B=E.getRecords(),G=D.getDatabaseObject(),F=D.getTableExists();E.setStarted();G.transaction(function(H){if(!F){D.createTable(H)}D.destroyRecords(H,B,function(I,J){if(E.process(E.getAction(),I)===false){D.fireEvent("exception",D,E)}if(J){E.setException(J)}})},function(H,I){D.setException(E,I);if(typeof A=="function"){A.call(C||D,E)}},function(H){if(typeof A=="function"){A.call(C||D,E)}})},createTable:function(A){A.executeSql("CREATE TABLE IF NOT EXISTS "+this.getTable()+" ("+this.getSchemaString()+")");this.setTableExists(true)},insertRecords:function(L,Q,A,H){var G=this,D=G.getTable(),J=G.getColumns(),P=L.length,N=0,B=[],O=[],K=[],F=G.getUniqueIdStrategy(),E,I,M,C;C=new Ext.data.ResultSet({records:O,success:true});for(E=0,I=J.length;E<I;E++){B.push("?")}M=B.join(", ");Ext.each(L,function(S){var U=S.getId(),R=G.getRecordData(S),T=G.getColumnValues(J,R);Q.executeSql("INSERT INTO "+D+" ("+J.join(", ")+") VALUES ("+M+")",T,function(W,V){N++;O.push({clientId:U,id:F?U:V.insertId,data:R,node:R});if(N===P&&typeof A=="function"){A.call(H||G,C,K.length>0?K:null)}},function(V,W){N++;K.push({clientId:U,error:W});if(N===P&&typeof A=="function"){A.call(H||G,C,K)}})})},selectRecords:function(F,K,A,H){var G=this,D=G.getTable(),R=G.getModel().getIdProperty(),M="SELECT * FROM "+D,L=[],U=" WHERE ",N=" ORDER BY ",E,O,P,S,C,Q,I,B,T,J;S=new Ext.data.ResultSet({records:L,success:true});if(!Ext.isObject(K)){M+=U+R+" = "+K}else{O=K.filters&&K.filters.length;if(O){for(E=0;E<O;E++){I=K.filters[E];T=I.getProperty();J=I.getValue();if(T!==null){M+=U+T+" "+(I.getAnyMatch()?("LIKE '%"+J+"%'"):("= '"+J+"'"));U=" AND "}}}O=K.sorters&&K.sorters.length;if(O){for(E=0;E<O;E++){B=K.sorters[E];T=B.getProperty();if(T!==null){M+=N+T+" "+B.getDirection();N=", "}}}if(K.page!==undefined){M+=" LIMIT "+parseInt(K.start,10)+", "+parseInt(K.limit,10)}}F.executeSql(M,null,function(W,V){Q=V.rows;C=Q.length;for(E=0,O=C;E<O;E++){P=Q.item(E);L.push({clientId:null,id:P[R],data:P,node:P})}S.setSuccess(true);S.setTotal(C);S.setCount(C);if(typeof A=="function"){A.call(H||G,S)}},function(V,W){S.setSuccess(false);S.setTotal(0);S.setCount(0);if(typeof A=="function"){A.call(H||G,S,W)}})},updateRecords:function(A,H,C,E){var L=this,O=L.getTable(),G=L.getColumns(),F=H.length,K=L.getModel().getIdProperty(),M=0,J=[],N=[],I,D,B;B=new Ext.data.ResultSet({records:J,success:true});Ext.each(H,function(R){var T=R.getId(),Q=L.getRecordData(R),S=L.getColumnValues(G,Q),P=[];for(I=0,D=G.length;I<D;I++){P.push(G[I]+" = ?")}A.executeSql("UPDATE "+O+" SET "+P.join(", ")+" WHERE "+K+" = ?",S.concat(T),function(V,U){M++;J.push({clientId:T,id:T,data:Q,node:Q});if(M===F&&typeof C=="function"){C.call(E||L,B,N.length>0?N:null)}},function(U,V){M++;N.push({clientId:T,error:V});if(M===F&&typeof C=="function"){C.call(E||L,B,N)}})})},destroyRecords:function(A,F,C,D){var K=this,N=K.getTable(),J=K.getModel().getIdProperty(),M=[],I=[],L=[],H,E,B,G;for(H=0,E=F.length;H<E;H++){M.push(J+" = ?");I.push(F[H].getId())}B=new Ext.data.ResultSet({records:L,success:true});A.executeSql("DELETE FROM "+N+" WHERE "+M.join(" OR "),I,function(P,O){for(H=0,E=F.length;H<E;H++){G=F[H];L.push({id:G.getId()})}if(typeof C=="function"){C.call(D||K,B)}},function(O,P){if(typeof C=="function"){C.call(D||K,B,P)}})},getRecordData:function(G){var F=this,H=G.getFields(),E=G.getIdProperty(),C=F.getUniqueIdStrategy(),B={},A,D;H.each(function(I){if(I.persist){A=I.name;if(A===E&&!C){return}D=G.get(A);if(I.isDateField){D=F.writeDate(I,D)}B[A]=D}},F);return B},getColumnValues:function(G,B){var F=G.length,E=[],A,C,D;for(A=0;A<F;A++){C=G[A];D=B[C];if(D!==undefined){E.push(D)}}return E},getSchemaString:function(){var H=this,A=[],K=H.getModel(),G=K.getIdProperty(),J=K.getFields().items,D=H.getUniqueIdStrategy(),C=J.length,E,F,I,B;for(E=0;E<C;E++){F=J[E];I=F.getType();B=F.name;if(B===G){if(D){I=H.convertToSqlType(I);A.unshift(G+" "+I)}else{A.unshift(G+" INTEGER PRIMARY KEY AUTOINCREMENT")}}else{I=H.convertToSqlType(I);A.push(B+" "+I)}}return A.join(", ")},getPersistedModelColumns:function(I){var H=I.getFields().items,C=this.getUniqueIdStrategy(),F=I.getIdProperty(),G=[],B=H.length,D,E,A;for(D=0;D<B;D++){E=H[D];A=E.name;if(A===F&&!C){continue}if(E.persist){G.push(E.name)}}return G},convertToSqlType:function(A){switch(A.toLowerCase()){case"date":case"string":case"auto":return"TEXT";case"int":return"INTEGER";case"float":return"REAL";case"bool":return"NUMERIC"}},writeDate:function(B,C){if(Ext.isEmpty(C)){return null}var A=B.getDateFormat()||this.getDefaultDateFormat();switch(A){case"timestamp":return C.getTime()/1000;case"time":return C.getTime();default:return Ext.Date.format(C,A)}},dropTable:function(B){var C=this,E=C.getTable(),A=B?B.callback:null,D=B?B.scope||C:null,F=C.getDatabaseObject();F.transaction(function(G){G.executeSql("DROP TABLE "+E)},function(G,H){if(typeof A=="function"){A.call(D||C,false,E,H)}},function(G){if(typeof A=="function"){A.call(D||C,true,E)}});C.setTableExists(false)},getDatabaseObject:function(){return openDatabase(this.getDatabase(),"1.0","Sencha Database",5*1024*1024)}});
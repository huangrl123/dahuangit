Ext.define("Ext.chart.series.Pie",{alternateClassName:["Ext.chart.PieSeries","Ext.chart.PieChart"],extend:"Ext.chart.series.Series",type:"pie",alias:"series.pie",accuracy:100000,rad:Math.PI*2/100000,highlightDuration:150,angleField:false,lengthField:false,donut:false,showInLegend:false,style:{},clockwise:false,rotation:undefined,constructor:function(A){this.callParent(arguments);var H=this,C=H.chart,D=C.surface,I=C.store,B=C.shadow,E=A.highlight,F,G,J;if(E){A.highlightCfg=Ext.merge({segment:{margin:20}},E,A.highlightCfg)}Ext.apply(H,A,{shadowAttributes:[{"stroke-width":6,"stroke-opacity":1,stroke:"rgb(200, 200, 200)",translate:{x:1.2,y:2}},{"stroke-width":4,"stroke-opacity":1,stroke:"rgb(150, 150, 150)",translate:{x:0.9,y:1.5}},{"stroke-width":2,"stroke-opacity":1,stroke:"rgb(100, 100, 100)",translate:{x:0.6,y:1}}]});H.group=D.getGroup(H.seriesId);if(B){for(F=0,G=H.shadowAttributes.length;F<G;F++){H.shadowGroups.push(D.getGroup(H.seriesId+"-shadows"+F))}}D.customAttributes.segment=function(K){var L=H.getSegment(K);if(!L.path||L.path.length===0){L.path=["M",0,0]}return L};H.__excludes=H.__excludes||[]},onRedraw:function(){this.initialize()},initialize:function(){var D=this,B=D.chart.getChartStore(),F=B.data.items,C,E,A;D.callParent();D.yField=[];if(D.label.field){for(C=0,E=F.length;C<E;C++){A=F[C];D.yField.push(A.get(D.label.field))}}},getSegment:function(e){var H=this,c=H.rad,Y=Math.cos,E=Math.sin,a=H.centerX,b=H.centerY,K=0,A=0,f=0,V=0,L=0,B=0,g=0,W=0,P=0,Q=0,F=0,G=0,X=0.01,C=e.startAngle,Z=e.endAngle,R=(C+Z)/2*c,O=e.margin||0,T=Math.min(C,Z)*c,J=Math.max(C,Z)*c,S=Y(T),N=E(T),I=Y(J),D=E(J),h=Y(R),d=E(R),U=0,M=0.707106781186548;if(J-T<X){return{path:""}}if(O!==0){a+=O*h;b+=O*d}A=a+e.endRho*S;B=b+e.endRho*N;V=a+e.endRho*I;W=b+e.endRho*D;F=a+e.endRho*h;G=b+e.endRho*d;if(e.startRho!==0){K=a+e.startRho*S;L=b+e.startRho*N;f=a+e.startRho*I;g=b+e.startRho*D;P=a+e.startRho*h;Q=b+e.startRho*d;return{path:[["M",A,B],["A",e.endRho,e.endRho,0,0,1,F,G],["L",F,G],["A",e.endRho,e.endRho,0,U,1,V,W],["L",V,W],["L",f,g],["A",e.startRho,e.startRho,0,U,0,P,Q],["L",P,Q],["A",e.startRho,e.startRho,0,0,0,K,L],["L",K,L],["Z"]]}}else{return{path:[["M",a,b],["L",A,B],["A",e.endRho,e.endRho,0,0,1,F,G],["L",F,G],["A",e.endRho,e.endRho,0,U,1,V,W],["L",V,W],["L",a,b],["Z"]]}}},calcMiddle:function(M){var I=this,G=I.rad,A=M.slice,J=I.centerX,K=I.centerY,H=A.startAngle,B=A.endAngle,F=+I.donut,L=-(H+B)*G/2,C=(M.endRho+M.startRho)/2,D=J+C*Math.cos(L),E=K-C*Math.sin(L);M.middle={x:D,y:E}},drawSeries:function(){var O=this,k=O.chart.getChartStore(),v=k.data.items,G,E=O.group,n=O.chart.animate,z=O.angleField||O.field||O.xField,W=[].concat(O.lengthField),V=0,N=O.chart,Ab=N.surface,Q=N.chartBBox,U=N.shadow,F=O.shadowGroups,P=O.shadowAttributes,h=F.length,q=W.length,g=0,C=+O.donut,S=[],Y=[],X=0,e=0,b=0,f=O.rotation,M=O.seriesStyle,y=O.colorArrayStyle,T=y&&y.length||0,J,d,A,H,K,u,R,a,w=0,c,Aa,B,r,t,D,m,Z,x,l,o,s,I,L;Ext.apply(M,O.style||{});O.setBBox();L=O.bbox;if(O.colorSet){y=O.colorSet;T=y.length}if(!k||!k.getCount()||O.seriesIsHidden){O.hide();O.items=[];return}O.unHighlightItem();O.cleanHighlights();u=O.centerX=Q.x+(Q.width/2);R=O.centerY=Q.y+(Q.height/2);O.radius=Math.min(u-Q.x,R-Q.y);O.slices=Aa=[];O.items=Y=[];for(Z=0,m=v.length;Z<m;Z++){G=v[Z];if(this.__excludes&&this.__excludes[Z]){continue}X+=+G.get(z);if(W[0]){for(x=0,V=0;x<q;x++){V+=+G.get(W[x])}S[Z]=V;e=Math.max(e,V)}}X=X||1;for(Z=0,m=v.length;Z<m;Z++){G=v[Z];if(this.__excludes&&this.__excludes[Z]){r=0}else{r=G.get(z);if(w===0){w=1}}if(w==1){w=2;if(Ext.isEmpty(f)){O.firstAngle=b=(O.clockwise?-1:1)*(O.accuracy*r/X/2)}else{if(!Ext.isEmpty(f.degrees)){f=Ext.draw.Draw.rad(f.degrees)}else{if(!Ext.isEmpty(f.radians)){f=f.radians}}O.firstAngle=b=O.accuracy*f/(2*Math.PI)}for(x=0;x<Z;x++){Aa[x].startAngle=Aa[x].endAngle=O.firstAngle}}l=b+(O.clockwise?1:-1)*(O.accuracy*r/X);c={series:O,value:r,startAngle:(O.clockwise?l:b),endAngle:(O.clockwise?b:l),storeItem:G};if(W[0]&&!(this.__excludes&&this.__excludes[Z])){D=+S[Z];c.rho=Math.floor(O.radius/e*D)}else{c.rho=O.radius}Aa[Z]=c;(function(){b=l})()}if(U){for(Z=0,m=Aa.length;Z<m;Z++){c=Aa[Z];c.shadowAttrs=[];G=k.getAt(Z);for(x=0,g=0,A=[];x<q;x++){B=E.getAt(Z*q+x);if(W[x]&&!(this.__excludes&&this.__excludes[Z])){a=G.get(W[x])/S[Z]*c.rho}else{a=c.rho}J={segment:{startAngle:c.startAngle,endAngle:c.endAngle,margin:0,rho:c.rho,startRho:g+(a*C/100),endRho:g+a},hidden:!c.value&&(c.startAngle%O.accuracy)==(c.endAngle%O.accuracy)};for(K=0,A=[];K<h;K++){d=P[K];H=F[K].getAt(Z);if(!H){H=N.surface.add(Ext.apply({},{type:"path",group:F[K],strokeLinejoin:"round"},J,d))}d=O.renderer(H,G,Ext.apply({},J,d),Z,k);if(n){O.onAnimate(H,{to:d})}else{H.setAttributes(d,true)}A.push(H)}c.shadowAttrs[x]=A}}}for(Z=0,m=Aa.length;Z<m;Z++){c=Aa[Z];G=k.getAt(Z);for(x=0,g=0;x<q;x++){B=E.getAt(Z*q+x);if(W[x]&&!(this.__excludes&&this.__excludes[Z])){a=G.get(W[x])/S[Z]*c.rho}else{a=c.rho}J=Ext.apply({segment:{startAngle:c.startAngle,endAngle:c.endAngle,margin:0,rho:c.rho,startRho:g+(a*C/100),endRho:g+a},hidden:(!c.value&&(c.startAngle%O.accuracy)==(c.endAngle%O.accuracy))},Ext.apply(M,y&&{fill:y[(q>1?x:Z)%T]}||{}));t=Ext.apply({},J.segment,{slice:c,series:O,storeItem:c.storeItem,index:Z});O.calcMiddle(t);if(U){t.shadows=c.shadowAttrs[x]}Y[Z]=t;if(!B){I=Ext.apply({type:"path",group:E,middle:t.middle},Ext.apply(M,y&&{fill:y[(q>1?x:Z)%T]}||{}));B=Ab.add(Ext.apply(I,J))}c.sprite=c.sprite||[];t.sprite=B;c.sprite.push(B);c.point=[t.middle.x,t.middle.y];if(n){J=O.renderer(B,G,J,Z,k);B._to=J;B._animating=true;O.onAnimate(B,{to:J,listeners:{afteranimate:{fn:function(){this._animating=false},scope:B}}})}else{J=O.renderer(B,G,Ext.apply(J,{hidden:false}),Z,k);B.setAttributes(J,true)}g+=a}}m=E.getCount();for(Z=0;Z<m;Z++){if(!Aa[(Z/q)>>0]&&E.getAt(Z)){E.getAt(Z).hide(true)}}if(U){h=F.length;for(K=0;K<m;K++){if(!Aa[(K/q)>>0]){for(x=0;x<h;x++){if(F[x].getAt(K)){F[x].getAt(K).hide(true)}}}}}O.renderLabels();O.renderCallouts()},setSpriteAttributes:function(D,B,A){var C=this;if(A){D.stopAnimation();D.animate({to:B,duration:C.highlightDuration})}else{D.setAttributes(B,true)}},createLabelLine:function(A,E){var B=this,C=B.label.calloutLine,D=B.chart.surface.add({type:"path",stroke:(A===undefined?"#555":((C&&C.color)||B.getLegendColor(A))),lineWidth:(C&&C.width)||2,path:"M0,0Z",hidden:E});return D},drawLabelLine:function(A,B,C,D){var E=this,F=A.lineSprite,G="M"+B.x+" "+B.y+"L"+C.x+" "+C.y+"Z";E.setSpriteAttributes(F,{"path":G},D)},onCreateLabel:function(C,K,E,J){var G=this,F=G.labelsGroup,A=G.label,I=G.centerX,H=G.centerY,B=K.middle,D=Ext.apply(G.seriesLabelStyle||{},A||{});return G.chart.surface.add(Ext.apply({"type":"text","text-anchor":"middle","group":F,"x":B.x,"y":B.y},D))},onPlaceLabel:function(S,m,I,v,O,l,B){var N=this,r=N.rad,L=N.chart,e=L.resizing,Y=N.label,s=Y.renderer,V=Y.field,P=N.centerX,Q=N.centerY,X=I.startAngle,h=I.endAngle,o=I.middle,U={x:o.x,y:o.y},M=o.x-P,p=o.y-Q,u={},z=1,R=Math.atan2(p,M||1),w=Ext.draw.Draw.degrees(R),K,t,J,F,W=(O==="outside"),c=S.attr.calloutLine,Ab=(c&&c.width)||2,f=(S.attr.padding||20)+(W?Ab/2+4:0),b=0,a=0,q,j,k;U.hidden=false;if(this.__excludes&&this.__excludes[v]){U.hidden=true}if(Y.hideLessThan){q=Math.min(X,h)*r;j=Math.max(X,h)*r;k=(j-q)*I.rho;if(k<Y.hideLessThan){U.hidden=S.showOnHighlight=true}}S.setAttributes({opacity:(U.hidden?0:1),text:s(m.get(V),S,m,I,v,O,l,B)},true);if(S.lineSprite){var E={opacity:(U.hidden?0:1)};if(U.hidden){E.translate={x:0,y:0}}N.setSpriteAttributes(S.lineSprite,E,false)}switch(O){case"outside":S.isOutside=true;z=I.endRho;b=(Math.abs(w)<=90?f:-f);a=(w>=0?f:-f);S.setAttributes({rotation:{degrees:0}},true);t=S.getBBox();J=t.width/2*Math.cos(R);F=t.height/2*Math.sin(R);J+=b;F+=a;z+=Math.sqrt(J*J+F*F);U.x=z*Math.cos(R)+P;U.y=z*Math.sin(R)+Q;break;case"rotate":w=Ext.draw.Draw.normalizeDegrees(w);w=(w>90&&w<270)?w+180:w;K=S.attr.rotation.degrees;if(K!=null&&Math.abs(K-w)>180*0.5){if(w>K){w-=360}else{w+=360}w=w%360}else{w=Ext.draw.Draw.normalizeDegrees(w)}U.rotate={degrees:w,x:U.x,y:U.y};break;default:break}U.translate={x:0,y:0};if(l&&!e&&(O!="rotate"||K!=null)){N.onAnimate(S,{to:U})}else{S.setAttributes(U,true)}S._from=u;if(S.isOutside&&c){var D=S.lineSprite,G=l,Z={x:(I.endRho-Ab/2)*Math.cos(R)+P,y:(I.endRho-Ab/2)*Math.sin(R)+Q},T={x:U.x,y:U.y},Aa={};function n(i){return i?i<0?-1:1:0}if(c&&c.length){Aa={x:(I.endRho+c.length)*Math.cos(R)+P,y:(I.endRho+c.length)*Math.sin(R)+Q}}else{var C=Ext.draw.Draw.normalizeRadians(-R),g=Math.cos(C),H=Math.sin(C),A=(t.width+Ab+4)/2,d=(t.height+Ab+4)/2;if(Math.abs(g)*d>Math.abs(H)*A){Aa.x=T.x-A*n(g);Aa.y=T.y+A*H/g*n(g)}else{Aa.x=T.x-d*g/H*n(H);Aa.y=T.y+d*n(H)}}if(!D){D=S.lineSprite=N.createLabelLine(v,U.hidden);G=false}N.drawLabelLine(S,Z,Aa,G)}else{delete S.lineSprite}},onPlaceCallout:function(J,R,C,E,P,I,D){var F=this,A=F.chart,V=F.centerX,W=F.centerY,L=C.middle,G={x:L.x,y:L.y},S=L.x-V,T=L.y-W,K=1,O,Q=Math.atan2(T,S||1),H=(J&&J.label?J.label.getBBox():{width:0,height:0}),B=20,M=10,U=10,N;if(!H.width||!H.height){return}K=C.endRho+B;O=(C.endRho+C.startRho)/2+(C.endRho-C.startRho)/3;G.x=K*Math.cos(Q)+V;G.y=K*Math.sin(Q)+W;S=O*Math.cos(Q);T=O*Math.sin(Q);if(A.animate){F.onAnimate(J.lines,{to:{path:["M",S+V,T+W,"L",G.x,G.y,"Z","M",G.x,G.y,"l",S>0?M:-M,0,"z"]}});F.onAnimate(J.box,{to:{x:G.x+(S>0?M:-(M+H.width+2*U)),y:G.y+(T>0?(-H.height-U/2):(-H.height-U/2)),width:H.width+2*U,height:H.height+2*U}});F.onAnimate(J.label,{to:{x:G.x+(S>0?(M+U):-(M+H.width+U)),y:G.y+(T>0?-H.height/4:-H.height/4)}})}else{J.lines.setAttributes({path:["M",S+V,T+W,"L",G.x,G.y,"Z","M",G.x,G.y,"l",S>0?M:-M,0,"z"]},true);J.box.setAttributes({x:G.x+(S>0?M:-(M+H.width+2*U)),y:G.y+(T>0?(-H.height-U/2):(-H.height-U/2)),width:H.width+2*U,height:H.height+2*U},true);J.label.setAttributes({x:G.x+(S>0?(M+U):-(M+H.width+U)),y:G.y+(T>0?-H.height/4:-H.height/4)},true)}for(N in J){J[N].show(true)}},onAnimate:function(A,B){A.show();return this.callParent(arguments)},isItemInPoint:function(L,M,N,I){var K=this,F=K.centerX,E=K.centerY,C=Math.abs,H=C(L-F),J=C(M-E),A=N.startAngle,B=N.endAngle,G=Math.sqrt(H*H+J*J),D=Math.atan2(M-E,L-F)/K.rad;if(K.clockwise){if(D<K.firstAngle){D+=K.accuracy}}else{if(D>K.firstAngle){D-=K.accuracy}}return(D<=A&&D>B&&G>=N.startRho&&G<=N.endRho)},hideAll:function(C){var F,G,E,I,H,D,A;C=(isNaN(this._index)?C:this._index)||0;this.__excludes=this.__excludes||[];this.__excludes[C]=true;A=this.slices[C].sprite;for(H=0,D=A.length;H<D;H++){A[H].setAttributes({hidden:true},true);var B=A[H].lineSprite;if(B){B.setAttributes({hidden:true},true)}}if(this.slices[C].shadowAttrs){for(F=0,I=this.slices[C].shadowAttrs,G=I.length;F<G;F++){E=I[F];for(H=0,D=E.length;H<D;H++){E[H].setAttributes({hidden:true},true)}}}this.drawSeries()},showAll:function(A){A=(isNaN(this._index)?A:this._index)||0;this.__excludes[A]=false;this.drawSeries()},highlightItem:function(D){var H=this,P=H.rad,T,L,E,S,C,I,Q,B,G,R,N,O,U,M,A,J,K,F;D=D||this.items[this._index];this.unHighlightItem();if(!D||H.animating||(D.sprite&&D.sprite._animating)){return}H.callParent([D]);if(!H.highlight){return}if("segment" in H.highlightCfg){T=H.highlightCfg.segment;L=H.chart.animate;if(H.labelsGroup){N=H.labelsGroup;O=H.label.display;U=N.getAt(D.index);M=(D.startAngle+D.endAngle)/2*P;A=T.margin||0;J=A*Math.cos(M);K=A*Math.sin(M);if(Math.abs(J)<1e-10){J=0}if(Math.abs(K)<1e-10){K=0}E={translate:{x:J,y:K}};if(U.showOnHighlight){E.opacity=1;E.hidden=false}H.setSpriteAttributes(U,E,L);F=U.lineSprite;if(F){H.setSpriteAttributes(F,E,L)}}if(H.chart.shadow&&D.shadows){S=0;C=D.shadows;Q=C.length;for(;S<Q;S++){I=C[S];B={};G=D.sprite._from.segment;for(R in G){if(!(R in T)){B[R]=G[R]}}E={segment:Ext.applyIf(B,H.highlightCfg.segment)};H.setSpriteAttributes(I,E,L)}}}},unHighlightItem:function(){var I=this,Q,L,G,O,S,T,E,P,H,U,B,A,F,M,R,J,C,N,D;if(!I.highlight){return}if(("segment" in I.highlightCfg)&&I.items){Q=I.items;L=I.chart.animate;G=!!I.chart.shadow;O=I.labelsGroup;S=Q.length;T=0;E=0;P=I.label.display;for(;T<S;T++){C=Q[T];if(!C){continue}M=C.sprite;if(M&&M._highlighted){if(O){N=O.getAt(C.index);D=Ext.apply({translate:{x:0,y:0}},P=="rotate"?{rotate:{x:N.attr.x,y:N.attr.y,degrees:N.attr.rotation.degrees}}:{});if(N.showOnHighlight){D.opacity=0;D.hidden=true}I.setSpriteAttributes(N,D,L);var K=N.lineSprite;if(K){I.setSpriteAttributes(K,D,L)}}if(G){R=C.shadows;H=R.length;for(;E<H;E++){B={};A=C.sprite._to.segment;F=C.sprite._from.segment;Ext.apply(B,F);for(U in A){if(!(U in F)){B[U]=A[U]}}J=R[E];I.setSpriteAttributes(J,{segment:B},L)}}}}}I.callParent(arguments)},getLegendColor:function(B){var A=this;return(A.colorSet&&A.colorSet[B%A.colorSet.length])||A.colorArrayStyle[B%A.colorArrayStyle.length]}});
Ext.define("Ext.draw.Surface",{mixins:{observable:"Ext.util.Observable"},requires:["Ext.draw.CompositeSprite"],uses:["Ext.draw.engine.Svg","Ext.draw.engine.Vml","Ext.draw.engine.SvgExporter","Ext.draw.engine.ImageExporter"],separatorRe:/[, ]+/,enginePriority:["Svg","Vml"],statics:{create:function(C,A){A=A||this.prototype.enginePriority;var B=0,D=A.length;for(;B<D;B++){if(Ext.supports[A[B]]){return Ext.create("Ext.draw.engine."+A[B],C)}}return false},save:function(E,C){C=C||{};var A={"image/png":"Image","image/jpeg":"Image","image/svg+xml":"Svg"},B=A[C.type]||"Svg",D=Ext.draw.engine[B+"Exporter"];return D.generate(E,C)}},availableAttrs:{blur:0,"clip-rect":"0 0 1e9 1e9",cursor:"default",cx:0,cy:0,"dominant-baseline":"auto",fill:"none","fill-opacity":1,font:'10px "Arial"',"font-family":'"Arial"',"font-size":"10","font-style":"normal","font-weight":400,gradient:"",height:0,hidden:false,href:"http://sencha.com/",opacity:1,path:"M0,0",radius:0,rx:0,ry:0,scale:"1 1",src:"",stroke:"none","stroke-dasharray":"","stroke-linecap":"butt","stroke-linejoin":"butt","stroke-miterlimit":0,"stroke-opacity":1,"stroke-width":1,target:"_blank",text:"","text-anchor":"middle",title:"Ext Draw",width:0,x:0,y:0,zIndex:0},container:undefined,height:352,width:512,x:0,y:0,orderSpritesByZIndex:true,constructor:function(A){var B=this;A=A||{};Ext.apply(B,A);B.domRef=Ext.getDoc().dom;B.customAttributes={};B.mixins.observable.constructor.call(B);B.getId();B.initGradients();B.initItems();if(B.renderTo){B.render(B.renderTo);delete B.renderTo}B.initBackground(A.background)},initSurface:Ext.emptyFn,renderItem:Ext.emptyFn,renderItems:Ext.emptyFn,setViewBox:function(B,C,D,A){if(isFinite(B)&&isFinite(C)&&isFinite(D)&&isFinite(A)){this.viewBox={x:B,y:C,width:D,height:A};this.applyViewBox()}},addCls:Ext.emptyFn,removeCls:Ext.emptyFn,setStyle:Ext.emptyFn,initGradients:function(){if(this.hasOwnProperty("gradients")){var B=this.gradients,C=this.addGradient,A,D;if(B){for(A=0,D=B.length;A<D;A++){if(C.call(this,B[A],A,D)===false){break}}}}},initItems:function(){var A=this.items;this.items=new Ext.draw.CompositeSprite();this.items.autoDestroy=true;this.groups=new Ext.draw.CompositeSprite();if(A){this.add(A)}},initBackground:function(B){var C=this,F=C.width,A=C.height,E,D;if(Ext.isString(B)){B={fill:B}}if(B){if(B.gradient){D=B.gradient;E=D.id;C.addGradient(D);C.background=C.add({type:"rect",isBackground:true,x:0,y:0,width:F,height:A,fill:"url(#"+E+")",zIndex:-1})}else{if(B.fill){C.background=C.add({type:"rect",isBackground:true,x:0,y:0,width:F,height:A,fill:B.fill,zIndex:-1})}else{if(B.image){C.background=C.add({type:"image",isBackground:true,x:0,y:0,width:F,height:A,src:B.image,zIndex:-1})}}}C.background.bboxExcluded=true}},setSize:function(B,A){this.applyViewBox()},scrubAttrs:function(E){var A,C={},D={},B=E.attr;for(A in B){if(this.translateAttrs.hasOwnProperty(A)){C[this.translateAttrs[A]]=B[A];D[this.translateAttrs[A]]=true}else{if(this.availableAttrs.hasOwnProperty(A)&&!D[A]){C[A]=B[A]}}}return C},onClick:function(A){this.processEvent("click",A)},onDblClick:function(A){this.processEvent("dblclick",A)},onMouseUp:function(A){this.processEvent("mouseup",A)},onMouseDown:function(A){this.processEvent("mousedown",A)},onMouseOver:function(A){this.processEvent("mouseover",A)},onMouseOut:function(A){this.processEvent("mouseout",A)},onMouseMove:function(A){this.fireEvent("mousemove",A)},onMouseEnter:Ext.emptyFn,onMouseLeave:Ext.emptyFn,addGradient:Ext.emptyFn,add:function(){var B=Array.prototype.slice.call(arguments),A,C=B.length>1,G,F,E,D,H;if(C||Ext.isArray(B[0])){G=C?B:B[0];F=[];for(E=0,D=G.length;E<D;E++){H=G[E];H=this.add(H);F.push(H)}return F}A=this.prepareItems(B[0],true)[0];this.insertByZIndex(A);this.onAdd(A);return A},insertByZIndex:function(B){var G=this,I=G.items.items,H=I.length,E=Math.ceil,F=B.attr.zIndex,D=H,A=D-1,C=0,J;if(G.orderSpritesByZIndex&&H&&F<I[A].attr.zIndex){while(C<=A){D=E((C+A)/2);J=I[D].attr.zIndex;if(J>F){A=D-1}else{if(J<F){C=D+1}else{break}}}while(D<H&&I[D].attr.zIndex<=F){D++}}G.items.insert(D,B);return D},onAdd:function(F){var A=F.group,E=F.draggable,B,D,C;if(A){B=[].concat(A);D=B.length;for(C=0;C<D;C++){A=B[C];this.getGroup(A).add(F)}delete F.group}if(E){F.initDraggable()}},remove:function(E,B){if(E){this.items.remove(E);var C=[].concat(this.groups.items),D=C.length,A;for(A=0;A<D;A++){C[A].remove(E)}E.onRemove();if(B===true){E.destroy()}}},removeAll:function(C){var B=this.items.items,D=B.length,A;for(A=D-1;A>-1;A--){this.remove(B[A],C)}},onRemove:Ext.emptyFn,onDestroy:Ext.emptyFn,applyViewBox:function(){var H=this,K=H.viewBox,G=H.width||1,A=H.height||1,F,C,D,I,E,B,J;if(K&&(G||A)){F=K.x;C=K.y;D=K.width;I=K.height;E=A/I;B=G/D;J=Math.min(B,E);if(D*J<G){F-=(G-D*J)/2/J}if(I*J<A){C-=(A-I*J)/2/J}H.viewBoxShift={dx:-F,dy:-C,scale:J};if(H.background){H.background.setAttributes(Ext.apply({},{x:F,y:C,width:G/J,height:A/J},{hidden:false}),true)}}else{if(H.background&&G&&A){H.background.setAttributes(Ext.apply({x:0,y:0,width:G,height:A},{hidden:false}),true)}}},getBBox:function(C,B){var A=this["getPath"+C.type](C);if(B){C.bbox.plain=C.bbox.plain||Ext.draw.Draw.pathDimensions(A);return C.bbox.plain}if(C.dirtyTransform){this.applyTransformations(C,true)}C.bbox.transform=C.bbox.transform||Ext.draw.Draw.pathDimensions(Ext.draw.Draw.mapPath(A,C.matrix));return C.bbox.transform},transformToViewBox:function(C,D){if(this.viewBoxShift){var B=this,A=B.viewBoxShift;return[C/A.scale-A.dx,D/A.scale-A.dy]}else{return[C,D]}},applyTransformations:function(C,B){if(C.type=="text"){C.bbox.transform=0;this.transform(C,false)}C.dirtyTransform=false;var A=this,D=C.attr;if(D.translation.x!=null||D.translation.y!=null){A.translate(C)}if(D.scaling.x!=null||D.scaling.y!=null){A.scale(C)}if(D.rotation.degrees!=null){A.rotate(C)}C.bbox.transform=0;this.transform(C,B);C.transformations=[]},rotate:function(D){var E,C=D.attr.rotation.degrees,A=D.attr.rotation.x,B=D.attr.rotation.y;if(!Ext.isNumber(A)||!Ext.isNumber(B)){E=this.getBBox(D,true);A=!Ext.isNumber(A)?E.x+E.width/2:A;B=!Ext.isNumber(B)?E.y+E.height/2:B}D.transformations.push({type:"rotate",degrees:C,x:A,y:B})},translate:function(C){var A=C.attr.translation.x||0,B=C.attr.translation.y||0;C.transformations.push({type:"translate",x:A,y:B})},scale:function(E){var F,C=E.attr.scaling.x||1,D=E.attr.scaling.y||1,A=E.attr.scaling.centerX,B=E.attr.scaling.centerY;if(!Ext.isNumber(A)||!Ext.isNumber(B)){F=this.getBBox(E,true);A=!Ext.isNumber(A)?F.x+F.width/2:A;B=!Ext.isNumber(B)?F.y+F.height/2:B}E.transformations.push({type:"scale",x:C,y:D,centerX:A,centerY:B})},rectPath:function(C,D,E,A,B){if(B){return[["M",C+B,D],["l",E-B*2,0],["a",B,B,0,0,1,B,B],["l",0,A-B*2],["a",B,B,0,0,1,-B,B],["l",B*2-E,0],["a",B,B,0,0,1,-B,-B],["l",0,B*2-A],["a",B,B,0,0,1,B,-B],["z"]]}return[["M",C,D],["l",E,0],["l",0,A],["l",-E,0],["z"]]},ellipsePath:function(C,D,B,A){if(A==null){A=B}return[["M",C,D],["m",0,-A],["a",B,A,0,1,1,0,2*A],["a",B,A,0,1,1,0,-2*A],["z"]]},getPathpath:function(A){return A.attr.path},getPathcircle:function(A){var B=A.attr;return this.ellipsePath(B.x,B.y,B.radius,B.radius)},getPathellipse:function(A){var B=A.attr;return this.ellipsePath(B.x,B.y,B.radiusX||(B.width/2)||0,B.radiusY||(B.height/2)||0)},getPathrect:function(A){var B=A.attr;return this.rectPath(B.x||0,B.y||0,B.width||0,B.height||0,B.r||0)},getPathimage:function(A){var B=A.attr;return this.rectPath(B.x||0,B.y||0,B.width,B.height)},getPathtext:function(A){var B=this.getBBoxText(A);return this.rectPath(B.x,B.y,B.width,B.height)},createGroup:function(B){var A=this.groups.get(B);if(!A){A=new Ext.draw.CompositeSprite({surface:this});A.id=B||Ext.id(null,"ext-surface-group-");this.groups.add(A)}return A},getGroup:function(B){var A;if(typeof B=="string"){A=this.groups.get(B);if(!A){A=this.createGroup(B)}}else{A=B}return A},prepareItems:function(D,A){D=[].concat(D);var C,B,E;for(B=0,E=D.length;B<E;B++){C=D[B];if(!(C instanceof Ext.draw.Sprite)){C.surface=this;D[B]=this.createItem(C)}else{C.surface=this}}return D},setText:Ext.emptyFn,createItem:Ext.emptyFn,getId:function(){return this.id||(this.id=Ext.id(null,"ext-surface-"))},destroy:function(){var A=this;delete A.domRef;if(A.background){A.background.destroy()}A.removeAll(true);Ext.destroy(A.groups.items)}});
Ext.define("Ext.direct.RemotingProvider",{extend:"Ext.direct.JsonProvider",alias:"direct.remotingprovider",requires:["Ext.util.MixedCollection","Ext.util.DelayedTask","Ext.direct.Transaction","Ext.direct.RemotingMethod"],enableBuffer:10,maxRetries:1,constructor:function(A){var B=this;B.callParent(arguments);B.namespace=(Ext.isString(B.namespace))?Ext.ns(B.namespace):B.namespace||Ext.global;B.transactions=new Ext.util.MixedCollection();B.callBuffer=[]},getNamespace:function(C,A){var B,D,E,F;C=C||Ext.global;B=A.toString().split(".");for(E=0,F=B.length;E<F;E++){D=B[E];C=C[D];if(typeof C==="undefined"){return C}}return C},createNamespaces:function(C,A){var B,D;C=C||Ext.global;B=A.toString().split(".");for(var E=0,F=B.length;E<F;E++){D=B[E];C[D]=C[D]||{};C=C[D]}return C},initAPI:function(){var F=this,A=F.actions,I=F.namespace,H,B,C,D,G,E;for(H in A){if(A.hasOwnProperty(H)){if(F.disableNestedActions){B=I[H];if(!B){B=I[H]={}}}else{B=F.getNamespace(I,H);if(!B){B=F.createNamespaces(I,H)}}C=A[H];for(D=0,G=C.length;D<G;++D){E=new Ext.direct.RemotingMethod(C[D]);B[E.name]=F.createHandler(H,E)}}}},createHandler:function(A,D){var C=this,E=Array.prototype.slice,B;if(!D.formHandler){B=function(){C.configureRequest(A,D,E.call(arguments,0))}}else{B=function(G,F,H){C.configureFormRequest(A,D,E.call(arguments,0))}}B.directCfg={action:A,method:D};return B},isConnected:function(){return !!this.connected},connect:function(){var A=this;if(A.url){A.initAPI();A.connected=true;A.fireEvent("connect",A)}else{if(!A.url){Ext.Error.raise('Error initializing RemotingProvider "'+A.id+'", no url configured.')}}},disconnect:function(){var A=this;if(A.connected){A.connected=false;A.fireEvent("disconnect",A)}},runCallback:function(E,G){var A=!!G.status,C=A?"success":"failure",F,D,B;if(E&&E.callback){F=E.callback;D=E.callbackOptions;B=typeof G.result!=="undefined"?G.result:G.data;if(Ext.isFunction(F)){F(B,G,A,D)}else{Ext.callback(F[C],F.scope,[B,G,A,D]);Ext.callback(F.callback,F.scope,[B,G,A,D])}}},onData:function(F,B,J){var G=this,E,H,I,D,A,C;if(B){I=G.createEvents(J);for(E=0,H=I.length;E<H;++E){D=I[E];A=G.getTransaction(D);G.fireEvent("data",G,D);if(A&&G.fireEvent("beforecallback",G,D,A)!==false){G.runCallback(A,D,true);Ext.direct.Manager.removeTransaction(A)}}}else{C=[].concat(F.transaction);for(E=0,H=C.length;E<H;++E){A=G.getTransaction(C[E]);if(A&&A.retryCount<G.maxRetries){A.retry()}else{D=new Ext.direct.ExceptionEvent({data:null,transaction:A,code:Ext.direct.Manager.exceptions.TRANSPORT,message:"Unable to connect to the server.",xhr:J});G.fireEvent("data",G,D);if(A&&G.fireEvent("beforecallback",G,A)!==false){G.runCallback(A,D,false);Ext.direct.Manager.removeTransaction(A)}}}}},getTransaction:function(A){return A&&A.tid?Ext.direct.Manager.getTransaction(A.tid):null},configureRequest:function(I,H,B){var G=this,K,D,C,E,F,A,J;K=H.getCallData(B);D=K.data;C=K.callback;E=K.scope;F=K.options||{};J=Ext.apply({},{provider:G,args:B,action:I,method:H.name,data:D,callbackOptions:F,callback:E&&Ext.isFunction(C)?Ext.Function.bind(C,E):C});if(F.timeout){Ext.applyIf(J,{timeout:F.timeout})}A=new Ext.direct.Transaction(J);if(G.fireEvent("beforecall",G,A,H)!==false){Ext.direct.Manager.addTransaction(A);G.queueTransaction(A);G.fireEvent("call",G,A,H)}},getCallData:function(A){return{action:A.action,method:A.method,data:A.data,type:"rpc",tid:A.id}},sendRequest:function(A){var F=this,B,C,E,H=F.enableUrlEncode,D,G;B={url:F.url,callback:F.onData,scope:F,transaction:A,timeout:F.timeout};if(A.timeout){B.timeout=A.timeout}if(Ext.isArray(A)){C=[];for(D=0,G=A.length;D<G;++D){C.push(F.getCallData(A[D]))}}else{C=F.getCallData(A)}if(H){E={};E[Ext.isString(H)?H:"data"]=Ext.encode(C);B.params=E}else{B.jsonData=C}Ext.Ajax.request(B)},queueTransaction:function(B){var A=this,C=A.enableBuffer;if(B.form){A.sendFormRequest(B);return}if(C===false||typeof B.timeout!=="undefined"){A.sendRequest(B);return}A.callBuffer.push(B);if(C){if(!A.callTask){A.callTask=new Ext.util.DelayedTask(A.combineAndSend,A)}A.callTask.delay(Ext.isNumber(C)?C:10)}else{A.combineAndSend()}},combineAndSend:function(){var B=this,A=B.callBuffer,C=A.length;if(C>0){B.sendRequest(C==1?A[0]:A);B.callBuffer=[]}},configureFormRequest:function(J,I,B){var H=this,F=B[0],C=B[1],D=B[2],A,E,G;A=new Ext.direct.Transaction({provider:H,action:J,method:I.name,args:[F,C,D],callback:D&&Ext.isFunction(C)?Ext.Function.bind(C,D):C,isForm:true});if(H.fireEvent("beforecall",H,A,I)!==false){Ext.direct.Manager.addTransaction(A);E=String(F.getAttribute("enctype")).toLowerCase()=="multipart/form-data";G={extTID:A.id,extAction:J,extMethod:I.name,extType:"rpc",extUpload:String(E)};Ext.apply(A,{form:Ext.getDom(F),isUpload:E,params:C&&Ext.isObject(C.params)?Ext.apply(G,C.params):G});H.fireEvent("call",H,A,I);H.sendFormRequest(A)}},sendFormRequest:function(B){var A=this;Ext.Ajax.request({url:A.url,params:B.params,callback:A.onData,scope:A,form:B.form,isUpload:B.isUpload,transaction:B})}});
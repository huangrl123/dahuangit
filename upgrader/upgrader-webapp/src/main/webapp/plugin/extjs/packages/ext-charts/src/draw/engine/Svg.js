Ext.define("Ext.draw.engine.Svg",{extend:"Ext.draw.Surface",requires:["Ext.draw.Draw","Ext.draw.Sprite","Ext.draw.Matrix","Ext.Element"],engine:"Svg",trimRe:/^\s+|\s+$/g,spacesRe:/\s+/,xlink:"http://www.w3.org/1999/xlink",translateAttrs:{radius:"r",radiusX:"rx",radiusY:"ry",path:"d",lineWidth:"stroke-width",fillOpacity:"fill-opacity",strokeOpacity:"stroke-opacity",strokeLinejoin:"stroke-linejoin"},parsers:{},minDefaults:{circle:{cx:0,cy:0,r:0,fill:"none",stroke:null,"stroke-width":null,opacity:null,"fill-opacity":null,"stroke-opacity":null},ellipse:{cx:0,cy:0,rx:0,ry:0,fill:"none",stroke:null,"stroke-width":null,opacity:null,"fill-opacity":null,"stroke-opacity":null},rect:{x:0,y:0,width:0,height:0,rx:0,ry:0,fill:"none",stroke:null,"stroke-width":null,opacity:null,"fill-opacity":null,"stroke-opacity":null},text:{x:0,y:0,"text-anchor":"start","font-family":null,"font-size":null,"font-weight":null,"font-style":null,fill:"#000",stroke:null,"stroke-width":null,opacity:null,"fill-opacity":null,"stroke-opacity":null},path:{d:"M0,0",fill:"none",stroke:null,"stroke-width":null,opacity:null,"fill-opacity":null,"stroke-opacity":null},image:{x:0,y:0,width:0,height:0,preserveAspectRatio:"none",opacity:null}},createSvgElement:function(A,D){var C=this.domRef.createElementNS("http://www.w3.org/2000/svg",A),B;if(D){for(B in D){C.setAttribute(B,String(D[B]))}}return C},createSpriteElement:function(B){var A=this.createSvgElement(B.type);A.id=B.id;if(A.style){A.style.webkitTapHighlightColor="rgba(0,0,0,0)"}B.el=Ext.get(A);this.applyZIndex(B);B.matrix=new Ext.draw.Matrix();B.bbox={plain:0,transform:0};this.applyAttrs(B);this.applyTransformations(B);B.fireEvent("render",B);return A},getBBoxText:function(B){var H={},C,I,G,F,D,E;if(B&&B.el){E=B.el.dom;try{H=E.getBBox();return H}catch(A){}H={x:H.x,y:Infinity,width:0,height:0};D=E.getNumberOfChars();for(F=0;F<D;F++){C=E.getExtentOfChar(F);H.y=Math.min(C.y,H.y);I=C.y+C.height-H.y;H.height=Math.max(H.height,I);G=C.x+C.width-H.x;H.width=Math.max(H.width,G)}return H}},hide:function(){Ext.get(this.el).hide()},show:function(){Ext.get(this.el).show()},hidePrim:function(A){this.addCls(A,Ext.baseCSSPrefix+"hide-visibility")},showPrim:function(A){this.removeCls(A,Ext.baseCSSPrefix+"hide-visibility")},getDefs:function(){return this._defs||(this._defs=this.createSvgElement("defs"))},transform:function(A,G){var E=this,B=new Ext.draw.Matrix(),I=A.transformations,D=I.length,C=0,H,F;for(;C<D;C++){H=I[C];F=H.type;if(F=="translate"){B.translate(H.x,H.y)}else{if(F=="rotate"){B.rotate(H.degrees,H.x,H.y)}else{if(F=="scale"){B.scale(H.x,H.y,H.centerX,H.centerY)}}}}A.matrix=B;if(!G){A.el.set({transform:B.toSvg()})}},setSize:function(D,B){var C=this,A=C.el;D=+D||C.width;B=+B||C.height;C.width=D;C.height=B;A.setSize(D,B);A.set({width:D,height:B});C.callParent([D,B])},getRegion:function(){var A=this.el.getXY(),D=this.bgRect.getXY(),E=Math.max,B=E(A[0],D[0]),C=E(A[1],D[1]);return{left:B,top:C,right:B+this.width,bottom:C+this.height}},onRemove:function(A){if(A.el){A.el.destroy();delete A.el}this.callParent(arguments)},setViewBox:function(B,C,D,A){if(isFinite(B)&&isFinite(C)&&isFinite(D)&&isFinite(A)){this.callParent(arguments);this.el.dom.setAttribute("viewBox",[B,C,D,A].join(" "))}},render:function(D){var B=this,E,A,C,G,F;if(!B.el){E={xmlns:"http://www.w3.org/2000/svg",version:1.1,width:B.width||0,height:B.height||0};if(B.forceLtr){E.direction="ltr"}A=B.createSvgElement("svg",E);C=B.getDefs();G=B.createSvgElement("rect",{width:"100%",height:"100%",fill:"#000",stroke:"none",opacity:0});if(Ext.isSafari3){F=B.createSvgElement("rect",{x:-10,y:-10,width:"110%",height:"110%",fill:"none",stroke:"#000"})}A.appendChild(C);if(Ext.isSafari3){A.appendChild(F)}A.appendChild(G);D.appendChild(A);B.el=Ext.get(A);B.bgRect=Ext.get(G);if(Ext.isSafari3){B.webkitRect=Ext.get(F);B.webkitRect.hide()}B.el.on({scope:B,mouseup:B.onMouseUp,mousedown:B.onMouseDown,mouseover:B.onMouseOver,mouseout:B.onMouseOut,mousemove:B.onMouseMove,mouseenter:B.onMouseEnter,mouseleave:B.onMouseLeave,click:B.onClick,dblclick:B.onDblClick})}B.renderAll()},onMouseEnter:function(A){if(this.el.parent().getRegion().contains(A.getPoint())){this.fireEvent("mouseenter",A)}},onMouseLeave:function(A){if(!this.el.parent().getRegion().contains(A.getPoint())){this.fireEvent("mouseleave",A)}},processEvent:function(B,A){var C=A.getTarget(),E=this.surface,D;this.fireEvent(B,A);if(C.nodeName=="tspan"&&C.parentNode){C=C.parentNode}D=this.items.get(C.id);if(D){D.fireEvent(B,D,A)}},tuneText:function(A,D){var F=A.el.dom,H=[],C,J,I,G,E,B,K,L;if(D.hasOwnProperty("text")){I=A.tspans&&Ext.Array.map(A.tspans,function(M){return M.textContent}).join("");if(!A.tspans||D.text!=I){H=this.setText(A,D.text);A.tspans=H}else{H=A.tspans||[]}}if(H.length){C=this.getBBoxText(A).height;L=A.el.dom.getAttribute("x");for(G=0,E=H.length;G<E;G++){K=(Ext.isFF3_0||Ext.isFF3_5)?2:4;H[G].setAttribute("x",L);H[G].setAttribute("dy",G?C*1.2:C/K)}A.dirty=true}},setText:function(A,K){var J=this,E=A.el.dom,G=[],C,I,H,F,D,B;while(E.firstChild){E.removeChild(E.firstChild)}B=String(K).split("\n");for(F=0,D=B.length;F<D;F++){H=B[F];if(H){I=J.createSvgElement("tspan");I.appendChild(document.createTextNode(Ext.htmlDecode(H)));E.appendChild(I);G[F]=I}}return G},renderAll:function(){this.items.each(this.renderItem,this)},renderItem:function(A){if(!this.el){return}if(!A.el){this.createSpriteElement(A)}if(A.zIndexDirty){this.applyZIndex(A)}if(A.dirty){this.applyAttrs(A);if(A.dirtyTransform){this.applyTransformations(A)}}},redraw:function(A){A.dirty=A.zIndexDirty=true;this.renderItem(A)},applyAttrs:function(J){var F=this,O=J.el,K=J.group,M=J.attr,B=F.parsers,C=F.gradientsMap||{},I=Ext.isSafari&&!Ext.isStrict,A,N,L,D,G,E,Q,P,H;if(K){A=[].concat(K);L=A.length;for(N=0;N<L;N++){K=A[N];F.getGroup(K).add(J)}delete J.group}D=F.scrubAttrs(J)||{};J.bbox.plain=0;J.bbox.transform=0;if(J.type=="circle"||J.type=="ellipse"){D.cx=D.cx||D.x;D.cy=D.cy||D.y}else{if(J.type=="rect"){D.rx=D.ry=D.r}else{if(J.type=="path"&&D.d){D.d=Ext.draw.Draw.pathToString(Ext.draw.Draw.pathToAbsolute(D.d))}}}J.dirtyPath=false;if(D["clip-rect"]){F.setClip(J,D);delete D["clip-rect"]}if(J.type=="text"&&D.font&&J.dirtyFont){O.set({style:"font: "+D.font})}if(J.type=="image"){O.dom.setAttributeNS(F.xlink,"href",D.src)}Ext.applyIf(D,F.minDefaults[J.type]);if(J.dirtyHidden){(M.hidden)?F.hidePrim(J):F.showPrim(J);J.dirtyHidden=false}for(E in D){if(D.hasOwnProperty(E)&&D[E]!=null){if(I&&("color|stroke|fill".indexOf(E)>-1)&&(D[E] in C)){D[E]=C[D[E]]}if(E=="hidden"&&J.type=="text"){continue}if(E in B){O.dom.setAttribute(E,B[E](D[E],J,F))}else{O.dom.setAttribute(E,D[E])}}}if(J.type=="text"){F.tuneText(J,D)}J.dirtyFont=false;Q=M.style;if(Q){O.setStyle(Q)}J.dirty=false;if(Ext.isSafari3){F.webkitRect.show();setTimeout(function(){F.webkitRect.hide()})}},setClip:function(E,F){var D=this,C=F["clip-rect"],B,A;if(C){if(E.clip){E.clip.parentNode.parentNode.removeChild(E.clip.parentNode)}B=D.createSvgElement("clipPath");A=D.createSvgElement("rect");B.id=Ext.id(null,"ext-clip-");A.setAttribute("x",C.x);A.setAttribute("y",C.y);A.setAttribute("width",C.width);A.setAttribute("height",C.height);B.appendChild(A);D.getDefs().appendChild(B);E.el.dom.setAttribute("clip-path","url(#"+B.id+")");E.clip=A}},applyZIndex:function(F){var C=this,E=C.items,B=E.indexOf(F),A=F.el,D;if(C.el.dom.childNodes[B+2]!==A.dom){if(B>0){do{D=E.getAt(--B).el}while(!D&&B>0)}A.insertAfter(D||C.bgRect)}F.zIndexDirty=false},createItem:function(A){var B=new Ext.draw.Sprite(A);B.surface=this;return B},addGradient:function(F){F=Ext.draw.Draw.parseGradient(F);var G=this,D=F.stops.length,C=F.vector,J=Ext.isSafari&&!Ext.isStrict,A,B,H,E,I;I=G.gradientsMap||{};if(!J){if(F.type=="linear"){A=G.createSvgElement("linearGradient");A.setAttribute("x1",C[0]);A.setAttribute("y1",C[1]);A.setAttribute("x2",C[2]);A.setAttribute("y2",C[3])}else{A=G.createSvgElement("radialGradient");A.setAttribute("cx",F.centerX);A.setAttribute("cy",F.centerY);A.setAttribute("r",F.radius);if(Ext.isNumber(F.focalX)&&Ext.isNumber(F.focalY)){A.setAttribute("fx",F.focalX);A.setAttribute("fy",F.focalY)}}A.id=F.id;G.getDefs().appendChild(A);for(E=0;E<D;E++){B=F.stops[E];H=G.createSvgElement("stop");H.setAttribute("offset",B.offset+"%");H.setAttribute("stop-color",B.color);H.setAttribute("stop-opacity",B.opacity);A.appendChild(H)}}else{I["url(#"+F.id+")"]=F.stops[0].color}G.gradientsMap=I},hasCls:function(B,A){return A&&(" "+(B.el.dom.getAttribute("class")||"")+" ").indexOf(" "+A+" ")!=-1},addCls:function(A,H){var E=A.el,F,G,B,C=[],D=E.getAttribute("class")||"";if(!Ext.isArray(H)){if(typeof H=="string"&&!this.hasCls(A,H)){E.set({"class":D+" "+H})}}else{for(F=0,G=H.length;F<G;F++){B=H[F];if(typeof B=="string"&&(" "+D+" ").indexOf(" "+B+" ")==-1){C.push(B)}}if(C.length){E.set({"class":" "+C.join(" ")})}}},removeCls:function(A,J){var H=this,E=A.el,D=E.getAttribute("class")||"",F,C,I,G,B;if(!Ext.isArray(J)){J=[J]}if(D){B=D.replace(H.trimRe," ").split(H.spacesRe);for(F=0,I=J.length;F<I;F++){G=J[F];if(typeof G=="string"){G=G.replace(H.trimRe,"");C=Ext.Array.indexOf(B,G);if(C!=-1){Ext.Array.erase(B,C,1)}}}E.set({"class":B.join(" ")})}},destroy:function(){var A=this;A.callParent();if(A.el){A.el.destroy()}if(A._defs){Ext.get(A._defs).destroy()}if(A.bgRect){Ext.get(A.bgRect).destroy()}if(A.webkitRect){Ext.get(A.webkitRect).destroy()}delete A.el}});
Ext.define("Ext.data.BufferedStore",{extend:"Ext.data.ProxyStore",alias:"store.buffered",requires:["Ext.data.PageMap","Ext.util.Filter","Ext.util.Sorter","Ext.util.Grouper"],uses:["Ext.util.SorterCollection","Ext.util.FilterCollection","Ext.util.GroupCollection"],isBufferedStore:true,buffered:true,config:{data:0,pageSize:25,remoteSort:true,remoteFilter:true,sortOnLoad:false,purgePageCount:5,trailingBufferZone:25,leadingBufferZone:200,defaultViewSize:100,viewSize:0},applyData:function(B){var A=this.data||(this.data=this.createDataCollection());if(B&&B!==true){Ext.Error.raise("Cannot load a buffered store with local data - the store is a map of remote data")}return A},createFiltersCollection:function(){return new Ext.util.FilterCollection()},createSortersCollection:function(){return new Ext.util.SorterCollection()},updateRemoteFilter:function(A){if(A===false){Ext.Error.raise("Buffered stores are always remotely filtered.")}this.callParent(arguments)},updateRemoteSort:function(A){if(A===false){Ext.Error.raise("Buffered stores are always remotely sorted.")}this.callParent(arguments)},updateGroupField:function(A){if(this.isInitializing){this.blockLoad()}this.group(A);if(this.isInitializing){this.unblockLoad()}},getGrouper:function(){return this.grouper},isGrouped:function(){return !!this.grouper},createDataCollection:function(){var B=this,A=new Ext.data.PageMap({store:B,rootProperty:"data",pageSize:B.getPageSize(),maxSize:B.getPurgePageCount(),listeners:{clear:B.onPageMapClear,scope:B}});B.pageRequests={};return A},updateGroupsOnUpdate:function(B,C){var A=this,D=A.getGroupField();if(C&&Ext.Array.contains(C,D)){Ext.Error.raise("Cannot move records between groups in a buffered store record - the store is a map of remote data")}A.callParent(arguments)},add:function(A){Ext.Error.raise("add method may not be called on a buffered store - the store is a map of remote data");this.callParent(arguments)},removeAll:function(C){var B=this,A=B.getData();if(A){if(C){B.suspendEvent("clear")}A.clear();if(C){B.resumeEvent("clear")}}},load:function(B){var A=this;B=B||{};A.getData().clear();B.page=1;B.start=0;B.limit=A.getViewSize()||A.getDefaultViewSize();B.loadCallback=B.callback;delete B.callback;return A.loadToPrefetch(B)},reload:function(G){var I=this,D,H,F,A,E,C,J,K,B=I.getData();if(!G){G={}}delete I.totalCount;B.clear(true);C=function(){if(I.rangeCached(D,H)){I.loading=false;B.un("pageadded",C);K=B.getRange(D,H+1);I.fireEvent("load",I,K,true)}};J=Math.ceil((I.getLeadingBufferZone()+I.getTrailingBufferZone())/2);if(!I.lastRequestStart){D=G.start||0;H=D+(G.count||I.getPageSize())-1}else{D=I.lastRequestStart;H=I.lastRequestEnd}F=I.getPageFromRecordIndex(Math.max(D-J,0));A=I.getPageFromRecordIndex(H+J);if(I.fireEvent("beforeload",I,G)!==false){I.loading=true;B.on("pageadded",C);for(E=F;E<=A;E++){I.prefetchPage(E,G)}}},filter:function(){if(this.remoteSort){this.getData().clear();this.callParent(arguments)}else{Ext.Error.raise("Local filtering may not be used on a buffered store - the store is a map of remote data")}this.callParent(arguments)},clearFilter:function(){this.getData().clear();this.callParent(arguments)},filterBy:function(A,B){Ext.Error.raise("Local filtering may not be used on a buffered store - the store is a map of remote data")},loadData:function(B,A){Ext.Error.raise("LoadData may not be used on a buffered store - the store is a map of remote data")},loadPage:function(C,B){var A=this;B=B||{};B.page=A.currentPage=C;B.start=(C-1)*A.getPageSize();B.limit=A.getViewSize()||A.getDefaultViewSize();B.loadCallback=B.callback;delete B.callback;return A.loadToPrefetch(B)},clearData:function(B){var A=this,C=A.getData();if(C){C.clear()}if(B!==true||A.clearRemovedOnLoad){A.removed.length=0}},doSort:function(){if(this.remoteSort){this.callParent(arguments)}else{Ext.Error.raise("Local sorting may not be used on a buffered store - the store is a map of remote data")}},getRange:function(C,E,H){var A=this,G=A.totalCount-1,J=A.lastRequestStart,B=[],D=A.getData(),F,I,K;H=Ext.apply({prefetchStart:C,prefetchEnd:E},H);E=(E>=A.totalCount)?G:E;I=C===0?0:C-1;K=E===G?E:E+1;A.lastRequestStart=C;A.lastRequestEnd=E;if(A.rangeCached(I,K)){A.onRangeAvailable(H);B=D.getRange(C,E+1)}else{A.fireEvent("cachemiss",A,C,E);F=function(M,L){if(A.rangeCached(I,K)){A.fireEvent("cachefilled",A,C,E);D.un("pageadded",F);A.onRangeAvailable(H)}};D.on("pageadded",F);A.prefetchRange(C,E)}A.primeCache(C,E,C<J?-1:1);return B},getById:function(B){var A=this.data.findBy(function(C){return C.getId()===B});if(!A){Ext.Error.raise("getById called for ID that is not present in local cache")}return A},getByInternalId:function(B){var A;A=this.data.findBy(function(C){return C.internalId===B});return A},indexOf:function(A){return this.getData().indexOf(A)},indexOfId:function(A){return this.indexOf(this.getById(A))},group:function(D,B){var C=this,A;if(D&&typeof D==="string"){A=C.grouper;if(!A){C.grouper=new Ext.util.Grouper({property:D,direction:B||"ASC",root:"data"})}else{if(B===undefined){A.toggle()}else{A.setDirection(B)}}}else{C.grouper=D?C.getSorters().decodeSorter(D,"Ext.util.Grouper"):null}if(C.isLoadBlocked()){return}C.getData().clear();C.loadPage(1,{callback:function(){C.fireEvent("groupchange",C,C.getGrouper())}})},getPageFromRecordIndex:function(A){return Math.floor(A/this.getPageSize())+1},loadToPrefetch:function(J){var M=this,D=J,I=M.getPurgePageCount(),H,F,G,N=J.start,L=J.start+J.limit-1,E=Math.min(L,J.start+(M.getViewSize()||J.limit)-1),B=M.getPageFromRecordIndex(Math.max(N-M.getTrailingBufferZone(),0)),C=M.getPageFromRecordIndex(L+M.getLeadingBufferZone()),A=M.getData(),O=function(){if(M.rangeCached(N,E)){M.loading=false;F=A.getRange(N,E+1);A.un("pageadded",O);if(M.hasListeners.guaranteedrange){M.guaranteeRange(N,E,J.callback,J.scope)}if(J.loadCallback){J.loadCallback.call(J.scope||M,F,K,true)}if(J.callback){J.callback.call(J.scope||M,F,N,L,J)}M.fireEvent("datachanged",M);M.fireEvent("refresh",M);M.fireEvent("load",M,F,true)}},K;if(isNaN(M.pageSize)||!M.pageSize){Ext.Error.raise("Buffered store configured without a pageSize",M)}if(I){A.setMaxSize(I=Math.max(I,C-B+1))}if(M.fireEvent("beforeload",M,J)!==false){delete M.totalCount;M.loading=true;if(J.callback){D=Ext.apply({},J);delete D.callback}M.on("prefetch",function(Q,R,P,S){if(P){K=S;if((G=M.getTotalCount())){A.on("pageadded",O);E=Math.min(E,G-1);C=M.getPageFromRecordIndex(Math.min(E+M.getLeadingBufferZone(),G-1));for(H=B+1;H<=C;++H){M.prefetchPage(H,D)}}else{M.fireEvent("datachanged",M);M.fireEvent("refresh",M);M.fireEvent("load",M,R,true)}}else{M.fireEvent("load",M,R,false)}},null,{single:true});M.prefetchPage(B,D)}},prefetch:function(D){var A=this,B=A.getPageSize(),F=A.getData(),C,E;if(B){if(A.lastPageSize&&B!=A.lastPageSize){Ext.Error.raise("pageSize cannot be dynamically altered")}if(!F.pageSize){F.pageSize=B}}else{A.pageSize=F.pageSize=B=D.limit}A.lastPageSize=B;if(!D.page){D.page=A.getPageFromRecordIndex(D.start);D.start=(D.page-1)*B;D.limit=Math.ceil(D.limit/B)*B}if(!A.pageRequests[D.page]){C=A.proxy;D=Ext.apply({action:"read",filters:A.getFilters().items,sorters:A.getSorters().items,grouper:A.getGrouper(),internalCallback:A.onProxyPrefetch,internalScope:A},D);E=C.createOperation("read",D);E.pageMapGeneration=F.pageMapGeneration;if(A.fireEvent("beforeprefetch",A,E)!==false){A.pageRequests[D.page]=E.execute();if(C.isSynchronous){delete A.pageRequests[D.page]}}}return A},onPageMapClear:function(){var D=this,A=D.wasLoading,E=D.pageRequests,F=D.getData(),B,C;F.clearListeners();F.on("clear",D.onPageMapClear,D);D.loading=true;D.totalCount=0;for(C in E){if(E.hasOwnProperty(C)){B=E[C];delete E[C];delete B.callback}}D.fireEvent("clear",D);D.loading=A},prefetchPage:function(F,D){var A=this,B=A.getPageSize(),E=(F-1)*B,C=A.totalCount;if(C!==undefined&&A.getCount()===C){return}A.prefetch(Ext.applyIf({page:F,start:E,limit:B},D))},onProxyPrefetch:function(F){var E=this,D=F.getResultSet(),C=F.getRecords(),A=F.wasSuccessful(),G=F.getPage(),B=E.totalCount;if(F.pageMapGeneration===E.getData().pageMapGeneration){if(D){E.totalCount=D.getTotal();if(E.totalCount!==B){E.fireEvent("totalcountchange",E.totalCount)}}if(G!==undefined){delete E.pageRequests[G]}E.loading=false;E.fireEvent("prefetch",E,C,A,F);if(A){E.cachePage(C,F.getPage())}Ext.callback(F.getCallback(),F.getScope()||E,[C,F,A])}},cachePage:function(B,E){var C=this,D=B.length,A;if(!Ext.isDefined(C.totalCount)){C.totalCount=B.length;C.fireEvent("totalcountchange",C.totalCount)}for(A=0;A<D;A++){B[A].join(C)}C.getData().addPage(E,B)},rangeCached:function(B,A){return this.getData().hasRange(B,A)},pageCached:function(A){return this.getData().hasPage(A)},pagePending:function(A){return !!this.pageRequests[A]},rangeSatisfied:function(B,A){return this.rangeCached(B,A)},onRangeAvailable:function(C){var A=this,D=A.getTotalCount(),F=C.prefetchStart,E=(C.prefetchEnd>D-1)?D-1:C.prefetchEnd,B;E=Math.max(0,E);if(F>E){Ext.log({level:"warn",msg:"Start ("+F+") was greater than end ("+E+") for the range of records requested ("+F+"-"+C.prefetchEnd+")"+(this.storeId?' from store "'+this.storeId+'"':"")})}B=A.getData().getRange(F,E+1);if(C.fireEvent!==false){A.fireEvent("guaranteedrange",B,F,E,C)}if(C.callback){C.callback.call(C.scope||A,B,F,E,C)}},guaranteeRange:function(E,D,A,B,C){C=Ext.apply({callback:A,scope:B},C);this.getRange(E,D+1,C)},prefetchRange:function(F,E){var D=this,A=D.getPurgePageCount(),G,B,C;if(!D.rangeCached(F,E)){G=D.getPageFromRecordIndex(F);B=D.getPageFromRecordIndex(E);D.getData().setMaxSize(A?(B-G+1)+A:0);for(C=G;C<=B;C++){if(!D.pageCached(C)){D.prefetchPage(C)}}}},primeCache:function(B,C,A){var G=this,D=G.getLeadingBufferZone(),E=G.getTrailingBufferZone(),F=G.getPageSize(),H=G.totalCount;if(A===-1){B=Math.max(B-D,0);C=Math.min(C+E,H-1)}else{if(A===1){B=Math.max(Math.min(B-E,H-F),0);C=Math.min(C+D,H-1)}else{B=Math.min(Math.max(Math.floor(B-((D+E)/2)),0),H-G.pageSize);C=Math.min(Math.max(Math.ceil(C+((D+E)/2)),0),H-1)}}G.prefetchRange(B,C)},sort:function(){this.getData().clear();this.loadPage(1)}});
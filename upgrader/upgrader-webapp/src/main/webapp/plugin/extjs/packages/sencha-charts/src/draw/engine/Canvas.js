Ext.define("Ext.draw.engine.Canvas",{extend:"Ext.draw.Surface",config:{highPrecision:false},requires:["Ext.draw.Animator"],statics:{contextOverrides:{setGradientBBox:function(A){this.bbox=A},fill:function(){var F=this.fillStyle,B=this.fillGradient,A=this.fillOpacity,G="rgba(0, 0, 0, 0)",C="rgba(0, 0, 0, 0.0)",D=this.bbox,E=this.globalAlpha;if(F!==G&&F!==C&&A!==0){if(B&&D){this.fillStyle=B.generateGradient(this,D)}if(A!==1){this.globalAlpha=E*A}this.$fill();if(A!==1){this.globalAlpha=E}if(B&&D){this.fillStyle=F}}},stroke:function(){var C=this.strokeStyle,F=this.strokeGradient,B=this.strokeOpacity,G="rgba(0, 0, 0, 0)",A="rgba(0, 0, 0, 0.0)",D=this.bbox,E=this.globalAlpha;if(C!==G&&C!==A&&B!==0){if(F&&D){this.strokeStyle=F.generateGradient(this,D)}if(B!==1){this.globalAlpha=E*B}this.$stroke();if(B!==1){this.globalAlpha=E}if(F&&D){this.strokeStyle=C}}},fillStroke:function(E,C){var F=this,B=this.fillStyle,D=this.fillOpacity,J=this.strokeStyle,H=this.strokeOpacity,K=F.shadowColor,A=F.shadowBlur,I="rgba(0, 0, 0, 0)",G="rgba(0, 0, 0, 0.0)";if(C===undefined){C=E.transformFillStroke}if(!C){E.inverseMatrix.toContext(F)}if(B!==I&&B!==G&&D!==0){F.fill();F.shadowColor="rgba(0,0,0,0)";F.shadowBlur=0}if(J!==I&&J!==G&&H!==0){F.stroke()}F.shadowColor=K;F.shadowBlur=A},ellipse:function(F,D,I,H,J,A,B,G){var E=Math.cos(J),C=Math.sin(J);this.transform(E*I,C*I,-C*H,E*H,F,D);this.arc(0,0,1,A,B,G);this.transform(E/I,-C/H,C/I,E/H,-(E*F+C*D)/I,(C*F-E*D)/H)},appendPath:function(G){var D=this,A=0,F=0,C=G.types,B=G.coords,E=G.types.length;D.beginPath();for(;A<E;A++){switch(C[A]){case"M":D.moveTo(B[F],B[F+1]);F+=2;break;case"L":D.lineTo(B[F],B[F+1]);F+=2;break;case"C":D.bezierCurveTo(B[F],B[F+1],B[F+2],B[F+3],B[F+4],B[F+5]);F+=6;break;case"Z":D.closePath();break}}}}},splitThreshold:1800,getElementConfig:function(){return{reference:"element",style:{position:"absolute"},children:[{reference:"innerElement",style:{width:"100%",height:"100%",position:"relative"}}]}},createCanvas:function(){var A=Ext.Element.create({tag:"canvas",cls:Ext.baseCSSPrefix+"surface-canvas"});window["G_vmlCanvasManager"]&&G_vmlCanvasManager.initElement(A.dom);var D=Ext.draw.engine.Canvas.contextOverrides,C=A.dom.getContext("2d"),E=C.webkitBackingStorePixelRatio||C.mozBackingStorePixelRatio||C.msBackingStorePixelRatio||C.oBackingStorePixelRatio||C.backingStorePixelRatio||1,B;this.devicePixelRatio/=(Ext.os.is.WindowsPhone)?window.innerWidth/window.screen.width:E;if(C.ellipse){delete D.ellipse}for(B in D){C["$"+B]=C[B]}Ext.apply(C,D);if(this.getHighPrecision()){this.enablePrecisionCompensation(C)}else{this.disablePrecisionCompensation(C)}this.innerElement.appendChild(A);this.canvases.push(A);this.contexts.push(C)},initElement:function(){this.callParent();this.canvases=[];this.contexts=[];this.activeCanvases=0},afterCachedConfig:function(){this.callParent();this.createCanvas()},updateHighPrecision:function(E){var D=this.contexts,C=D.length,B,A;for(B=0;B<C;B++){A=D[B];if(E){this.enablePrecisionCompensation(A)}else{this.disablePrecisionCompensation(A)}}},precisionMethods:{rect:false,fillRect:false,strokeRect:false,clearRect:false,moveTo:false,lineTo:false,arc:false,arcTo:false,save:false,restore:false,updatePrecisionCompensate:false,setTransform:false,transform:false,scale:false,translate:false,rotate:false,quadraticCurveTo:false,bezierCurveTo:false,createLinearGradient:false,createRadialGradient:false,fillText:false,strokeText:false,drawImage:false},disablePrecisionCompensation:function(C){var A=this.precisionMethods,B;for(B in A){delete C[B]}this.setDirty(true)},enablePrecisionCompensation:function(H){var D=this,E=1,C=1,I=0,G=0,A=new Ext.draw.Matrix(),F=[],B={},J=H.constructor.prototype;var K={rect:function(M,N,O,L){return J.rect.call(this,M*E+I,N*C+G,O*E,L*C)},fillRect:function(M,N,O,L){this.updatePrecisionCompensateRect();J.fillRect.call(this,M*E+I,N*C+G,O*E,L*C);this.updatePrecisionCompensate()},strokeRect:function(M,N,O,L){this.updatePrecisionCompensateRect();J.strokeRect.call(this,M*E+I,N*C+G,O*E,L*C);this.updatePrecisionCompensate()},clearRect:function(M,N,O,L){return J.clearRect.call(this,M*E+I,N*C+G,O*E,L*C)},moveTo:function(L,M){return J.moveTo.call(this,L*E+I,M*C+G)},lineTo:function(L,M){return J.lineTo.call(this,L*E+I,M*C+G)},arc:function(O,P,Q,N,M,L){this.updatePrecisionCompensateRect();J.arc.call(this,O*E+I,P*E+G,Q*E,N,M,L);this.updatePrecisionCompensate()},arcTo:function(O,P,L,M,N){this.updatePrecisionCompensateRect();J.arcTo.call(this,O*E+I,P*C+G,L*E+I,M*C+G,N*E);this.updatePrecisionCompensate()},save:function(){F.push(A);A=A.clone();return J.save.call(this)},restore:function(){A=F.pop();J.restore.call(this);this.updatePrecisionCompensate()},updatePrecisionCompensate:function(){A.precisionCompensate(D.devicePixelRatio,B);E=B.xx;C=B.yy;I=B.dx;G=B.dy;return J.setTransform.call(this,D.devicePixelRatio,B.b,B.c,B.d,0,0)},updatePrecisionCompensateRect:function(){A.precisionCompensateRect(D.devicePixelRatio,B);E=B.xx;C=B.yy;I=B.dx;G=B.dy;return J.setTransform.call(this,D.devicePixelRatio,B.b,B.c,B.d,0,0)},setTransform:function(L,M,N,Q,P,O){A.set(L,M,N,Q,P,O);this.updatePrecisionCompensate()},transform:function(L,M,N,Q,P,O){A.append(L,M,N,Q,P,O);this.updatePrecisionCompensate()},scale:function(L,M){return this.transform(L,0,0,M,0,0)},translate:function(L,M){return this.transform(1,0,0,1,L,M)},rotate:function(N){var M=Math.cos(N),L=Math.sin(N);return this.transform(M,L,-L,M,0,0)},quadraticCurveTo:function(O,L,M,N){return J.quadraticCurveTo.call(this,O*E+I,L*C+G,M*E+I,N*C+G)},bezierCurveTo:function(Q,P,M,L,N,O){return J.bezierCurveTo.call(this,Q*E+I,P*C+G,M*E+I,L*C+G,N*E+I,O*C+G)},createLinearGradient:function(M,N,O,P){this.updatePrecisionCompensateRect();var L=J.createLinearGradient.call(this,M*E+I,N*C+G,O*E+I,P*C+G);this.updatePrecisionCompensate();return L},createRadialGradient:function(O,P,M,Q,R,N){this.updatePrecisionCompensateRect();var L=J.createLinearGradient.call(this,O*E+I,P*E+G,M*E,Q*E+I,R*E+G,N*E);this.updatePrecisionCompensate();return L},fillText:function(M,N,O,L){J.setTransform.apply(this,A.elements);if(typeof L==="undefined"){J.fillText.call(this,M,N,O)}else{J.fillText.call(this,M,N,O,L)}this.updatePrecisionCompensate()},strokeText:function(M,N,O,L){J.setTransform.apply(this,A.elements);if(typeof L==="undefined"){J.strokeText.call(this,M,N,O)}else{J.strokeText.call(this,M,N,O,L)}this.updatePrecisionCompensate()},fill:function(){this.updatePrecisionCompensateRect();J.fill.call(this);this.updatePrecisionCompensate()},stroke:function(){this.updatePrecisionCompensateRect();J.stroke.call(this);this.updatePrecisionCompensate()},drawImage:function(R,Q,P,M,L,S,T,O,N){switch(arguments.length){case 3:return J.drawImage.call(this,R,Q*E+I,P*C+G);case 5:return J.drawImage.call(this,R,Q*E+I,P*C+G,M*E,L*C);case 9:return J.drawImage.call(this,R,Q,P,M,L,S*E+I,T*C*G,O*E,N*C)}}};Ext.apply(H,K);this.setDirty(true)},updateRect:function(C){this.callParent([C]);var A=this,K=Math.floor(C[0]),E=Math.floor(C[1]),G=Math.ceil(C[0]+C[2]),L=Math.ceil(C[1]+C[3]),B=A.devicePixelRatio,D=G-K,H=L-E,M=Math.round(A.splitThreshold/B),O=Math.ceil(D/M),P=A.activeCanvases,I,J,N,F;for(I=0,J=0;I<O;I++,J+=M){if(I>=A.canvases.length){A.createCanvas()}N=A.canvases[I].dom;N.style.left=J+"px";if(H*B!==N.height){N.height=H*B;N.style.height=H+"px"}F=Math.min(M,D-J);if(F*B!==N.width){N.width=F*B;N.style.width=F+"px"}A.applyDefaults(A.contexts[I])}for(;I<P;I++){N=A.canvases[I].dom;N.width=0;N.height=0}A.activeCanvases=O;A.clear()},clearTransform:function(){var B=this,C=B.activeCanvases,A,D;for(A=0;A<C;A++){D=B.contexts[A];D.translate(-B.splitThreshold*A,0);D.scale(B.devicePixelRatio,B.devicePixelRatio);B.matrix.toContext(D)}},renderSprite:function(B){var M=this,D=M.getRect(),L=M.matrix,O=B._parent,I=Ext.draw.Matrix.fly([1,0,0,1,0,0]),N,K,J,A,E,H=0,G,C=D[2],P;while(O&&(O!==M)){I.prependMatrix(O.matrix||O.attr&&O.attr.matrix);O=O.getParent()}I.prependMatrix(L);N=B.getBBox();if(N){N=I.transformBBox(N)}B.preRender(M);if(B.attr.hidden||B.attr.globalAlpha===0){B.setDirty(false);return}G=0;P=G+D[3];for(K=0,J=0;K<M.activeCanvases;K++,J+=M.splitThreshold/M.devicePixelRatio){A=M.contexts[K];E=Math.min(D[2]-J,M.splitThreshold/M.devicePixelRatio);H=J;C=H+E;if(N){if(N.x>C||N.x+N.width<H||N.y>P||N.y+N.height<G){continue}}try{A.save();B.useAttributes(A,D);if(false===B.render(M,A,[H,G,E,P-G],D)){return false}}catch(F){Ext.log.error(this.$className+": Unhandled Exception: ",F.description||F.message);throw F}finally{A.restore()}}B.setDirty(false)},flatten:function(E,A){var B=document.createElement("canvas"),I=Ext.getClassName(this),H=this.devicePixelRatio,F=B.getContext("2d"),D,C,G;B.width=Math.ceil(E.width*H);B.height=Math.ceil(E.height*H);for(G=0;G<A.length;G++){D=A[G];if(Ext.getClassName(D)!==I){continue}C=D.getRect();F.drawImage(D.canvases[0].dom,C[0]*H,C[1]*H)}return{data:B.toDataURL(),type:"png"}},applyDefaults:function(A){A.strokeStyle="rgba(0,0,0,0)";A.fillStyle="rgba(0,0,0,0)";A.textAlign="start";A.textBaseline="top";A.miterLimit=1},clear:function(){var C=this,D=this.activeCanvases,B,A,E;for(B=0;B<D;B++){A=C.canvases[B].dom;E=C.contexts[B];E.setTransform(1,0,0,1,0,0);E.clearRect(0,0,A.width,A.height)}C.setDirty(true)},destroy:function(){var B=this,A,C=B.canvases.length;for(A=0;A<C;A++){B.contexts[A]=null;B.canvases[A].destroy();B.canvases[A]=null}delete B.contexts;delete B.canvases;B.callParent(arguments)}},function(){if(Ext.os.is.Android4&&Ext.browser.is.Chrome){this.prototype.splitThreshold=3000}else{if(Ext.os.is.Android){this.prototype.splitThreshold=10000000000}}});
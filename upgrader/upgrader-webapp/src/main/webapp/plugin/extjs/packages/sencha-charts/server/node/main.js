var http=require("http");var qs=require("querystring");var fs=require("fs");var spawn=require("child_process").spawn;var helpers=require("./helpers.js");var v1=require("./converters/v1.js");var v2=require("./converters/v2.js");var MAX_FILE_SIZE=5*1024*1024;var TMP_DIR_NAME=process.cwd()+"/tmp/";var SCRIPT=fs.readFileSync("./save_script_tpl.js",{encoding:"utf8"});if(!fs.existsSync(TMP_DIR_NAME)){fs.mkdirSync(TMP_DIR_NAME)}var defaultHeaders={"Content-Type":"text/plain","Access-Control-Allow-Origin":"*"};function respond(C,B,D,A){A=helpers.apply({},A,defaultHeaders);C.writeHead(B,A);C.end(D)}var counter=(function(){var A=0,B=Math.pow(2,32)-1;return function(){if(A>B){A=0}return A++}})();http.createServer(function(B,C){if(B.method==="POST"){var A="";B.on("data",function(D){if(A.length<=MAX_FILE_SIZE){A+=D}else{respond(C,413,"Request entity too large.")}});B.on("end",function(){try{var F=qs.parse(A)}catch(D){console.error("Parsing request data failed.",D)}if(F){switch(F.version){case"2":F=v2.convert(F);break;default:F=v1.convert(F);break}}if(!F||!F.data){respond(C,400,"Bad request.");return}var G=(F.filename||"chart")+"."+F.format;var E=TMP_DIR_NAME+counter().toString()+"."+F.format;var H=TMP_DIR_NAME+counter().toString()+".js";var I=helpers.interpolate(SCRIPT,helpers.apply(F,{filename:E}));fs.writeFile(H,I,{encoding:"utf8"},function(K){if(K){throw K}var J=spawn("phantomjs",[H]);J.stdout.pipe(process.stdout);J.on("exit",function(L){fs.unlink(H,function(){if(K){throw K}console.log("Successfully deleted:",H)});if(!L){fs.readFile(E,function(M,N){if(M){throw M}respond(C,200,N,{"Content-Type":F.contentType,"Content-Disposition":"attachment; filename="+G});fs.unlink(E,function(){if(M){throw M}console.log("Successfully deleted:",E)})})}else{respond(C,500,"Internal server error.\nphantomjs exited with code "+L)}})})})}else{respond(C,400,"Bad request.")}}).listen(1337,"0.0.0.0");
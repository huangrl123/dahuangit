Ext.define("Ext.data.Connection",{mixins:{observable:"Ext.mixin.Observable"},requires:["Ext.data.flash.BinaryXhr"],statics:{requestId:0},config:{url:null,async:true,username:"",password:"",disableCaching:true,withCredentials:false,binary:false,cors:false,isXdr:false,defaultXdrContentType:"text/plain",disableCachingParam:"_dc",timeout:30000,extraParams:null,autoAbort:false,method:null,defaultHeaders:null,defaultPostHeader:"application/x-www-form-urlencoded; charset=UTF-8",useDefaultXhrHeader:true,defaultXhrHeader:"XMLHttpRequest"},constructor:function(A){this.mixins.observable.constructor.call(this,A);this.requests={}},request:function(F){F=F||{};var H=this,C=F.scope||window,G=F.username||H.getUsername(),D=F.password||H.getPassword()||"",A,J,E,I,K,B;if(H.fireEvent("beforerequest",H,F)!==false){J=H.setOptions(F,C);if(H.isFormUpload(F)){H.upload(F.form,J.url,J.data,F);return null}if(F.autoAbort||H.getAutoAbort()){H.abort()}A=F.async!==false?(F.async||H.getAsync()):false;B=H.openRequest(F,J,A,G,D);K=H.getIsXdr();if(!K){I=H.setupHeaders(B,F,J.data,J.params)}E={id:++Ext.data.Connection.requestId,xhr:B,headers:I,options:F,async:A,binary:F.binary||H.getBinary(),timeout:setTimeout(function(){E.timedout=true;H.abort(E)},F.timeout||H.getTimeout())};H.requests[E.id]=E;H.latestId=E.id;if(A){if(!K){B.onreadystatechange=Ext.Function.bind(H.onStateChange,H,[E])}}if(K){H.processXdrRequest(E,B)}B.send(J.data);if(!A){return H.onComplete(E)}return E}else{Ext.callback(F.callback,F.scope,[F,undefined,undefined]);return null}},processXdrRequest:function(A,C){var B=this;delete A.headers;A.contentType=A.options.contentType||B.getDefaultXdrContentType();C.onload=Ext.Function.bind(B.onStateChange,B,[A,true]);C.onerror=C.ontimeout=Ext.Function.bind(B.onStateChange,B,[A,false])},processXdrResponse:function(B,A){B.getAllResponseHeaders=function(){return[]};B.getResponseHeader=function(){return""};B.contentType=A.contentType||this.getDefaultXdrContentType()},upload:function(N,A,J,M){N=Ext.getDom(N);M=M||{};var L=Ext.id(),C=document.createElement("iframe"),G=[],H="multipart/form-data",I={target:N.target,method:N.method,encoding:N.encoding,enctype:N.enctype,action:N.action},P=function(S,T){E=document.createElement("input");Ext.fly(E).set({type:"hidden",value:T,name:S});N.appendChild(E);G.push(E)},E,F,Q,R,K,B,O,D;Ext.fly(C).set({id:L,name:L,cls:Ext.baseCSSPrefix+"hidden-display",src:Ext.SSL_SECURE_URL});document.body.appendChild(C);if(document.frames){document.frames[L].name=L}Ext.fly(N).set({target:L,method:"POST",enctype:H,encoding:H,action:A||I.action});if(J){F=Ext.Object.fromQueryString(J)||{};for(R in F){if(F.hasOwnProperty(R)){Q=F[R];if(Ext.isArray(Q)){K=Q.length;for(B=0;B<K;B++){P(R,Q[B])}}else{P(R,Q)}}}}Ext.get(C).on({load:Ext.Function.bind(this.onUploadComplete,this,[C,M]),single:!Ext.isOpera});N.submit();Ext.fly(N).set(I);for(O=G.length,D=0;D<O;D++){Ext.removeNode(G[D])}},onUploadComplete:function(D,E){var G=this,I={responseText:"",responseXML:null},C,B,F,H;try{F=(D&&(D.contentWindow.document||D.contentDocument))||(window.frames[D.id]||{}).document;if(F){if(Ext.isOpera&&F.location==Ext.SSL_SECURE_URL){return}if(F.body){if((H=F.body.firstChild)&&/pre/i.test(H.tagName)){I.responseText=H.textContent||H.innerText}else{if((H=F.getElementsByTagName("textarea")[0])){I.responseText=H.value}else{I.responseText=F.body.textContent||F.body.innerText}}}I.responseXML=F.XMLDocument||F;C=E.success;B=true}else{Ext.Error.raise("Could not acquire a suitable connection for the file upload service.")}}catch(A){I.responseText='{success:false,message:"'+Ext.String.trim(A.message||A.description)+'"}';C=E.failure;B=false}G.fireEvent(B?"requestcomplete":"requestexception",G,I,E);Ext.callback(C,E.scope,[I,E]);Ext.callback(E.callback,E.scope,[E,B,I]);Ext.defer(Ext.removeNode,100,Ext,[D])},isFormUpload:function(B){var A=this.getForm(B);if(A){return(B.isUpload||(/multipart\/form-data/i).test(A.getAttribute("enctype")))}return false},getForm:function(B){var A=B.form||null;if(A){A=Ext.getDom(A)}return A},setOptions:function(F,C){var H=this,E=F.params||{},B=H.getExtraParams(),J=F.urlParams,I=F.url||H.getUrl(),K=F.jsonData,G,D,A;if(Ext.isFunction(E)){E=E.call(C,F)}if(Ext.isFunction(I)){I=I.call(C,F)}I=this.setupUrl(F,I);if(!I){Ext.Error.raise({options:F,msg:"No URL specified"})}A=F.rawData||F.binaryData||F.xmlData||K||null;if(K&&!Ext.isPrimitive(K)){A=Ext.encode(A)}if(F.binaryData){if(!Ext.isArray(F.binaryData)){Ext.log.warn("Binary submission data must be an array of byte values! Instead got "+typeof(F.binaryData))}if(H.nativeBinaryPostSupport()){A=(new Uint8Array(F.binaryData));if((Ext.isChrome&&Ext.chromeVersion<22)||Ext.isSafari||Ext.isGecko){A=A.buffer}}}if(Ext.isObject(E)){E=Ext.Object.toQueryString(E)}if(Ext.isObject(B)){B=Ext.Object.toQueryString(B)}E=E+((B)?((E)?"&":"")+B:"");J=Ext.isObject(J)?Ext.Object.toQueryString(J):J;E=this.setupParams(F,E);G=(F.method||H.getMethod()||((E||A)?"POST":"GET")).toUpperCase();this.setupMethod(F,G);D=F.disableCaching!==false?(F.disableCaching||H.getDisableCaching()):false;if(G==="GET"&&D){I=Ext.urlAppend(I,(F.disableCachingParam||H.getDisableCachingParam())+"="+(new Date().getTime()))}if((G=="GET"||A)&&E){I=Ext.urlAppend(I,E);E=null}if(J){I=Ext.urlAppend(I,J)}return{url:I,method:G,data:A||E||null}},setupUrl:function(C,A){var B=this.getForm(C);if(B){A=A||B.action}return A},setupParams:function(C,D){var B=this.getForm(C),A;if(B&&!this.isFormUpload(C)){A=Ext.Element.serializeForm(B);D=D?(D+"&"+A):A}return D},setupMethod:function(A,B){if(this.isFormUpload(A)){return"POST"}return B},setupHeaders:function(B,G,D,F){var I=this,J=Ext.apply({},G.headers||{},I.getDefaultHeaders()||{}),M=I.getDefaultPostHeader(),L=G.jsonData,H=G.xmlData,K="Content-Type",E,A;if(!J.hasOwnProperty(K)&&(D||F)){if(D){if(G.rawData){M="text/plain"}else{if(H&&Ext.isDefined(H)){M="text/xml"}else{if(L&&Ext.isDefined(L)){M="application/json"}}}}J[K]=M}if(I.getUseDefaultXhrHeader()&&!J["X-Requested-With"]){J["X-Requested-With"]=I.getDefaultXhrHeader()}if(J[K]===undefined||J[K]===null){delete J[K]}try{for(E in J){if(J.hasOwnProperty(E)){A=J[E];B.setRequestHeader(E,A)}}}catch(C){I.fireEvent("exception",E,A)}return J},newRequest:function(B){var A=this,C;if(B.binaryData){if(A.nativeBinaryPostSupport()){C=A.getXhrInstance()}else{C=new Ext.data.flash.BinaryXhr()}}else{if((B.cors||A.getCors())&&Ext.isIE&&Ext.ieVersion<=9){C=A.getXdrInstance();A.setIsXdr(true)}else{C=A.getXhrInstance()}}return C},openRequest:function(D,C,G,B,A){var F=this,E=F.newRequest(D);if(B){E.open(C.method,C.url,G,B,A)}else{if(F.getIsXdr()){E.open(C.method,C.url)}else{E.open(C.method,C.url,G)}}if(D.binary||F.getBinary()){if(window.Uint8Array){E.responseType="arraybuffer"}else{if(E.overrideMimeType){E.overrideMimeType("text/plain; charset=x-user-defined")}else{if(!Ext.isIE){Ext.log.warn("Your browser does not support loading binary data using Ajax.")}}}}if(D.withCredentials||F.getWithCredentials()){E.withCredentials=true}return E},getXdrInstance:function(){var A;if(Ext.ieVersion>=8){A=new XDomainRequest()}else{Ext.Error.raise({msg:"Your browser does not support CORS"})}return A},getXhrInstance:(function(){var C=[function(){return new XMLHttpRequest()},function(){return new ActiveXObject("MSXML2.XMLHTTP.3.0")},function(){return new ActiveXObject("MSXML2.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}],A=0,D=C.length,E;for(;A<D;++A){try{E=C[A];E();break}catch(B){}}return E}()),isLoading:function(B){if(!B){B=this.getLatest()}if(!(B&&B.xhr)){return false}var C=B.xhr.readyState,A=Ext.data.flash&&Ext.data.flash.BinaryXhr;return((B.xhr instanceof A)&&C!=4)||!(C===0||C==4)},abort:function(B){var C=this,D;if(!B){B=C.getLatest()}if(B&&C.isLoading(B)){D=B.xhr;try{D.onreadystatechange=null}catch(A){D.onreadystatechange=Ext.emptyFn}D.abort();C.clearTimeout(B);if(!B.timedout){B.aborted=true}C.onComplete(B);C.cleanup(B)}},abortAll:function(){var A=this.requests,B;for(B in A){if(A.hasOwnProperty(B)){this.abort(A[B])}}},getLatest:function(){var B=this.latestId,A;if(B){A=this.requests[B]}return A||null},onStateChange:function(B,D){var C=this,A=Ext.GlobalEvents;if((B.xhr&&B.xhr.readyState==4)||C.isXdr){C.clearTimeout(B);C.onComplete(B,D);C.cleanup(B);if(A.hasListeners.idle){A.fireEvent("idle")}}},clearTimeout:function(A){clearTimeout(A.timeout);delete A.timeout},cleanup:function(A){A.xhr=null;delete A.xhr},onComplete:function(C,E){var H=this,F=C.options,D,B,G,I;try{D=C.xhr;B=H.parseStatus(D.status);if(B.success){B.success=D.readyState===4}}catch(A){B={success:false,isException:false}}G=H.isXdr?E:B.success;if(G){I=H.createResponse(C);H.fireEvent("requestcomplete",H,I,F);Ext.callback(F.success,F.scope,[I,F])}else{if(B.isException||C.aborted||C.timedout){I=H.createException(C)}else{I=H.createResponse(C)}H.fireEvent("requestexception",H,I,F);Ext.callback(F.failure,F.scope,[I,F])}Ext.callback(F.callback,F.scope,[F,G,I]);delete H.requests[C.id];return I},parseStatus:function(B){B=B==1223?204:B;var A=(B>=200&&B<300)||B==304,C=false;if(!A){switch(B){case 12002:case 12029:case 12030:case 12031:case 12152:case 13030:C=true;break}}return{success:A,isException:C}},createResponse:function(F){var H=this,D=F.xhr,B=H.getIsXdr(),I={},E=B?[]:D.getAllResponseHeaders().replace(/\r\n/g,"\n").split("\n"),C=E.length,K,J,G,L,A;while(C--){K=E[C];J=K.indexOf(":");if(J>=0){G=K.substr(0,J).toLowerCase();if(K.charAt(J+1)==" "){++J}I[G]=K.substr(J+1)}}F.xhr=null;delete F.xhr;L={request:F,requestId:F.id,status:D.status,statusText:D.statusText,getResponseHeader:function(M){return I[M.toLowerCase()]},getAllResponseHeaders:function(){return I}};if(B){H.processXdrResponse(L,D)}if(F.binary){L.responseBytes=H.getByteArray(D)}else{L.responseText=D.responseText;L.responseXML=D.responseXML}D=null;return L},createException:function(A){return{request:A,requestId:A.id,status:A.aborted?-1:0,statusText:A.aborted?"transaction aborted":"communication failure",aborted:A.aborted,timedout:A.timedout}},getByteArray:function(C){var I=C.response,D=C.responseBody,H=Ext.data.flash&&Ext.data.flash.BinaryXhr,B,F,G,E;if(C instanceof H){B=C.responseBytes}else{if(window.Uint8Array){B=I?new Uint8Array(I):[]}else{if(Ext.isIE9p){try{B=new VBArray(D).toArray()}catch(A){B=[]}}else{if(Ext.isIE){if(!this.self.vbScriptInjected){this.injectVBScript()}getIEByteArray(C.responseBody,B=[])}else{B=[];F=C.responseText;G=F.length;for(E=0;E<G;E++){B.push(F.charCodeAt(E)&255)}}}}}return B},injectVBScript:function(){var A=document.createElement("script");A.type="text/vbscript";A.text=["Function getIEByteArray(byteArray, out)","Dim len, i","len = LenB(byteArray)","For i = 1 to len","out.push(AscB(MidB(byteArray, i, 1)))","Next","End Function"].join("\n");Ext.getHead().dom.appendChild(A);this.self.vbScriptInjected=true},nativeBinaryPostSupport:function(){return Ext.isChrome||(Ext.isSafari&&Ext.isDefined(window.Uint8Array))||(Ext.isGecko&&Ext.isDefined(window.Uint8Array))}});
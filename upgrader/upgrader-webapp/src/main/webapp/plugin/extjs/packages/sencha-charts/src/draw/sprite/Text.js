Ext.define("Ext.draw.sprite.Text",{extend:"Ext.draw.sprite.Sprite",requires:["Ext.draw.TextMeasurer"],alias:"sprite.text",type:"text",lineBreakRe:/\n/g,statics:{debug:false},inheritableStatics:{shortHand1Re:/'(.*)'/g,shortHand2Re:/ /g,shortHand3Re:/\s*,\s*/g,shortHand4Re:/\$\$\$\$/g,def:{processors:{x:"number",y:"number",text:"string",fontSize:function(A){if(!isNaN(A)){return +A+"px"}else{if(A.match(Ext.dom.Element.unitRe)){return A}}},fontStyle:"enums(,italic,oblique)",fontVariant:"enums(,small-caps)",fontWeight:(function(A){return function(B){if(!B){return""}else{if(B==="normal"){return""}else{if(!isNaN(B)){B=+B;if(100<=B&&B<=900){return B}}else{if(B in A){return B}}}}}})({normal:true,bold:true,bolder:true,lighter:true}),fontFamily:"string",textAlign:(function(A){return function(B){if(!B){return"center"}else{return A[B]}}})({start:"start",left:"start",center:"center",middle:"center",end:"end",right:"end"}),textBaseline:(function(A){return function(B){if(B===false){return"alphabetic"}else{if(B in A){return B}else{if(B==="center"){return"middle"}}}}})({top:true,hanging:true,middle:true,alphabetic:true,ideographic:true,bottom:true}),font:"string",debug:"default"},aliases:{"font-size":"fontSize","font-family":"fontFamily","font-weight":"fontWeight","font-variant":"fontVariant","text-anchor":"textAlign"},defaults:{fontStyle:"",fontVariant:"",fontWeight:"",fontSize:"10px",fontFamily:"sans-serif",font:"10px sans-serif",textBaseline:"alphabetic",textAlign:"start",strokeStyle:"rgba(0, 0, 0, 0)",divBased:true,fillStyle:"#000",x:0,y:0,text:""},dirtyTriggers:{fontStyle:"font,bbox",fontVariant:"font,bbox",fontWeight:"font,bbox",fontSize:"font,bbox",fontFamily:"font,bbox",font:"font-short-hand,bbox,canvas",textBaseline:"bbox",textAlign:"bbox",x:"bbox",y:"bbox",text:"bbox"},updaters:{"font-short-hand":(function(A){return function(D){var F=D.font,B,E,C,G,H;F=F.replace(Ext.draw.sprite.Text.shortHand1Re,function(J,I){return I.replace(Ext.draw.sprite.Text.shortHand2Re,"$$$$")});F=F.replace(Ext.draw.sprite.Text.shortHand3Re,",");B=F.split(" ");D={};for(C=0,G=B.length;C<G;C++){E=B[C];H=A[E];if(H){D[H]=E}else{if(E.match(Ext.dom.Element.unitRe)){D.fontSize=E}else{D.fontFamily=E.replace(Ext.draw.sprite.Text.shortHand4Re," ")}}}this.setAttributes(D,true)}})({"italic":"fontStyle","oblique":"fontStyle","bold":"fontWeight","bolder":"fontWeight","lighter":"fontWeight","100":"fontWeight","200":"fontWeight","300":"fontWeight","400":"fontWeight","500":"fontWeight","600":"fontWeight","700":"fontWeight","800":"fontWeight","900":"fontWeight","small-caps":"fontVariant"}),font:function(A){var B="";if(A.fontWeight){B+=A.fontWeight+" "}if(A.fontVariant){B+=A.fontVariant+" "}if(A.fontSize){B+=A.fontSize+" "}if(A.fontFamily){B+=A.fontFamily+" "}this.setAttributes({font:B.substr(0,B.length-1)},true)}}}},constructor:function(A){Ext.draw.sprite.Sprite.prototype.constructor.call(this,A)},getBBox:function(A){var B=this,C=B.attr.bbox.plain,D=B.getSurface();if(!D){Ext.Error.raise("The sprite does not belong to a surface.")}if(C.dirty){B.updatePlainBBox(C);C.dirty=false}if(D.getInherited().rtl&&D.getFlipRtlText()){B.updatePlainBBox(C,true)}return B.callParent([A])},rtlAlignments:{start:"end",center:"center",end:"start"},updatePlainBBox:function(P,D){var G=this,F=G.attr,T=F.x,U=F.y,K=[],I=F.font,L=F.text,V=F.textBaseline,M=F.textAlign,E=(D&&G.oldSize)?G.oldSize:(G.oldSize=Ext.draw.TextMeasurer.measureText(L,I)),O=G.getSurface(),C=O.getInherited().rtl,S=C&&O.getFlipRtlText(),J=O.getRect(),A=E.sizes,N=E.height,Q=E.width,R=A?A.length:0,H,B=0;switch(V){case"hanging":case"top":break;case"ideographic":case"bottom":U-=N;break;case"alphabetic":U-=N*0.8;break;case"middle":case"center":U-=N*0.5;break}if(S){T=J[2]-J[0]-T;M=G.rtlAlignments[M]}switch(M){case"start":if(C){for(;B<R;B++){H=A[B].width;K.push(-(Q-H))}}break;case"end":T-=Q;if(C){break}for(;B<R;B++){H=A[B].width;K.push(Q-H)}break;case"center":T-=Q*0.5;for(;B<R;B++){H=A[B].width;K.push((C?-1:1)*(Q-H)*0.5)}break}F.textAlignOffsets=K;P.x=T;P.y=U;P.width=Q;P.height=N},setText:function(A){this.setAttributes({text:A},true)},setElementStyles:function(D,B){var E=D.stylesCache||(D.stylesCache={}),A=D.dom.style,C;for(C in B){if(E[C]!==B[C]){E[C]=A[C]=B[C]}}},renderBBox:function(C,B){var A=this.getBBox(true);B.beginPath();B.moveTo(A.x,A.y);B.lineTo(A.x+A.width,A.y);B.lineTo(A.x+A.width,A.y+A.height);B.lineTo(A.x,A.y+A.height);B.closePath();B.strokeStyle="red";B.strokeOpacity=1;B.lineWidth=0.5;B.stroke()},render:function(F,G,B){var A=this,E=A.attr,J=Ext.draw.Matrix.fly(E.matrix.elements.slice(0)),M=A.getBBox(true),H=E.textAlignOffsets,K,L,I,D,C;if(E.text.length===0){return}D=E.text.split("\n");C=M.height/D.length;K=E.bbox.plain.x;L=E.bbox.plain.y;J.toContext(G);if(F.getInherited().rtl){K+=E.bbox.plain.width}for(I=0;I<D.length;I++){if(G.fillStyle!=="rgba(0, 0, 0, 0)"){G.fillText(D[I],K+(H[I]||0),L+C*I)}if(G.strokeStyle!=="rgba(0, 0, 0, 0)"){G.strokeText(D[I],K+(H[I]||0),L+C*I)}}var N=A.statics().debug||E.debug;if(N){N.bbox&&A.renderBBox(F,G)}}});
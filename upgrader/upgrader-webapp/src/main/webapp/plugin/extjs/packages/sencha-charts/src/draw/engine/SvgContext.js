Ext.define("Ext.draw.engine.SvgContext",{toSave:["strokeOpacity","strokeStyle","fillOpacity","fillStyle","globalAlpha","lineWidth","lineCap","lineJoin","lineDash","lineDashOffset","miterLimit","shadowOffsetX","shadowOffsetY","shadowBlur","shadowColor","globalCompositeOperation","position"],"strokeOpacity":1,"strokeStyle":"none","fillOpacity":1,"fillStyle":"none","lineDash":[],"lineDashOffset":0,"globalAlpha":1,"lineWidth":1,"lineCap":"butt","lineJoin":"miter","miterLimit":10,"shadowOffsetX":0,"shadowOffsetY":0,"shadowBlur":0,"shadowColor":"none","globalCompositeOperation":"src",urlStringRe:/^url\(#([\w\-]+)\)$/,constructor:function(A){this.surface=A;this.status=[];this.matrix=new Ext.draw.Matrix();this.path=null;this.clear()},clear:function(){this.group=this.surface.mainGroup;this.position=0;this.path=null},getElement:function(A){return this.surface.getSvgElement(this.group,A,this.position++)},removeElement:function(A){var A=Ext.fly(A),B,G,H,F,D,C,E;if(!A){return}if(A.dom.tagName==="g"){D=A.dom.gradients;for(E in D){D[E].destroy()}}else{B=A.getAttribute("fill");G=A.getAttribute("stroke");H=B&&B.match(this.urlStringRe);F=G&&G.match(this.urlStringRe);if(H&&H[1]){C=Ext.fly(H[1]);if(C){C.destroy()}}if(F&&F[1]){C=Ext.fly(F[1]);if(C){C.destroy()}}}A.destroy()},save:function(){var B=this.toSave,C={},E=this.getElement("g"),A,D;for(D=0;D<B.length;D++){A=B[D];if(A in this){C[A]=this[A]}}this.position=0;C.matrix=this.matrix.clone();this.status.push(C);this.group=E;return E},restore:function(){var B=this.toSave,C=this.status.pop(),E=this.group.dom.childNodes,A,D;while(E.length>this.position){this.removeElement(E[E.length-1])}for(D=0;D<B.length;D++){A=B[D];if(A in C){this[A]=C[A]}else{delete this[A]}}this.setTransform.apply(this,C.matrix.elements);this.group=this.group.getParent()},transform:function(F,G,A,B,C,D){if(this.path){var E=Ext.draw.Matrix.fly([F,G,A,B,C,D]).inverse();this.path.transform(E)}this.matrix.append(F,G,A,B,C,D)},setTransform:function(E,F,A,B,C,D){if(this.path){this.path.transform(this.matrix)}this.matrix.reset();this.transform(E,F,A,B,C,D)},scale:function(A,B){this.transform(A,0,0,B,0,0)},rotate:function(E){var D=Math.cos(E),C=Math.sin(E),A=-Math.sin(E),B=Math.cos(E);this.transform(D,C,A,B,0,0)},translate:function(A,B){this.transform(1,0,0,1,A,B)},setGradientBBox:function(A){this.bbox=A},beginPath:function(){this.path=new Ext.draw.Path()},moveTo:function(A,B){if(!this.path){this.beginPath()}this.path.moveTo(A,B);this.path.element=null},lineTo:function(A,B){if(!this.path){this.beginPath()}this.path.lineTo(A,B);this.path.element=null},rect:function(B,C,D,A){this.moveTo(B,C);this.lineTo(B+D,C);this.lineTo(B+D,C+A);this.lineTo(B,C+A);this.closePath()},strokeRect:function(B,C,D,A){this.beginPath();this.rect(B,C,D,A);this.stroke()},fillRect:function(B,C,D,A){this.beginPath();this.rect(B,C,D,A);this.fill()},closePath:function(){if(!this.path){this.beginPath()}this.path.closePath();this.path.element=null},arcSvg:function(D,F,C,G,E,A,B){if(!this.path){this.beginPath()}this.path.arcSvg(D,F,C,G,E,A,B);this.path.element=null},arc:function(D,E,F,C,B,A){if(!this.path){this.beginPath()}this.path.arc(D,E,F,C,B,A);this.path.element=null},ellipse:function(E,F,C,B,G,H,A,D){if(!this.path){this.beginPath()}this.path.ellipse(E,F,C,B,G,H,A,D);this.path.element=null},arcTo:function(E,F,A,B,G,C,D){if(!this.path){this.beginPath()}this.path.arcTo(E,F,A,B,G,C,D);this.path.element=null},bezierCurveTo:function(E,F,A,B,C,D){if(!this.path){this.beginPath()}this.path.bezierCurveTo(E,F,A,B,C,D);this.path.element=null},strokeText:function(A,B,C){A=String(A);if(this.strokeStyle){var D=this.getElement("text"),E=this.surface.getSvgElement(D,"tspan",0);this.surface.setElementAttributes(D,{"x":B,"y":C,"transform":this.matrix.toSvg(),"stroke":this.strokeStyle,"fill":"none","opacity":this.globalAlpha,"stroke-opacity":this.strokeOpacity,"style":"font: "+this.font,"stroke-dasharray":this.lineDash.join(","),"stroke-dashoffset":this.lineDashOffset});if(this.lineDash.length){this.surface.setElementAttributes(D,{"stroke-dasharray":this.lineDash.join(","),"stroke-dashoffset":this.lineDashOffset})}if(E.dom.firstChild){E.dom.removeChild(E.dom.firstChild)}this.surface.setElementAttributes(E,{"alignment-baseline":"middle","baseline-shift":"-50%"});E.dom.appendChild(document.createTextNode(Ext.String.htmlDecode(A)))}},fillText:function(A,B,C){A=String(A);if(this.fillStyle){var D=this.getElement("text"),E=this.surface.getSvgElement(D,"tspan",0);this.surface.setElementAttributes(D,{"x":B,"y":C,"transform":this.matrix.toSvg(),"fill":this.fillStyle,"opacity":this.globalAlpha,"fill-opacity":this.fillOpacity,"style":"font: "+this.font});if(E.dom.firstChild){E.dom.removeChild(E.dom.firstChild)}this.surface.setElementAttributes(E,{"alignment-baseline":"middle","baseline-shift":"-50%"});E.dom.appendChild(document.createTextNode(Ext.String.htmlDecode(A)))}},drawImage:function(M,L,I,D,K,J,G,B,F){var A=this,C=A.getElement("image"),N=L,O=I,E=typeof D==="undefined"?M.width:D,P=typeof K==="undefined"?M.height:K,H=null;if(typeof F!=="undefined"){H=L+" "+I+" "+D+" "+K;N=J;O=G;E=B;P=F}C.dom.setAttributeNS("http://www.w3.org/1999/xlink","href",M.src);A.surface.setElementAttributes(C,{viewBox:H,x:N,y:O,width:E,height:P,opacity:A.globalAlpha,transform:A.matrix.toSvg()})},fill:function(){if(!this.path){return}if(this.fillStyle){var D,C=this.fillGradient,A=this.bbox,B=this.path.element;if(!B){D=this.path.toString();B=this.path.element=this.getElement("path");this.surface.setElementAttributes(B,{"d":D,"transform":this.matrix.toSvg()})}this.surface.setElementAttributes(B,{"fill":C&&A?C.generateGradient(this,A):this.fillStyle,"fill-opacity":this.fillOpacity*this.globalAlpha})}},stroke:function(){if(!this.path){return}if(this.strokeStyle){var D,C=this.strokeGradient,A=this.bbox,B=this.path.element;if(!B||!this.path.svgString){D=this.path.toString();if(!D){return}B=this.path.element=this.getElement("path");this.surface.setElementAttributes(B,{"fill":"none","d":D,"transform":this.matrix.toSvg()})}this.surface.setElementAttributes(B,{"stroke":C&&A?C.generateGradient(this,A):this.strokeStyle,"stroke-linecap":this.lineCap,"stroke-linejoin":this.lineJoin,"stroke-width":this.lineWidth,"stroke-opacity":this.strokeOpacity*this.globalAlpha,"stroke-dasharray":this.lineDash.join(","),"stroke-dashoffset":this.lineDashOffset});if(this.lineDash.length){this.surface.setElementAttributes(B,{"stroke-dasharray":this.lineDash.join(","),"stroke-dashoffset":this.lineDashOffset})}}},fillStroke:function(G,B){var E=this,F=E.fillStyle,D=E.strokeStyle,A=E.fillOpacity,C=E.strokeOpacity;if(B===undefined){B=G.transformFillStroke}if(!B){G.inverseMatrix.toContext(E)}if(F&&A!==0){E.fill()}if(D&&C!==0){E.stroke()}},appendPath:function(A){this.path=A.clone()},createLinearGradient:function(D,E,B,C){var H=this,A=H.surface.getNextDef("linearGradient"),G=H.group.dom.gradients||(H.group.dom.gradients={}),F;H.surface.setElementAttributes(A,{"x1":D,"y1":E,"x2":B,"y2":C,"gradientUnits":"userSpaceOnUse"});F=new Ext.draw.engine.SvgContext.Gradient(H,H.surface,A);G[A.dom.id]=F;return F},createRadialGradient:function(D,E,H,B,C,F){var J=this,A=J.surface.getNextDef("radialGradient"),I=J.group.dom.gradients||(J.group.dom.gradients={}),G;J.surface.setElementAttributes(A,{"fx":D,"fy":E,"cx":B,"cy":C,"r":F,"gradientUnits":"userSpaceOnUse"});G=new Ext.draw.engine.SvgContext.Gradient(J,J.surface,A,H/F);I[A.dom.id]=G;return G}});Ext.define("Ext.draw.engine.SvgContext.Gradient",{statics:{map:{}},constructor:function(E,F,C,D){var B=this.statics().map,A;A=B[C.dom.id];if(A){A.element=null}B[C.dom.id]=this;this.ctx=E;this.surface=F;this.element=C;this.position=0;this.compression=D||0},addColorStop:function(A,D){var C=this.surface.getSvgElement(this.element,"stop",this.position++),B=this.compression;this.surface.setElementAttributes(C,{"offset":(((1-B)*A+B)*100).toFixed(2)+"%","stop-color":D,"stop-opacity":Ext.draw.Color.fly(D).a.toFixed(15)})},toString:function(){var A=this.element.dom.childNodes;while(A.length>this.position){Ext.fly(A[A.length-1]).destroy()}return"url(#"+this.element.getId()+")"},destroy:function(){var A=this.statics().map,B=this.element;if(B){delete A[B.dom.id];B.destroy()}this.callParent()}});
Ext.define("Ext.fx.runner.CssTransition",{extend:"Ext.fx.runner.Css",requires:["Ext.AnimationQueue"],listenersAttached:false,constructor:function(){this.runningAnimationsData={};return this.callParent(arguments)},attachListeners:function(){this.listenersAttached=true;this.getEventDispatcher().addListener("element","*","transitionend","onTransitionEnd",this)},onTransitionEnd:function(A){var B=A.target,C=B.id;if(C&&this.runningAnimationsData.hasOwnProperty(C)){this.refreshRunningAnimationsData(Ext.get(B),[A.browserEvent.propertyName])}},onAnimationEnd:function(B,E,M,I,N){var K=B.getId(),A=this.runningAnimationsData[K],G={},C={},D,H,J,F,L;M.un("stop","onAnimationStop",this);if(A){D=A.nameMap}G[K]=C;if(E.onBeforeEnd){E.onBeforeEnd.call(E.scope||this,B,I)}M.fireEvent("animationbeforeend",M,B,I);this.fireEvent("animationbeforeend",this,M,B,I);if(N||(!I&&!E.preserveEndState)){H=E.toPropertyNames;for(J=0,F=H.length;J<F;J++){L=H[J];if(D&&!D.hasOwnProperty(L)){C[L]=null}}}if(E.after){Ext.merge(C,E.after)}this.applyStyles(G);if(E.onEnd){E.onEnd.call(E.scope||this,B,I)}M.fireEvent("animationend",M,B,I);this.fireEvent("animationend",this,M,B,I);Ext.AnimationQueue.stop(Ext.emptyFn,M)},onAllAnimationsEnd:function(B){var C=B.getId(),A={};delete this.runningAnimationsData[C];A[C]={"transition-property":null,"transition-duration":null,"transition-timing-function":null,"transition-delay":null};this.applyStyles(A);this.fireEvent("animationallend",this,B)},hasRunningAnimations:function(B){var C=B.getId(),A=this.runningAnimationsData;return A.hasOwnProperty(C)&&A[C].sessions.length>0},refreshRunningAnimationsData:function(O,K,D,R){var N=O.getId(),I=this.runningAnimationsData,Q=I[N];if(!Q){return}var L=Q.nameMap,C=Q.nameList,F=Q.sessions,P,E,B,S,G,H,M,A,J=false;D=Boolean(D);R=Boolean(R);if(!F){return this}P=F.length;if(P===0){return this}if(R){Q.nameMap={};C.length=0;for(G=0;G<P;G++){H=F[G];this.onAnimationEnd(O,H.data,H.animation,D,R)}F.length=0}else{for(G=0;G<P;G++){H=F[G];M=H.map;A=H.list;for(E=0,B=K.length;E<B;E++){S=K[E];if(M[S]){delete M[S];Ext.Array.remove(A,S);H.length--;if(--L[S]==0){delete L[S];Ext.Array.remove(C,S)}}}if(H.length==0){F.splice(G,1);G--;P--;J=true;this.onAnimationEnd(O,H.data,H.animation,D)}}}if(!R&&!D&&F.length==0&&J){this.onAllAnimationsEnd(O)}},getRunningData:function(B){var A=this.runningAnimationsData;if(!A.hasOwnProperty(B)){A[B]={nameMap:{},nameList:[],sessions:[]}}return A[B]},getTestElement:function(){var A=this.testElement,B,C,D;if(!A){B=document.createElement("iframe");D=B.style;D.setProperty("visibility","hidden","important");D.setProperty("width","0px","important");D.setProperty("height","0px","important");D.setProperty("position","absolute","important");D.setProperty("border","0px","important");D.setProperty("zIndex","-1000","important");document.body.appendChild(B);C=B.contentDocument;C.open();C.writeln("</body>");C.close();this.testElement=A=C.createElement("div");A.style.setProperty("position","absolute","important");C.body.appendChild(A);this.testElementComputedStyle=window.getComputedStyle(A)}return A},getCssStyleValue:function(C,D){var A=this.getTestElement(),B=this.testElementComputedStyle,E=A.style;E.setProperty(C,D);if(Ext.browser.is.Firefox){A.offsetHeight}D=B.getPropertyValue(C);E.removeProperty(C);return D},run:function(A){var I=this,g=this.lengthProperties,E={},F={},c={},f,N,d,T,C,K,U,J,G,Z,B,e,b,X,S,V,P,H,L,h,R,D,Q,W,Y,a,M,O;if(!this.listenersAttached){this.attachListeners()}A=Ext.Array.from(A);for(e=0,X=A.length;e<X;e++){S=A[e];S=Ext.factory(S,Ext.fx.Animation);f=S.getElement();Ext.AnimationQueue.start(Ext.emptyFn,S);H=window.getComputedStyle(f.dom);N=f.getId();c=Ext.merge({},S.getData());if(S.onBeforeStart){S.onBeforeStart.call(S.scope||this,f)}S.fireEvent("animationstart",S);this.fireEvent("animationstart",this,S);c[N]=c;C=c.before;d=c.from;T=c.to;c.fromPropertyNames=K=[];c.toPropertyNames=U=[];for(h in T){if(T.hasOwnProperty(h)){T[h]=R=this.formatValue(T[h],h);L=this.formatName(h);W=g.hasOwnProperty(h);if(!W){R=this.getCssStyleValue(L,R)}if(d.hasOwnProperty(h)){d[h]=Q=this.formatValue(d[h],h);if(!W){Q=this.getCssStyleValue(L,Q)}if(R!==Q){K.push(L);U.push(L)}}else{D=H.getPropertyValue(L);if(R!==D){U.push(L)}}}}V=U.length;if(V===0){this.onAnimationEnd(f,c,S);continue}Z=this.getRunningData(N);M=Z.sessions;if(M.length>0){this.refreshRunningAnimationsData(f,Ext.Array.merge(K,U),true,c.replacePrevious)}Y=Z.nameMap;a=Z.nameList;P={};for(b=0;b<V;b++){h=U[b];P[h]=true;if(!Y.hasOwnProperty(h)){Y[h]=1;a.push(h)}else{Y[h]++}}O={element:f,map:P,list:U.slice(),length:V,data:c,animation:S};M.push(O);S.on("stop","onAnimationStop",this);B=Ext.apply({},C);Ext.apply(B,d);if(a.length>0){K=Ext.Array.difference(a,K);U=Ext.Array.merge(K,U);B["transition-property"]=K}E[N]=B;F[N]=Ext.apply({},T);F[N]["transition-property"]=U;F[N]["transition-duration"]=c.duration;F[N]["transition-timing-function"]=c.easing;F[N]["transition-delay"]=c.delay;S.startTime=Date.now()}G=this.$className;this.applyStyles(E);J=function(i){if(i.data===G&&i.source===window){window.removeEventListener("message",J,false);I.applyStyles(F)}};if(Ext.browser.is.IE){Ext.Function.requestAnimationFrame(function(){window.addEventListener("message",J,false);window.postMessage(G,"*")})}else{window.addEventListener("message",J,false);window.postMessage(G,"*")}},onAnimationStop:function(G){var B=this.runningAnimationsData,F,A,H,D,C,E;for(F in B){if(B.hasOwnProperty(F)){A=B[F];H=A.sessions;for(D=0,C=H.length;D<C;D++){E=H[D];if(E.animation===G){this.refreshRunningAnimationsData(E.element,E.list.slice(),false)}}}}}});
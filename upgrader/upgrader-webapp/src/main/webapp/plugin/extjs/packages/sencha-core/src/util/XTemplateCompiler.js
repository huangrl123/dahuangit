Ext.define("Ext.util.XTemplateCompiler",{extend:"Ext.util.XTemplateParser",useEval:Ext.isGecko,useIndex:Ext.isIE8m,useFormat:true,propNameRe:/^[\w\d\$]*$/,compile:function(B){var C=this,A=C.generate(B);return C.useEval?C.evalTpl(A):(new Function("Ext",A))(Ext)},generate:function(B){var C=this,D="var fm=Ext.util.Format,ts=Object.prototype.toString;",A;C.maxLevel=0;C.body=["var c0=values, a0="+C.createArrayTest(0)+", p0=parent, n0=xcount, i0=xindex, k0, v;\n"];if(C.definitions){if(typeof C.definitions==="string"){C.definitions=[C.definitions,D]}else{C.definitions.push(D)}}else{C.definitions=[D]}C.switches=[];C.parse(B);C.definitions.push((C.useEval?"$=":"return")+" function ("+C.fnArgs+") {",C.body.join(""),"}");A=C.definitions.join("\n");C.definitions.length=C.body.length=C.switches.length=0;delete C.definitions;delete C.body;delete C.switches;return A},doText:function(B){var A=this,C=A.body;B=B.replace(A.aposRe,"\\'").replace(A.newLineRe,"\\n");if(A.useIndex){C.push("out[out.length]='",B,"'\n")}else{C.push("out.push('",B,"')\n")}},doExpr:function(A){var B=this.body;B.push("if ((v="+A+") != null) out");if(this.useIndex){B.push("[out.length]=v+''\n")}else{B.push(".push(v+'')\n")}},doTag:function(A){var B=this.parseTag(A);if(B){this.doExpr(B)}else{this.doText("{"+A+"}")}},doElse:function(){this.body.push("} else {\n")},doEval:function(A){this.body.push(A,"\n")},doIf:function(A,C){var B=this;if(A==="."){B.body.push("if (values) {\n")}else{if(B.propNameRe.test(A)){B.body.push("if (",B.parseTag(A),") {\n")}else{B.body.push("if (",B.addFn(A),B.callFn,") {\n")}}if(C.exec){B.doExec(C.exec)}},doElseIf:function(A,C){var B=this;if(A==="."){B.body.push("else if (values) {\n")}else{if(B.propNameRe.test(A)){B.body.push("} else if (",B.parseTag(A),") {\n")}else{B.body.push("} else if (",B.addFn(A),B.callFn,") {\n")}}if(C.exec){B.doExec(C.exec)}},doSwitch:function(A){var C=this,B;if(A==="."||A==="#"){B=A==="."?"values":"xindex";C.body.push("switch (",B,") {\n")}else{if(C.propNameRe.test(A)){C.body.push("switch (",C.parseTag(A),") {\n")}else{C.body.push("switch (",C.addFn(A),C.callFn,") {\n")}}C.switches.push(0)},doCase:function(A){var E=this,F=Ext.isArray(A)?A:[A],C=E.switches.length-1,D,B;if(E.switches[C]){E.body.push("break;\n")}else{E.switches[C]++}for(B=0,C=F.length;B<C;++B){D=E.intRe.exec(F[B]);F[B]=D?D[1]:("'"+F[B].replace(E.aposRe,"\\'")+"'")}E.body.push("case ",F.join(": case "),":\n")},doDefault:function(){var B=this,A=B.switches.length-1;if(B.switches[A]){B.body.push("break;\n")}else{B.switches[A]++}B.body.push("default:\n")},doEnd:function(A,D){var C=this,B=C.level-1;if(A=="for"||A=="foreach"){if(D.exec){C.doExec(D.exec)}C.body.push("}\n");C.body.push("parent=p",B,";values=r",B+1,";xcount=n"+B+";xindex=i",B,"+1;xkey=k",B,";\n")}else{if(A=="if"||A=="switch"){C.body.push("}\n")}}},doFor:function(A,F){var D=this,B,C=D.level,G=C-1,E;if(A==="."){B="values"}else{if(D.propNameRe.test(A)){B=D.parseTag(A)}else{B=D.addFn(A)+D.callFn}}if(D.maxLevel<C){D.maxLevel=C;D.body.push("var ")}if(A=="."){E="c"+C}else{E="a"+G+"?c"+G+"[i"+G+"]:c"+G}D.body.push("i",C,"=0,n",C,"=0,c",C,"=",B,",a",C,"=",D.createArrayTest(C),",r",C,"=values,p",C,",k",C,";\n","p",C,"=parent=",E,"\n","if (c",C,"){if(a",C,"){n",C,"=c",C,".length;}else if (c",C,".isMixedCollection){c",C,"=c",C,".items;n",C,"=c",C,".length;}else if(c",C,".isStore){c",C,"=c",C,".data.items;n",C,"=c",C,".length;}else{c",C,"=[c",C,"];n",C,"=1;}}\n","for (xcount=n",C,";i",C,"<n"+C+";++i",C,"){\n","values=c",C,"[i",C,"]");if(F.propName){D.body.push(".",F.propName)}D.body.push("\n","xindex=i",C,"+1\n");if(F.between){D.body.push('if(xindex>1){ out.push("',F.between,'"); } \n')}},doForEach:function(A,F){var D=this,B,C=D.level,G=C-1,E;if(A==="."){B="values"}else{if(D.propNameRe.test(A)){B=D.parseTag(A)}else{B=D.addFn(A)+D.callFn}}if(D.maxLevel<C){D.maxLevel=C;D.body.push("var ")}if(A=="."){E="c"+C}else{E="a"+G+"?c"+G+"[i"+G+"]:c"+G}D.body.push("i",C,"=-1,n",C,"=0,c",C,"=",B,",a",C,"=",D.createArrayTest(C),",r",C,"=values,p",C,",k",C,";\n","p",C,"=parent=",E,"\n","for(k",C," in c",C,"){\n","xindex=++i",C,"+1;\n","xkey=k",C,";\n","values=c",C,"[k",C,"];");if(F.propName){D.body.push(".",F.propName)}if(F.between){D.body.push('if(xindex>1){ out.push("',F.between,'"); } \n')}},createArrayTest:("isArray" in Array)?function(A){return"Array.isArray(c"+A+")"}:function(A){return"ts.call(c"+A+')==="[object Array]"'},doExec:function(A,E){var C=this,D="f"+C.definitions.length,B=C.guards[C.strict?0:1];C.definitions.push("function "+D+"("+C.fnArgs+") {",B.doTry," var $v = values; with($v) {","  "+A," }",B.doCatch,"}");C.body.push(D+C.callFn+"\n")},guards:[{doTry:"",doCatch:""},{doTry:"try { ",doCatch:' } catch(e) {\nExt.log.warn("XTemplate evaluation exception: " + e.message);\n}'}],addFn:function(A){var C=this,D="f"+C.definitions.length,B=C.guards[C.strict?0:1];if(A==="."){C.definitions.push("function "+D+"("+C.fnArgs+") {"," return values","}")}else{if(A===".."){C.definitions.push("function "+D+"("+C.fnArgs+") {"," return parent","}")}else{C.definitions.push("function "+D+"("+C.fnArgs+") {",B.doTry," var $v = values; with($v) {","  return("+A+")"," }",B.doCatch,"}")}}return D},parseTag:function(E){var G=this,F=G.tagRe.exec(E),B,D,A,H,C;if(!F){return null}B=F[1];D=F[2];A=F[3];H=F[4];if(B=="."){if(!G.validTypes){G.definitions.push("var validTypes={string:1,number:1,boolean:1};");G.validTypes=true}C='validTypes[typeof values] || ts.call(values) === "[object Date]" ? values : ""'}else{if(B=="#"){C="xindex"}else{if(B=="$"){C="xkey"}else{if(B.substr(0,7)=="parent."){C=B}else{if(isNaN(B)&&B.indexOf("-")==-1&&B.indexOf(".")!=-1){C="values."+B}else{C="values['"+B+"']"}}}}}if(H){C="("+C+H+")"}if(D&&G.useFormat){A=A?","+A:"";if(D.substr(0,5)!="this."){D="fm."+D+"("}else{D+="("}}else{return C}return D+C+A+")"},evalTpl:function($){eval($);return $},newLineRe:/\r\n|\r|\n/g,aposRe:/[']/g,intRe:/^\s*(\d+)\s*$/,tagRe:/^([\w-\.\#\$]+)(?:\:([\w\.]*)(?:\((.*?)?\))?)?(\s?[\+\-\*\/]\s?[\d\.\+\-\*\/\(\)]+)?$/},function(){var A=this.prototype;A.fnArgs="out,values,parent,xindex,xcount,xkey";A.callFn=".call(this,"+A.fnArgs+")"});
Ext.define("Ext.form.field.ComboBox",{extend:"Ext.form.field.Picker",requires:["Ext.util.DelayedTask","Ext.view.BoundList","Ext.view.BoundListKeyNav","Ext.data.StoreManager"],alternateClassName:"Ext.form.ComboBox",alias:["widget.combobox","widget.combo"],mixins:["Ext.util.StoreHolder"],config:{filters:null},triggerCls:Ext.baseCSSPrefix+"form-arrow-trigger",hiddenName:"",hiddenDataCls:Ext.baseCSSPrefix+"hidden-display "+Ext.baseCSSPrefix+"form-data-hidden",ariaRole:"combobox",filtered:false,afterRender:function(){var A=this;A.callParent(arguments);A.setHiddenValue(A.value)},multiSelect:false,delimiter:", ",displayField:"text",triggerAction:"all",allQuery:"",queryParam:"query",queryMode:"remote",queryCaching:true,autoLoadOnValue:false,pageSize:0,anyMatch:false,caseSensitive:false,autoSelect:true,typeAhead:false,typeAheadDelay:250,selectOnTab:true,forceSelection:false,growToLongestValue:true,clearFilterOnBlur:true,defaultListConfig:{loadingHeight:70,minWidth:70,maxHeight:300,shadow:"sides"},transformInPlace:true,ignoreSelection:0,removingRecords:null,resizeComboToGrow:function(){var A=this;return A.grow&&A.growToLongestValue},initComponent:function(){var E=this,F=Ext.isDefined,B=E.store,G=E.transform,C=E.displayTpl,D,A;Ext.applyIf(E.renderSelectors,{hiddenDataEl:"."+E.hiddenDataCls.split(" ").join(".")});if(E.typeAhead&&E.multiSelect){Ext.Error.raise("typeAhead and multiSelect are mutually exclusive options -- please remove one of them.")}if(E.typeAhead&&!E.editable){Ext.Error.raise("If typeAhead is enabled the combo must be editable: true -- please change one of those settings.")}if(E.selectOnFocus&&!E.editable){Ext.Error.raise("If selectOnFocus is enabled the combo must be editable: true -- please change one of those settings.")}if(G){D=Ext.getDom(G);if(D){if(!E.store){B=Ext.Array.map(Ext.Array.from(D.options),function(H){return[H.value,H.text]})}if(!E.name){E.name=D.name}if(!("value" in E)){E.value=D.value}}}E.bindStore(B||"ext-empty-store",true,true);B=E.store;if(B.autoCreated){E.queryMode="local";E.valueField=E.displayField="field1";if(!B.expanded){E.displayField="field2"}}if(!F(E.valueField)){E.valueField=E.displayField}A=E.queryMode==="local";if(!F(E.queryDelay)){E.queryDelay=A?10:500}if(!F(E.minChars)){E.minChars=A?0:4}if(!C){E.displayTpl=new Ext.XTemplate('<tpl for=".">{[typeof values === "string" ? values : values["'+E.displayField+'"]]}<tpl if="xindex < xcount">'+E.delimiter+"</tpl></tpl>")}else{if(!C.isTemplate){E.displayTpl=new Ext.XTemplate(C)}}E.callParent();E.doQueryTask=new Ext.util.DelayedTask(E.doRawQuery,E);if(E.store.getCount()>0){E.setValue(E.value)}if(D){if(E.transformInPlace){E.render(D.parentNode,D);delete E.renderTo}Ext.removeNode(D)}},getSubTplMarkup:function(){var B=this,A='<div class="'+B.hiddenDataCls+'" role="presentation"></div>',C=B.callParent();return A+C},applyFilters:function(C,B){var A=this;if(C===null||C.isFilterCollection){return C}if(C){if(!B){B=this.getFilters()}B.beginUpdate();B.splice(0,B.length,C);B.each(function(D){D.ownerId=A.id});B.endUpdate()}return B},getFilters:function(B){var A=this.filters;if(!A&&B!==false){A=new Ext.util.FilterCollection();this.setFilters(A)}return A},updateFilters:function(C,A){var B=this;if(A){A.un("endupdate","onEndUpdateFilters",B)}if(C){C.on("endupdate","onEndUpdateFilters",B)}B.onEndUpdateFilters(C)},onEndUpdateFilters:function(E){var B=this,F=B.filtered,A=!!E&&(E.length>0),D,C;if(F||A){B.filtered=A;D=[];C=B.store.getFilters();C.each(function(G){if(G.ownerId===B.id&&!E.contains(G)){D.push(G)}});C.splice(0,D,E.items)}},getStore:function(){return this.store},beforeBlur:function(){var A=this,B=A.queryFilter;A.doQueryTask.cancel();A.assertValue();if(B&&A.queryMode==="local"&&A.clearFilterOnBlur){A.getStore().getFilters().remove(B)}},onFocus:function(){var A=this;A.callParent(arguments);if(!A.duringTriggerClick&&A.triggerAction!=="all"&&A.queryFilter&&A.queryMode==="local"&&A.clearFilterOnBlur){delete A.lastQuery;A.doRawQuery()}},assertValue:function(){var B=this,C=B.getRawValue(),A,D;if(B.forceSelection){if(B.multiSelect){if(C!==B.getDisplayValue()){B.setValue(B.lastSelection)}}else{A=B.findRecordByDisplay(C);if(A){D=B.value;if(!B.findRecordByValue(D)){B.select(A,true)}}else{B.setValue(B.lastSelection)}}}B.collapse()},onTypeAhead:function(){var C=this,A=C.displayField,F=C.store.findRecord(A,C.getRawValue()),E=C.getPicker(),G,D,B;if(F){G=F.get(A);D=G.length;B=C.getRawValue().length;E.highlightItem(E.getNode(F));if(B!==0&&B!==D){C.setRawValue(G);C.selectText(B,G.length)}}},resetToDefault:Ext.emptyFn,beforeReset:function(){var A=this.queryFilter;this.callParent();if(A){this.getStore().getFilters().remove(A)}},onUnbindStore:function(){var A=this,B=A.picker,C=A.queryFilter;if(C&&!A.store.isDestroyed){A.getStore().getFilters().remove(C)}if(B){B.bindStore(null)}},onBindStore:function(A,B){var C=this.picker;if(!B){this.resetToDefault()}if(C){C.bindStore(A)}},bindStore:function(A,E,B){var C=this,D=C.queryFilter;C.mixins.storeholder.bindStore.call(C,A,B);A=C.getStore();if(A&&D&&!E){A.getFilters().add(D)}if(!B&&A){C.setValueOnData()}},getStoreListeners:function(){var A=this;return{beforeload:A.onBeforeLoad,clear:A.onClear,datachanged:A.onDataChanged,load:A.onLoad,exception:A.onException,remove:A.onRemove}},onBeforeLoad:function(){++this.ignoreSelection},onDataChanged:function(){var A=this;if(A.resizeComboToGrow()){A.updateLayout()}},onClear:function(){var A=this;if(A.resizeComboToGrow()){A.removingRecords=true;A.onDataChanged()}},onRemove:function(){var A=this;if(A.resizeComboToGrow()){A.removingRecords=true}},onException:function(){if(this.ignoreSelection>0){--this.ignoreSelection}this.collapse()},onLoad:function(B,C,A){if(this.ignoreSelection>0){--this.ignoreSelection}if(A&&!B.lastOptions.rawQuery){this.setValueOnData()}},setValueOnData:function(){var A=this;if(A.value==null){if(A.getStore().getCount()){A.doAutoSelect()}else{A.setValue(A.value)}}else{A.setValue(A.value)}},doRawQuery:function(){this.doQuery(this.getRawValue(),false,true)},doQuery:function(C,D,A){var B=this,E=B.beforeQuery({query:C||"",rawQuery:A,forceAll:D,combo:B,cancel:false});if(E===false||E.cancel){return false}if(B.queryCaching&&E.query===B.lastQuery){B.expand();if(B.queryMode==="local"){B.doAutoSelect()}}else{B.lastQuery=E.query;if(B.queryMode==="local"){B.doLocalQuery(E)}else{B.doRemoteQuery(E)}}return true},beforeQuery:function(B){var A=this;if(A.fireEvent("beforequery",B)===false){B.cancel=true}else{if(!B.cancel){if(B.query.length<A.minChars&&!B.forceAll){B.cancel=true}}}return B},doLocalQuery:function(E){var A=this,C=E.query,D=A.getStore().getFilters(),B=A.queryFilter;A.queryFilter=null;D.beginUpdate();if(B){D.remove(B)}if(C){B=A.queryFilter=new Ext.util.Filter({id:A.id+"-filter",anyMatch:A.anyMatch,caseSensitive:A.caseSensitive,root:"data",property:A.displayField,value:A.enableRegEx?new RegExp(C):C});D.add(B)}D.endUpdate();if(A.store.getCount()||A.getPicker().emptyText){A.expand()}else{A.collapse()}A.afterQuery(E)},doRemoteQuery:function(C){var B=this,A=function(){B.afterQuery(C)};B.expand();if(B.pageSize){B.loadPage(1,{rawQuery:C.rawQuery,callback:A})}else{B.store.load({params:B.getParams(C.query),rawQuery:C.rawQuery,callback:A})}},afterQuery:function(B){var A=this;if(A.store.getCount()){if(A.typeAhead){A.doTypeAhead()}if(A.getRawValue()!==A.getDisplayValue()){A.ignoreSelection++;A.picker.getSelectionModel().deselectAll();A.ignoreSelection--}if(B.rawQuery){A.syncSelection();if(A.picker&&!A.picker.getSelectionModel().hasSelection()){A.doAutoSelect()}}else{A.doAutoSelect()}}},loadPage:function(A,B){this.store.loadPage(A,Ext.apply({params:this.getParams(this.lastQuery)},B))},onPageChange:function(B,A){this.loadPage(A);return false},getParams:function(B){var C={},A=this.queryParam;if(A){C[A]=B}return C},doAutoSelect:function(){var B=this,C=B.picker,A,D;if(C&&B.autoSelect&&B.store.getCount()>0){A=C.getSelectionModel().lastSelected;D=C.getNode(A||0);if(D){C.highlightItem(D);C.listEl.scrollChildIntoView(D,false)}}},doTypeAhead:function(){var A=this,B=Ext.event.Event;if(!A.typeAheadTask){A.typeAheadTask=new Ext.util.DelayedTask(A.onTypeAhead,A)}if(A.lastKey!==B.BACKSPACE&&A.lastKey!==B.DELETE){A.typeAheadTask.delay(A.typeAheadDelay)}},onTriggerClick:function(){var A=this;A.duringTriggerClick=true;if(!A.readOnly&&!A.disabled){if(A.isExpanded){A.collapse()}else{A.onFocus({});if(A.triggerAction==="all"){A.doQuery(A.allQuery,true)}else{if(A.triggerAction==="last"){A.doQuery(A.lastQuery,true)}else{A.doQuery(A.getRawValue(),false,true)}}}if(!Ext.supports.Touch){A.inputEl.focus()}}delete A.duringTriggerClick},onPaste:function(){var A=this;if(!A.readOnly&&!A.disabled&&A.editable){A.doQueryTask.delay(A.queryDelay)}},onKeyUp:function(B,D){var C=this,A=B.getKey();if(!C.readOnly&&!C.disabled&&C.editable){C.lastKey=A;if(!B.isSpecialKey()||A===B.BACKSPACE||A===B.DELETE){C.doQueryTask.delay(C.queryDelay)}}if(C.enableKeyEvents){C.callParent(arguments)}},initEvents:function(){var A=this;A.callParent();if(!A.enableKeyEvents){A.mon(A.inputEl,"keyup",A.onKeyUp,A)}A.mon(A.inputEl,"paste",A.onPaste,A)},onDestroy:function(){var A=this;if(A.typeAheadTask){A.typeAheadTask.cancel();A.typeAheadTask=null}Ext.destroy(A.listKeyNav);A.bindStore(null);A.callParent()},onAdded:function(){var A=this;A.callParent(arguments);if(A.picker){A.picker.ownerCt=A.up("[floating]");A.picker.registerWithOwnerCt()}},createPicker:function(){var A=this,B,C=Ext.apply({xtype:"boundlist",pickerField:A,selModel:{mode:A.multiSelect?"SIMPLE":"SINGLE"},floating:true,hidden:true,store:A.store,displayField:A.displayField,focusOnToFront:false,preserveScrollOnRefresh:true,pageSize:A.pageSize,tpl:A.tpl},A.listConfig,A.defaultListConfig);B=A.picker=Ext.widget(C);if(A.pageSize){B.pagingToolbar.on("beforechange",A.onPageChange,A)}A.mon(B,{itemclick:A.onItemClick,refresh:A.onListRefresh,scope:A});A.mon(B.getSelectionModel(),{beforeselect:A.onBeforeSelect,beforedeselect:A.onBeforeDeselect,selectionchange:A.onListSelectionChange,scope:A});return B},alignPicker:function(){var D=this,E=D.getPicker(),C=D.getPosition()[1]-Ext.getBody().getScroll().top,G=Ext.Element.getViewportHeight()-C-D.getHeight(),F=Math.max(C,G),A=E.getTargetEl().dom,B=A.scrollTop;if(E.height){delete E.height;E.updateLayout()}if(E.getHeight()>F-5){E.setHeight(F-5)}D.callParent();A.scrollTop=B},onListRefresh:function(){if(!this.expanding){this.alignPicker()}this.syncSelection()},onItemClick:function(D,C){var A=this,E=A.picker.getSelectionModel().getSelection(),B=A.valueField;if(!A.multiSelect&&E.length){if(C.get(B)===E[0].get(B)){A.displayTplData=[C.data];A.setRawValue(A.getDisplayValue());A.collapse()}}},onBeforeSelect:function(B,A){return this.fireEvent("beforeselect",this,A,this.getStore().indexOf(A))},onBeforeDeselect:function(B,A){return this.fireEvent("beforedeselect",this,A,this.getStore().indexOf(A))},onListSelectionChange:function(D,E){var C=this,B=C.multiSelect,A=E.length>0;if(!C.ignoreSelection&&C.isExpanded){if(!B){Ext.defer(C.collapse,1,C)}if(B||A){C.setValue(E,false)}if(A){C.fireEvent("select",C,E)}if(!Ext.supports.Touch){C.inputEl.focus()}}},onExpand:function(){var B=this,A=B.listKeyNav,D=B.selectOnTab,C=B.getPicker();if(A){A.enable()}else{A=B.listKeyNav=new Ext.view.BoundListKeyNav(B.inputEl,{boundList:C,forceKeyDown:true,tab:function(E){if(D){this.selectHighlighted(E);B.triggerBlur()}return true},enter:function(F){var G=C.getSelectionModel(),E=G.getCount();this.selectHighlighted(F);if(!B.multiSelect&&E===G.getCount()){B.collapse()}}})}if(D){B.ignoreMonitorTab=true}if(!Ext.supports.Touch){Ext.defer(A.enable,1,A);B.inputEl.focus()}},onCollapse:function(){var B=this,A=B.listKeyNav;if(A){A.disable();B.ignoreMonitorTab=false}},select:function(A,D){var B=this,C=B.picker,E;if(A&&A.isModel&&D===true&&C){E=!C.getSelectionModel().isSelected(A)}B.setValue(A,true);if(E){B.fireEvent("select",B,A)}},findRecord:function(D,A){var B=this.store,C=B.findExact(D,A);return C!==-1?B.getAt(C):false},getSelectedRecord:function(){return this.findRecordByValue(this.value)||null},findRecordByValue:function(A){return this.findRecord(this.valueField,A)},findRecordByDisplay:function(A){return this.findRecord(this.displayField,A)},setValue:function(H,O){var L=this,A=L.valueNotFoundText,G=L.getStore(),M=L.inputEl,P=[],D=[],B=[],C=L.autoLoadOnValue,J=G.hasPendingLoad(),E=C&&G.loadCount===0&&!J,I,F,N,K;if(H!=null&&(J||E||G.isEmptyStore)){L.value=H;L.setHiddenValue(L.value);if(E&&G.getProxy().isRemote){G.load()}return L}H=Ext.Array.from(H);for(I=0,F=H.length;I<F;I++){N=H[I];if(!N||!N.isModel){N=L.findRecordByValue(N)}if(N){P.push(N);D.push(N.data);B.push(N.get(L.valueField))}else{if(!L.forceSelection){B.push(H[I]);K={};K[L.displayField]=H[I];D.push(K)}else{if(Ext.isDefined(A)){D.push(A)}}}}L.setHiddenValue(B);L.value=L.multiSelect?B:B[0];if(!Ext.isDefined(L.value)){L.value=undefined}L.displayTplData=D;L.lastSelection=L.valueModels=P;if(M&&L.emptyText&&!Ext.isEmpty(H)){M.removeCls(L.emptyCls)}L.setRawValue(L.getDisplayValue());L.checkChange();if(O!==false){L.syncSelection()}L.applyEmptyText();return L},setHiddenValue:function(H){var A=this,B=A.hiddenName,E,C,D,I,F,G;if(!A.hiddenDataEl||!B){return}H=Ext.Array.from(H);C=A.hiddenDataEl.dom;D=C.childNodes;I=D[0];F=H.length;G=D.length;if(!I&&F>0){A.hiddenDataEl.setHtml(Ext.DomHelper.markup({tag:"input",type:"hidden",name:B}));G=1;I=C.firstChild}while(G>F){C.removeChild(D[0]);--G}while(G<F){C.appendChild(I.cloneNode(true));++G}for(E=0;E<F;E++){D[E].value=H[E]}},getDisplayValue:function(){return this.displayTpl.apply(this.displayTplData)},getValue:function(){var B=this,C=B.picker,A=B.getRawValue(),D=B.value;if(B.getDisplayValue()!==A){D=A;B.value=B.displayTplData=B.valueModels=undefined;if(C){B.ignoreSelection++;C.getSelectionModel().deselectAll();B.ignoreSelection--}}B.value=D==null?null:D;return B.value},getSubmitValue:function(){var A=this.getValue();if(Ext.isEmpty(A)){A=""}return A},isEqual:function(D,E){var B=Ext.Array.from,A,C;D=B(D);E=B(E);C=D.length;if(C!==E.length){return false}for(A=0;A<C;A++){if(E[A]!==D[A]){return false}}return true},clearValue:function(){this.setValue([])},syncSelection:function(){var G=this,B=G.picker,F,A,E=G.valueModels||[],H=E.length,C,D;if(B){F=[];for(C=0;C<H;C++){D=E[C];if(D&&D.isModel&&G.store.indexOf(D)>=0){F.push(D)}}G.ignoreSelection++;A=B.getSelectionModel();A.deselectAll();if(F.length){A.select(F,undefined,true)}G.ignoreSelection--}},onEditorTab:function(A){var B=this.listKeyNav;if(this.selectOnTab&&B){B.selectHighlighted(A)}}});
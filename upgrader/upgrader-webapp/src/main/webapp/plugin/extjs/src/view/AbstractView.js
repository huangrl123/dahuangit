Ext.define("Ext.view.AbstractView",{extend:"Ext.Component",requires:["Ext.LoadMask","Ext.data.StoreManager","Ext.CompositeElementLite","Ext.selection.DataViewModel"],mixins:["Ext.util.StoreHolder"],inheritableStatics:{getRecord:function(A){return this.getBoundView(A).getRecord(A)},getBoundView:function(A){return Ext.getCmp(A.boundView)}},defaultBindProperty:"store",statics:{updateDelay:200,queueRecordChange:function(A,B,N,I,J){var L=this,C=L.changeQueue||(L.changeQueue={}),G=N.internalId,H,O,M,K,F,E,D;H=C[G]||(C[G]={operation:I,record:N,data:{},views:[]});O=H.data;Ext.Array.include(H.views,A);if(J&&(M=J.length)){for(K=0;K<M;K++){F=J[K];E=N.data[F];if(O.hasOwnProperty(F)){if(N.isEqual(O[F],E)){delete O[F];D=true}}else{O[F]=E}}if(D&&!Ext.Object.getKeys(O).length){delete C[G]}}else{Ext.apply(O,N.data)}if(!L.flushQueueTask){L.flushQueueTask=Ext.util.TaskManager.newTask({run:Ext.global.requestAnimationFrame?Ext.Function.createAnimationFrame(L.onFlushTick,L):Ext.Function.bind(L.onFlushTick,L),interval:Ext.view.AbstractView.updateDelay,repeat:1})}L.flushQueueTask.start()},onFlushTick:function(){Ext.AnimationQueue.start(this.flushChangeQueue,this)},flushChangeQueue:function(){var G=this,E,H,C,B,D,F,A;if(Ext.isScrolling){G.flushQueueTask.start();return}C=G.changeQueue;this.changeQueue={};for(D in C){B=C[D];E=B.views;H=E.length;for(F=0;F<H;F++){A=E[F];if(!A.isDestroyed){A.handleUpdate(A.dataSource,B.record,B.operation,Ext.Object.getKeys(B.data))}}}Ext.AnimationQueue.stop(G.flushChangeQueue,G)}},throttledUpdate:false,deferInitialRefresh:false,itemCls:Ext.baseCSSPrefix+"dataview-item",loadingText:"Loading...",loadMask:true,loadingUseMsg:true,selectedItemCls:Ext.baseCSSPrefix+"item-selected",emptyText:"",deferEmptyText:true,trackOver:false,blockRefresh:false,preserveScrollOnRefresh:false,ariaRole:"listbox",itemAriaRole:"option",last:false,triggerEvent:"itemclick",triggerCtEvent:"containerclick",refreshNeeded:true,addCmpEvents:Ext.emptyFn,initComponent:function(){var B=this,C=Ext.isDefined,D=B.itemTpl,A={};if(D){if(Ext.isArray(D)){D=D.join("")}else{if(Ext.isObject(D)){A=Ext.apply(A,D.initialConfig);D=D.html}}if(!B.itemSelector){B.itemSelector="."+B.itemCls}D=Ext.String.format('<tpl for="."><div class="{0}" role="{2}">{1}</div></tpl>',B.itemCls,D,B.itemAriaRole);B.tpl=new Ext.XTemplate(D,A)}if(!C(B.tpl)||!C(B.itemSelector)){Ext.Error.raise({sourceClass:"Ext.view.View",tpl:B.tpl,itemSelector:B.itemSelector,msg:"DataView requires both tpl and itemSelector configurations to be defined."})}B.callParent();B.tpl=B.getTpl("tpl");if(C(B.overCls)||C(B.overClass)){if(Ext.isDefined(Ext.global.console)){Ext.global.console.warn("Ext.view.View: Using the deprecated overCls or overClass configuration. Use overItemCls instead.")}B.overItemCls=B.overCls||B.overClass;delete B.overCls;delete B.overClass}if(C(B.selectedCls)||C(B.selectedClass)){if(Ext.isDefined(Ext.global.console)){Ext.global.console.warn("Ext.view.View: Using the deprecated selectedCls or selectedClass configuration. Use selectedItemCls instead.")}B.selectedItemCls=B.selectedCls||B.selectedClass;delete B.selectedCls;delete B.selectedClass}if(B.overItemCls){B.trackOver=true}B.addCmpEvents();B.store=Ext.data.StoreManager.lookup(B.store||"ext-empty-store");if(!B.dataSource){B.dataSource=B.store}B.bindStore(B.dataSource,true,"dataSource");if(!B.all){B.all=new Ext.CompositeElementLite()}B.scrollState={top:0,left:0};B.on({scroll:B.onViewScroll,element:"el",onFrame:!!Ext.global.requestAnimationFrame,scope:B})},onRender:function(){var C=this,E=C.loadMask,A=C.getMaskStore(),D={target:C,msg:C.loadingText,useMsg:C.loadingUseMsg,store:A},B;C.callParent(arguments);if(E){B=A.getProxy();if(B&&!B.isSynchronous){if(C.loadingCls){D.msgCls=C.loadingCls}if(Ext.isObject(E)){D=Ext.apply(D,E)}C.loadMask=new Ext.LoadMask(D);C.loadMask.on({scope:C,beforeshow:C.onMaskBeforeShow,hide:C.onMaskHide})}}},beforeLayout:function(){var A=this;A.callParent(arguments);if(A.refreshNeeded&&!A.pendingRefresh){if(A.refreshCounter){A.refresh()}else{A.doFirstRefresh(A.dataSource)}}},getMaskStore:function(){return this.store},onMaskBeforeShow:function(){var B=this,A=B.loadingHeight;if(A&&A>B.getHeight()){B.hasLoadingHeight=true;B.oldMinHeight=B.minHeight;B.minHeight=A;B.updateLayout()}},onMaskHide:function(){var A=this;if(!A.destroying&&A.hasLoadingHeight){A.minHeight=A.oldMinHeight;A.updateLayout();delete A.hasLoadingHeight}},beforeRender:function(){this.callParent(arguments);this.getSelectionModel().beforeViewRender(this)},afterRender:function(){this.callParent(arguments);this.getSelectionModel().bindComponent(this)},getRefItems:function(){var B=this.loadMask,A=[];if(B&&B.isComponent){A.push(B)}return A},getSelectionModel:function(){var B=this,A="SINGLE";if(B.simpleSelect){A="SIMPLE"}else{if(B.multiSelect){A="MULTI"}}if(!B.selModel||!B.selModel.events){B.selModel=new Ext.selection.DataViewModel(Ext.apply({allowDeselect:B.allowDeselect,mode:A},B.selModel))}if(!B.selModel.hasRelaySetup){B.relayEvents(B.selModel,["selectionchange","beforeselect","beforedeselect","select","deselect","focuschange"]);B.selModel.hasRelaySetup=true}if(B.disableSelection){B.selModel.locked=true}return B.selModel},refresh:function(){var H=this,A=H.all,D=A.getCount(),G=H.refreshCounter,J,F,C,B,I,E=G&&A.getCount()&&H.preserveScrollOnRefresh&&!H.bufferedRenderer,K;if(!H.rendered||H.isDestroyed||H.preventRefresh){return}if(!H.hasListeners.beforerefresh||H.fireEvent("beforerefresh",H)!==false){H.refreshing=true;J=H.getTargetEl();B=H.getViewRange();C=J.dom;if(E){F=H.getOverflowEl();K=F.getScroll()}if(G){I=true;H.clearViewEl();H.refreshCounter++}else{H.refreshCounter=1}H.tpl.append(J,H.collectData(B,A.startIndex||0));if(B.length<1){if(H.emptyText&&!H.getStore().isLoading()&&(!H.deferEmptyText||I)){H.emptyEl=Ext.core.DomHelper.insertHtml("beforeEnd",J.dom,H.emptyText)}A.clear()}else{H.collectNodes(J.dom);H.updateIndexes(0)}if(I){if(H.refreshSelmodelOnRefresh!==false){H.selModel.refresh()}else{if(!H.preventPrune){H.selModel.pruneIf()}}}H.refreshNeeded=false;H.refreshSize(A.getCount()!==D);H.fireEvent("refresh",H,B);if(E){F.setScrollLeft(K.left);F.setScrollTop(K.top)}if(!H.viewReady){H.viewReady=true;H.fireEvent("viewready",H)}H.refreshing=false;H.refreshScroll()}},collectNodes:function(B){var A=this.all;A.fill(Ext.fly(B).query(this.getItemSelector()),A.startIndex||0)},getViewRange:function(){return this.dataSource.getRange()},refreshSize:function(A){var C=this,B=C.getSizeModel(),D=C.scrollManager;if(B.height.shrinkWrap||B.width.shrinkWrap||A){C.updateLayout()}else{if(D){D.refresh()}}},onResize:function(){var B=this,A=B.scrollManager;if(A&&!B._hasScrollListener){A.on({scroll:B.onViewScroll,scope:B,onFrame:!!Ext.global.requestAnimationFrame});B._hasScrollListener=true}this.callParent(arguments)},clearViewEl:function(){var B=this,A=B.getNodeContainer()===B.getEl();B.clearEmptyEl();B.all.clear(!A);if(A){B.el.dom.innerHTML=""}},clearEmptyEl:function(){var A=this.emptyEl;if(A){A.parentNode.removeChild(A)}this.emptyEl=null},onViewScroll:function(){this.fireEvent("scroll",this)},saveScrollState:function(){var A=this,B=A.scrollState;if(A.rendered){B.left=A.getScrollX();B.top=A.getScrollY()}},restoreScrollState:function(){var A=this,B=A.scrollState;if(A.rendered){A.setScrollX(B.left);A.setScrollY(B.top)}},prepareData:function(F,E,C){var A,B,D;if(C){A=C.getAssociatedData();for(B in A){if(A.hasOwnProperty(B)){if(!D){F=Ext.Object.chain(F);D=true}F[B]=A[B]}}}return F},collectData:function(B,C){var F=[],A=0,D=B.length,E;for(;A<D;A++){E=B[A];F[A]=this.prepareData(E.data,C+A,E)}return F},bufferRender:function(A,D){var C=this,B=C.renderBuffer||(C.self.prototype.renderBuffer=document.createElement("div"));C.tpl.overwrite(B,C.collectData(A,D));return Ext.fly(B).query(C.getItemSelector())},nodeContainerSelector:null,getNodeContainer:function(){var B=this.getTargetEl(),A=this.nodeContainerSelector;return A?B.down(A,true):B},getNodeContainerSelector:function(){return this.nodeContainerSelector},onUpdate:function(A,C,D,B){var E=this;if(E.throttledUpdate){E.statics().queueRecordChange(E,A,C,D,B)}else{E.handleUpdate.apply(E,arguments)}},handleUpdate:function(A,C){var E=this,D,B;if(E.viewReady){D=E.dataSource.indexOf(C);if(D>-1){if(E.getNode(C)){B=E.bufferRender([C],D)[0];E.all.replaceElement(D,B,true);E.updateIndexes(D,D);E.selModel.onUpdate(C);if(E.hasListeners.itemupdate){E.fireEvent("itemupdate",C,D,B)}return B}}}},onReplace:function(D,A,F,G){var I=this,J,B=I.all,K,H,E,C;if(I.rendered){K=I.bufferRender(G,A,true);H=B.item(A);if(H){B.item(A).insertSibling(K,"before",true)}else{I.appendNodes(K)}B.insert(A,K);A+=G.length;J=A+F.length-1;B.removeRange(A,J,true);if(I.refreshSelmodelOnRefresh!==false){I.selModel.refresh()}I.updateIndexes(A);I.refreshSizePending=true;if(I.hasListeners.itemremove){for(E=F.length,C=J;E>=0;--E,--C){I.fireEvent("itemremove",F[E],C,I)}}if(I.hasListeners.itemadd){I.fireEvent("itemadd",G,A,K)}}},onAdd:function(A,B,E){var C=this,D;if(C.rendered){if(C.all.getCount()===0){C.refresh();D=C.all.slice()}else{D=C.doAdd(B,E);if(C.refreshSelmodelOnRefresh!==false){C.selModel.refresh()}C.updateIndexes(E);C.refreshSizePending=true}if(C.hasListeners.itemadd){C.fireEvent("itemadd",B,E,D)}}},appendNodes:function(B){var D=document.createDocumentFragment(),C=B.length,A;for(A=0;A<C;++A){D.appendChild(B[A])}this.getNodeContainer().appendChild(D)},doAdd:function(C,G){var F=this,H=F.bufferRender(C,G,true),B=F.all,A=B.getCount(),D=B.startIndex||0,E=B.endIndex||A-1;if(A===0||G>E){F.appendNodes(H)}else{if(G<=D){B.item(D).insertSibling(H,"before",true)}else{B.item(G).insertSibling(H,"before",true)}}B.insert(G,H);return H},onRemove:function(C,D,B){var H=this,A=H.all,G=H.hasListeners.itemremove,J,E,I,K,F;if(A.getCount()){if(H.dataSource.getCount()===0){if(G){H.fireEvent("itemremove",D,B,H.getNodes(B,B+D.length-1))}H.preventPrune=true;H.refresh();H.preventPrune=false}else{if(G){K=[]}for(E=D.length-1;E>=0;--E){I=D[E];J=B+E;if(K){F=A.item(J);K[E]=F?F.dom:undefined}if(A.item(J)){H.doRemove(I,J)}}if(G){H.fireEvent("itemremove",D,B,K,H)}H.updateIndexes(B)}H.refreshSizePending=true}},doRemove:function(A,B){this.all.removeElement(B,true)},refreshNode:function(A){if(Ext.isNumber(A)){A=this.store.getAt(A)}this.onUpdate(this.dataSource,A)},updateIndexes:function(C,E){var D=this.all.elements,B=this.getViewRange(),A;C=C||0;E=E||((E===0)?0:(D.length-1));for(A=C;A<=E;A++){D[A].viewIndex=A;D[A].viewRecordId=B[A].internalId;if(!D[A].boundView){D[A].boundView=this.id}}},getStore:function(){return this.store},bindStore:function(A,B,D){var C=this;C.mixins.storeholder.bindStore.apply(C,arguments);if(!B){C.getSelectionModel().bindStore(A)}if(C.componentLayoutCounter){C.doFirstRefresh(A)}},doFirstRefresh:function(A,B){var C=this;if(C.deferInitialRefresh&&!B){Ext.defer(C.doFirstRefresh,1,C,[A,true])}else{if(A&&!A.loading){C.refresh()}}},onUnbindStore:function(A){this.setMaskBind(null)},onBindStore:function(A,B,D){var C=this;C.setMaskBind(A);if(!B&&D==="store"){C.preventRefresh=true;C.store=A;C.bindStore(A,false,"dataSource");C.preventRefresh=false}},setMaskBind:function(A){var B=this.loadMask;if(B&&B.bindStore){B.bindStore(A)}},getStoreListeners:function(){var A=this;return{refresh:A.onDataRefresh,replace:A.onReplace,add:A.onAdd,remove:A.onRemove,update:A.onUpdate,clear:A.refresh,beginupdate:A.onBeginUpdate,endupdate:A.onEndUpdate}},onBeginUpdate:Ext.emptyFn,onEndUpdate:function(){if(this.refreshSizePending){this.refreshSize(true);this.refreshSizePending=false}},onDataRefresh:function(){this.refreshView()},refreshView:function(){var B=this,A=B.blockRefresh||!B.rendered||B.up("[collapsed],[isCollapsingOrExpanding],[hidden]");if(A){B.refreshNeeded=true}else{if(B.bufferedRenderer&&B.all.getCount()){B.bufferedRenderer.refreshView()}else{B.refresh()}}},findItemByChild:function(A){return Ext.fly(A).findParent(this.getItemSelector(),this.getTargetEl())},findTargetByEvent:function(A){return A.getTarget(this.getItemSelector(),this.getTargetEl())},getSelectedNodes:function(){var C=[],B=this.selModel.getSelection(),D=B.length,A=0;for(;A<D;A++){C.push(this.getNode(B[A]))}return C},getRecords:function(C){var B=[],A=0,D=C.length,E=this.dataSource.data;for(;A<D;A++){B[B.length]=E.getByKey(C[A].viewRecordId)}return B},getRecord:function(A){return this.dataSource.getByInternalId(Ext.getDom(A).viewRecordId)},isSelected:function(B){var A=this.getRecord(B);return this.selModel.isSelected(A)},select:function(A,C,B){this.selModel.select(A,C,B)},deselect:function(A,B){this.selModel.deselect(A,B)},getNode:function(A){if((!A&&A!==0)||!this.rendered){return null}if(A.target){A=A.target}if(Ext.isString(A)){return document.getElementById(A)}if(Ext.isNumber(A)){return this.all.elements[A]}if(A.isModel){return this.getNodeByRecord(A)}return Ext.fly(A).findParent(this.itemSelector,this.getTargetEl())},getNodeByRecord:function(C){var A=this.all.elements,D=A.length,B=0;for(;B<D;B++){if(A[B].viewRecordId===C.internalId){return A[B]}}return null},getNodes:function(C,B){var A=this.all;if(B!==undefined){B++}return A.slice(C,B)},indexOf:function(A){A=this.getNode(A);if(!A&&A!==0){return -1}if(Ext.isNumber(A.viewIndex)){return A.viewIndex}return this.all.indexOf(A)},onDestroy:function(){var A=this;A.all.clear();A.emptyEl=null;A.callParent();A.bindStore(null);Ext.destroy(A.selModel,A.scrollManager)},onItemSelect:function(B){var A=this.getNode(B);if(A){Ext.fly(A).addCls(this.selectedItemCls)}},onItemDeselect:function(B){var A=this.getNode(B);if(A){Ext.fly(A).removeCls(this.selectedItemCls)}},getItemSelector:function(){return this.itemSelector},addItemCls:function(A,B){var C=this.getNode(A);if(C){Ext.fly(C).addCls(B)}},removeItemCls:function(A,B){var C=this.getNode(A);if(C){Ext.fly(C).removeCls(B)}},privates:{getOverflowEl:function(){return Ext.Component.prototype.getTargetEl.call(this)},getTargetEl:function(){return this.touchScroll?this.getScrollerEl():this.callParent()}}},function(){Ext.deprecate("extjs","4.0",function(){Ext.view.AbstractView.override({getSelectionCount:function(){if(Ext.global.console){Ext.global.console.warn("DataView: getSelectionCount will be removed, please interact with the Ext.selection.DataViewModel")}return this.selModel.getSelection().length},getSelectedRecords:function(){if(Ext.global.console){Ext.global.console.warn("DataView: getSelectedRecords will be removed, please interact with the Ext.selection.DataViewModel")}return this.selModel.getSelection()},select:function(A,C,D){if(Ext.global.console){Ext.global.console.warn("DataView: select will be removed, please access select through a DataView's SelectionModel, ie: view.getSelectionModel().select()")}var B=this.getSelectionModel();return B.select.apply(B,arguments)},clearSelections:function(){if(Ext.global.console){Ext.global.console.warn("DataView: clearSelections will be removed, please access deselectAll through DataView's SelectionModel, ie: view.getSelectionModel().deselectAll()")}var A=this.getSelectionModel();return A.deselectAll()}})})});
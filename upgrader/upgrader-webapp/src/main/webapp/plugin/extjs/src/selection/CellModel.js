Ext.define("Ext.selection.CellModel",{extend:"Ext.selection.Model",alias:"selection.cellmodel",requires:["Ext.grid.CellContext","Ext.util.KeyNav"],isCellModel:true,enableKeyNav:true,preventWrap:false,noSelection:{row:-1,column:-1},bindComponent:function(B){var A=this,C=B.ownerCt;A.primaryView=B;A.views=A.views||[];A.views.push(B);A.bindStore(B.getStore(),true);B.on({cellclick:A.onCellClick,refresh:A.onViewRefresh,scope:A});if(C.optimizedColumnMove!==false){C.on("columnmove",A.onColumnMove,A)}if(A.enableKeyNav){A.initKeyNav(B)}},initKeyNav:function(B){var A=this;if(!B.rendered){B.on("render",Ext.Function.bind(A.initKeyNav,A,[B],0),A,{single:true});return}B.el.set({tabIndex:-1});A.keyNav=new Ext.util.KeyNav({target:B.el,ignoreInputFields:true,up:A.onKeyUp,down:A.onKeyDown,right:A.onKeyRight,left:A.onKeyLeft,tab:A.onKeyTab,scope:A})},getHeaderCt:function(){var B=this.getCurrentPosition(),A=B?B.view:this.primaryView;return A.headerCt},onKeyUp:function(A){this.doMove("up",A)},onKeyDown:function(A){this.doMove("down",A)},onKeyLeft:function(A){this.doMove("left",A)},onKeyRight:function(A){this.doMove("right",A)},doMove:function(B,A){this.keyNavigation=true;this.move(B,A);this.keyNavigation=false},selectWithEvent:function(B,A){this.select(B)},select:function(D,G,C){var E=this,B,F=E.getCurrentPosition(),A=E.view.store;if(D||D===0){if(D.isModel){B=A.indexOf(D);if(B!==-1){D={row:B,column:F?F.column:0}}else{D=null}}else{if(typeof D==="number"){D={row:D,column:0}}}}if(D){E.selectByPosition(D,C)}else{E.deselect()}},deselect:function(B,A){this.selectByPosition(null,A)},move:function(A,B){var D=this,C=D.getCurrentPosition(),E;if(C){E=C.view.walkCells(C,A,B,D.preventWrap);if(E){return D.setCurrentPosition(E)}}return null},getCurrentPosition:function(){return this.selecting?this.nextSelection:this.selection},setCurrentPosition:function(B,A,E){var C=this,D=C.selection;C.lastSelection=D;if(B){B=B.isCellContext?B:new Ext.grid.CellContext(C.primaryView).setPosition(B)}if(!E&&D){if(B&&(B.record===D.record&&B.columnHeader===D.columnHeader&&B.view===D.view)){B=null}else{C.onCellDeselect(C.selection,A)}}if(B){C.nextSelection=B;C.selecting=true;C.onCellSelect(C.nextSelection,A);C.selecting=false;return(C.selection=B)}return null},isCellSelected:function(D,C,E){var A=this,B,F=A.getCurrentPosition();if(F&&F.view===D){B=new Ext.grid.CellContext(D).setPosition({row:C,column:E});return(B.record===F.record)&&(B.columnHeader===F.columnHeader)}},onStoreRemove:function(A,B,E){var D=this,C=D.getCurrentPosition();D.callParent(arguments);if(C&&A.getCount()&&A.indexOf(C.record)!==-1){D.setCurrentPosition({row:C.record,column:C.columnHeader},true,true)}else{D.selection=null}},onStoreClear:function(){this.callParent(arguments);this.selection=null},onStoreAdd:function(){var B=this,A=B.getCurrentPosition();B.callParent(arguments);if(A){B.setCurrentPosition({row:A.record,column:A.columnHeader},true,true)}else{B.selection=null}},onCellClick:function(A,H,D,G,F,E,B){var C;if(E!==-1){C=new Ext.grid.CellContext(A).setPosition({view:A,row:F,column:A.ownerCt.getColumnManager().getHeaderAtIndex(D)});this.setCurrentPosition(C)}},onCellSelect:function(B,A){if(B&&B.row!==undefined&&B.row>-1){this.doSelect(B.record,false,A)}},onCellDeselect:function(B,A){if(B&&B.row!==undefined){this.doDeselect(B.record,A)}},onSelectChange:function(G,F,B,H){var E=this,D,C,A;if(F){D=E.nextSelection;C="select"}else{D=E.lastSelection||E.noSelection;C="deselect"}A=D.view||E.primaryView;if((B||E.fireEvent("before"+C,E,G,D.row,D.column))!==false&&H()!==false){if(F){if(!E.preventFocus){A.focusCell(D,true)}A.onCellSelect(D)}else{A.onCellDeselect(D);delete E.selection}if(!B){E.fireEvent(C,E,G,D.row,D.column)}}},onKeyTab:function(A,E){var C=this,B=C.getCurrentPosition(),D;if(B){D=B.view.editingPlugin;if(D&&C.wasEditing){C.onEditorTab(D,A)}else{C.move(A.shiftKey?"left":"right",A)}}},onEditorTab:function(B,C){var D=this,E=C.shiftKey?"left":"right",F=D.getCurrentPosition(),A=F.view.walkCells(F,E,C,D.preventWrap);if(A){if(B.startEdit(A.record,A.columnHeader)){D.wasEditing=false}else{D.setCurrentPosition(A);D.wasEditing=true}}},refresh:function(){var B=this.getCurrentPosition(),A;if(B&&(A=this.store.indexOf(this.selected.last()))!==-1){B.row=A}},onColumnMove:function(C,B,A,D){var E=C.up("tablepanel");if(E){this.onViewRefresh(E.view)}},onUpdate:function(C){var A=this,B;if(A.isSelected(C)){B=A.selecting?A.nextSelection:A.selection;A.view.onCellSelect(B)}},onViewRefresh:function(C){var A=this,B=A.getCurrentPosition(),F,D=C.headerCt,E,G;if(B&&B.view===C){E=B.record;G=B.columnHeader;if(!G.isDescendantOf(D)){G=D.queryById(G.id)||D.down('[text="'+G.text+'"]')||D.down('[dataIndex="'+G.dataIndex+'"]')}if(B.record){if(G&&(C.store.indexOfId(E.getId())!==-1)){F=new Ext.grid.CellContext(C).setPosition({row:E,column:G});A.setCurrentPosition(F)}}else{A.selection=null}}},selectByPosition:function(B,A){this.setCurrentPosition(B,A)}});
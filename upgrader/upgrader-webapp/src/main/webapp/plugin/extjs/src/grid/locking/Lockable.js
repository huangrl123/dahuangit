Ext.define("Ext.grid.locking.Lockable",{alternateClassName:"Ext.grid.Lockable",requires:["Ext.grid.locking.View","Ext.grid.header.Container","Ext.grid.locking.HeaderContainer","Ext.view.Table"],supportsOverflowX:"overflow-x" in document.documentElement.style,syncRowHeight:true,headerCounter:0,scrollDelta:40,lockedGridCls:Ext.baseCSSPrefix+"grid-inner-locked",normalGridCls:Ext.baseCSSPrefix+"grid-inner-normal",unlockText:"Unlock",lockText:"Lock",bothCfgCopy:["invalidateScrollerOnRefresh","hideHeaders","enableColumnHide","enableColumnMove","enableColumnResize","sortableColumns","multiColumnSort","columnLines","rowLines","variableRowHeight","numFromEdge","trailingBufferZone","leadingBufferZone","scrollToLoadBuffer"],normalCfgCopy:["verticalScroller","verticalScrollDock","verticalScrollerType","scroll"],lockedCfgCopy:[],determineXTypeToCreate:function(F){var D=this,B,E,C,A,G;if(D.subGridXType){B=D.subGridXType}else{if(!F){return"gridpanel"}E=this.getXTypes().split("/");C=E.length;A=E[C-1];G=E[C-2];if(G!=="tablepanel"){B=G}else{B=A}}return B},injectLockable:function(){this.lockable=true;this.hasView=true;var G=this,C=Ext.getScrollbarSize().height,I=G.store=Ext.StoreManager.lookup(G.store),K=G.getSelectionModel(),F,H,Q,B,R,L,P,J,N,O,A,E=G.viewConfig,S=E&&E.loadMask,M=(S!==undefined)?S:G.loadMask,D=G.findPlugin("bufferedrenderer");F=G.constructLockableFeatures();G.features=null;H=G.constructLockablePlugins();G.plugins=H.topPlugins;Q=Ext.apply({id:G.id+"-locked",isLocked:true,ownerGrid:G,ownerLockable:G,xtype:G.determineXTypeToCreate(true),store:I,scrollerOwner:false,animate:false,scroll:C?false:"vertical",selModel:K,border:false,cls:G.lockedGridCls,isLayoutRoot:function(){return this.floatedFromCollapse||G.normalGrid.floatedFromCollapse},features:F.lockedFeatures,plugins:H.lockedPlugins},G.lockedGridConfig);B=Ext.apply({id:G.id+"-normal",isLocked:false,ownerGrid:G,ownerLockable:G,xtype:G.determineXTypeToCreate(),store:I,scrollerOwner:false,selModel:K,border:false,cls:G.normalGridCls,isLayoutRoot:function(){return this.floatedFromCollapse||G.lockedGrid.floatedFromCollapse},features:F.normalFeatures,plugins:H.normalPlugins},G.normalGridConfig);G.addCls(Ext.baseCSSPrefix+"grid-locked");Ext.copyTo(B,G,G.bothCfgCopy,true);Ext.copyTo(Q,G,G.bothCfgCopy,true);Ext.copyTo(B,G,G.normalCfgCopy,true);Ext.copyTo(Q,G,G.lockedCfgCopy,true);for(R=0;R<G.normalCfgCopy.length;R++){delete G[G.normalCfgCopy[R]]}for(R=0;R<G.lockedCfgCopy.length;R++){delete G[G.lockedCfgCopy[R]]}G.addStateEvents(["lockcolumn","unlockcolumn"]);L=G.processColumns(G.columns,Q);Q.columns=L.locked;if(!Q.columns.items.length){Q.hidden=true}B.columns=L.normal;B.flex=1;Q.viewConfig=G.lockedViewConfig||{};B.viewConfig=G.normalViewConfig||{};Q.viewConfig.loadingUseMsg=false;Q.viewConfig.loadMask=false;if(C&&!G.supportsOverflowX){Q.viewConfig.style="border-bottom:"+C+"px solid #f6f6f6;"+(Q.viewConfig.style||"");B.viewConfig.style="border-bottom:"+C+"px solid #f6f6f6;"+(Q.viewConfig.style||"")}B.viewConfig.loadMask=false;if(E&&E.id){Ext.log.warn('id specified on Lockable viewConfig, it will be shared between both views: "'+E.id+'"')}Ext.applyIf(Q.viewConfig,E);Ext.applyIf(B.viewConfig,E);if(!G.initialConfig.layout){G.layout={type:"hbox",align:"stretch"}}G.getLayout();if(G.layout.type==="border"){if(G.split){Q.split=true}if(!B.title){Q.header=false}if(!Q.region){Q.region="west"}if(!B.region){B.region="center"}G.addCls(Ext.baseCSSPrefix+"grid-locked-split")}if(!(G.layout instanceof Ext.layout.container.Box)){G.split=false}G.view=new Ext.grid.locking.View({loadMask:M,locked:Q,normal:B,panel:G});N=G.lockedGrid.getView();O=G.normalGrid.getView();A=D?{}:{scroll:G.onLockedViewScroll,scope:G};if(C){G.lockedGrid.on({afterlayout:G.afterLockedViewLayout,scope:G});N.getOverflowStyle();if(!N.scrollFlags.y){A.mousewheel={fn:G.onLockedViewMouseWheel,element:"el",scope:G}}}N.on(A);A=D?{}:{scroll:G.onNormalViewScroll,scope:G};O.on(A);P=G.lockedGrid.headerCt;J=G.normalGrid.headerCt;G.headerCt=G.view.headerCt=new Ext.grid.locking.HeaderContainer(G);P.lockedCt=true;P.lockableInjected=true;J.lockableInjected=true;P.on({add:{buffer:1,scope:G,fn:G.onLockedHeaderAdd},columnshow:G.onLockedHeaderShow,columnhide:G.onLockedHeaderHide,sortchange:G.onLockedHeaderSortChange,columnresize:G.onLockedHeaderResize,scope:G});J.on({sortchange:G.onNormalHeaderSortChange,scope:G});G.modifyHeaderCt();G.items=[G.lockedGrid];if(G.split){G.addCls(Ext.baseCSSPrefix+"grid-locked-split");G.items[1]={xtype:"splitter"}}G.items.push(G.normalGrid);G.relayHeaderCtEvents(P);G.relayHeaderCtEvents(J);G.storeRelayers=G.relayEvents(I,["filterchange","groupchange"]);G.gridRelayers=G.relayEvents(G.normalGrid,["viewready"])},getLockingViewConfig:function(){return{xclass:"Ext.grid.locking.View",locked:this.lockedGrid,normal:this.normalGrid,panel:this}},processColumns:function(F,G){var I=this,H,J,D,N=new Ext.grid.header.Container(),K=[],B=[],L={itemId:"lockedHeaderCt",stretchMaxPartner:"^^>>#normalHeaderCt",items:K},E={itemId:"normalHeaderCt",stretchMaxPartner:"^^>>#lockedHeaderCt",items:B},C={lockedWidth:G.width||0,locked:L,normal:E},M=I.shrinkWrapLocked=!(G.width||G.flex),A;if(Ext.isObject(F)){Ext.applyIf(L,F);Ext.applyIf(E,F);A=Ext.apply({},F);delete A.items;Ext.apply(N,A);F=F.items}for(H=0,J=F.length;H<J;++H){D=F[H];if(!D.isComponent){D=N.lookupComponent(N.applyDefaults(D))}D.processed=true;if(D.locked||D.autoLock){if(M&&!D.hidden){C.lockedWidth+=I.getColumnWidth(D)||N.defaultWidth}K.push(D)}else{B.push(D)}if(!D.headerId){D.headerId=(D.initialConfig||D).id||("h"+(++I.headerCounter))}}I.fireEvent("processcolumns",I,K,B);N.destroy();if(M){G.width=(C.lockedWidth+=Ext.num(I.getSelectionModel().headerWidth,0)+(K.length?1:0))}return C},getColumnWidth:function(E){var B=E.width||0,C,D,A;if(E.flex){Ext.Error.raise("Locked columns in an unsized locked side do NOT support a flex width. You must set a width on the "+E.text+"column.")}if(!B&&E.isGroupHeader){C=E.items.items;D=C.length;for(A=0;A<D;A++){B+=this.getColumnWidth(C[A])}}return B},afterLockedViewLayout:function(){var E=this,A=E.lockedGrid.getView(),D=E.normalGrid.getView(),C=A.el,H=D.el,G=Ext.getScrollbarSize().height,F=(A.scrollFlags.x&&E.lockedGrid.headerCt.tooNarrow?G:0),B=(D.scrollFlags.x&&E.normalGrid.headerCt.tooNarrow?G:0);if(F!==B){if(F){if(E.supportsOverflowX){H.dom.style.overflowX="scroll";A.getOverflowEl().setStyle(A.getOverflowStyle())}else{H.dom.style.borderBottomWidth=F+"px";C.dom.style.borderBottomWidth="0px"}}else{if(E.supportsOverflowX){C.dom.style.overflowX="scroll";D.getOverflowEl().setStyle(D.getOverflowStyle())}else{C.dom.style.borderBottomWidth=B+"px";H.dom.style.borderBottomWidth="0px"}}}else{if(E.supportsOverflowX){A.getOverflowEl().dom.style.overflowX=B?"scroll":"";D.getOverflowEl().setStyle(D.getOverflowStyle())}else{H.dom.style.borderBottomWidth=C.dom.style.borderBottomWidth="0px"}}},onLockedViewMouseWheel:function(A){var G=this,B=-G.scrollDelta*A.getWheelDeltas().y,H=G.lockedGrid.getView(),C=H.el.dom,F,D,E;if(!G.ignoreMousewheel){if(C){F=H.getScrollY();D=F!==C.scrollHeight-C.clientHeight;E=F!==0}if((B<0&&E)||(B>0&&D)){A.stopEvent();F+=B;H.setScrollY(F);G.normalGrid.getView().setScrollY(F);G.onNormalViewScroll()}}},onLockedViewScroll:function(){var E=this,A=E.lockedGrid.getView(),C=E.normalGrid.getView(),F=A.getScrollY(),B=C.getScrollY(),D,G;if(B!==F){C.setScrollY(F);if(C.bufferedRenderer){G=A.body.dom;D=C.body.dom;D.style.position="absolute";D.style.top=G.style.top}}},onNormalViewScroll:function(){var D=this,A=D.lockedGrid.getView(),C=D.normalGrid.getView(),E=A.getScrollY(),B=C.getScrollY(),F;if(B!==E){A.setScrollY(B);if(C.bufferedRenderer){F=A.body;if(F.dom){F.dom.style.position="absolute";F.translate(null,C.bufferedRenderer.bodyTop)}}}},syncRowHeights:function(){var H=this,G,A=H.lockedGrid.getView(),F=H.normalGrid.getView(),D=A.all.slice(),B=F.all.slice(),C=D.length,E;if(B.length===C){for(G=0;G<C;G++){F.syncRowHeights(D[G],B[G])}E=F.getScrollY();F.setScrollY(E);A.setScrollY(E)}},modifyHeaderCt:function(){var A=this;A.lockedGrid.headerCt.getMenuItems=A.getMenuItems(A.lockedGrid.headerCt.getMenuItems,true);A.normalGrid.headerCt.getMenuItems=A.getMenuItems(A.normalGrid.headerCt.getMenuItems,false);A.lockedGrid.headerCt.showMenuBy=Ext.Function.createInterceptor(A.lockedGrid.headerCt.showMenuBy,A.showMenuBy);A.normalGrid.headerCt.showMenuBy=Ext.Function.createInterceptor(A.normalGrid.headerCt.showMenuBy,A.showMenuBy)},onUnlockMenuClick:function(){this.unlock()},onLockMenuClick:function(){this.lock()},showMenuBy:function(D,C){var F=this.getMenu(),E=F.down("#unlockItem"),A=F.down("#lockItem"),B=E.prev();if(C.lockable===false){B.hide();E.hide();A.hide()}else{B.show();E.show();A.show();if(!E.initialConfig.disabled){E.setDisabled(C.lockable===false)}if(!A.initialConfig.disabled){A.setDisabled(!C.isLockable())}}},getMenuItems:function(H,G){var A=this,C=A.unlockText,F=A.lockText,B=Ext.baseCSSPrefix+"hmenu-unlock",D=Ext.baseCSSPrefix+"hmenu-lock",E=A.onUnlockMenuClick.bind(A),I=A.onLockMenuClick.bind(A);return function(){var J=H.call(this);J.push("-",{itemId:"unlockItem",iconCls:B,text:C,handler:E,disabled:!G});J.push({itemId:"lockItem",iconCls:D,text:F,handler:I,disabled:G});return J}},syncLockedWidth:function(){var E=this,G=E.lockedGrid,A=G.view,D=A.el.dom,F=E.normalGrid,C=G.headerCt.getVisibleGridColumns().length,B=F.headerCt.getVisibleGridColumns().length;Ext.suspendLayouts();if(B){F.show();if(C){if(E.shrinkWrapLocked&&!G.headerCt.forceFit){delete G.flex;G.setWidth(G.headerCt.getTableWidth()+G.el.getBorderWidth("lr"))}G.addCls(E.lockedGridCls);G.show();if(E.split){E.child("splitter").show()}}else{G.getView().clearViewEl();G.hide();if(E.split){E.child("splitter").hide()}}A.el.setStyle(A.getOverflowStyle());E.ignoreMousewheel=A.scrollFlags.y}else{F.hide();D.style.borderBottomWidth="0";G.flex=1;delete G.width;G.removeCls(E.lockedGridCls);G.show();A.el.setStyle(F.view.getOverflowStyle());E.ignoreMousewheel=true}Ext.resumeLayouts(true);return[C,B]},onLockedHeaderAdd:function(){if(!this.ignoreAddLockedColumn){this.syncLockedWidth()}},onLockedHeaderResize:function(){this.syncLockedWidth()},onLockedHeaderHide:function(){this.syncLockedWidth()},onLockedHeaderShow:function(){this.syncLockedWidth()},onLockedHeaderSortChange:Ext.emptyFn,onNormalHeaderSortChange:Ext.emptyFn,lock:function(H,B,C){var I=this,F=I.normalGrid,E=I.lockedGrid,G=F.view,A=E.view,D=F.headerCt,J,K;H=H||D.getMenu().activeHeader;C=C||E.headerCt;K=H.ownerCt;if(!H.isLockable()){return}if(H.flex){H.width=H.getWidth();H.flex=null}Ext.suspendLayouts();G.blockRefresh=A.blockRefresh=true;K.remove(H,false);H.locked=true;I.ignoreAddLockedColumn=true;if(Ext.isDefined(B)){C.insert(B,H)}else{C.add(H)}I.ignoreAddLockedColumn=false;G.blockRefresh=A.blockRefresh=false;J=I.syncLockedWidth();if(J[0]){E.getView().refreshView()}if(J[1]){F.getView().refreshView()}Ext.resumeLayouts(true);I.fireEvent("lockcolumn",I,H)},unlock:function(G,B,C){var H=this,E=H.normalGrid,D=H.lockedGrid,F=E.view,A=D.view,J=D.headerCt,I;if(!Ext.isDefined(B)){B=0}G=G||J.getMenu().activeHeader;C=C||E.headerCt;Ext.suspendLayouts();F.blockRefresh=A.blockRefresh=true;G.ownerCt.remove(G,false);G.locked=false;C.insert(B,G);F.blockRefresh=A.blockRefresh=false;I=H.syncLockedWidth();if(I[0]){D.getView().refreshView()}if(I[1]){E.getView().refreshView()}Ext.resumeLayouts(true);H.fireEvent("unlockcolumn",H,G)},reconfigureLockable:function(B,G){var C=this,D=C.store,E=C.lockedGrid,F=C.normalGrid,A;Ext.suspendLayouts();if(G){E.reconfiguring=F.reconfiguring=true;E.headerCt.removeAll();F.headerCt.removeAll();G=C.processColumns(G,E);C.ignoreAddLockedColumn=true;E.headerCt.add(G.locked.items);C.ignoreAddLockedColumn=false;F.headerCt.add(G.normal.items);E.reconfiguring=F.reconfiguring=false;C.syncLockedWidth()}if(B&&B!==D){B=Ext.data.StoreManager.lookup(B);C.store=B;E.bindStore(B);A=E.view;A.store=B;if(!A.dataSource.isFeatureStore){A.dataSource=B}F.bindStore(B);A=F.view;A.store=B;if(!A.dataSource.isFeatureStore){A.dataSource=B}C.view.store=B;C.view.bindStore(B,false,"dataSource")}else{E.getView().refreshView();F.getView().refreshView()}Ext.resumeLayouts(true)},constructLockableFeatures:function(){var A=this.features,B,F,D,G,C=0,E;if(A){if(!Ext.isArray(A)){A=[A]}D=[];G=[];E=A.length;for(;C<E;C++){B=A[C];if(!B.isFeature){B=Ext.create("feature."+B.ftype,B)}switch(B.lockableScope){case"locked":D.push(B);break;case"normal":G.push(B);break;default:B.lockableScope="both";D.push(B);G.push(F=B.clone());F.lockingPartner=B;B.lockingPartner=F}}}return{normalFeatures:G,lockedFeatures:D}},constructLockablePlugins:function(){var K=this.plugins,D,J,I,E,F,C,G=0,A,B,H;if(K){if(!Ext.isArray(K)){K=[K]}E=[];F=[];C=[];A=K.length;for(;G<A;G++){D=K[G];if(D.init){B=D.lockableScope}else{H=D.ptype?Ext.ClassManager.getByAlias(("plugin."+D.ptype)):Ext.ClassManager.get(D.xclass);B=H.prototype.lockableScope}switch(B){case"both":F.push(I=D.clonePlugin());C.push(J=D.clonePlugin());I.lockingPartner=J;J.lockingPartner=I;Ext.destroy(D);break;case"locked":F.push(D);break;case"normal":C.push(D);break;default:E.push(D)}}}return{topPlugins:E,normalPlugins:C,lockedPlugins:F}},destroyLockable:function(){Ext.destroy(this.view,this.headerCt)}},function(){this.borrow(Ext.Component,["constructPlugin"])});
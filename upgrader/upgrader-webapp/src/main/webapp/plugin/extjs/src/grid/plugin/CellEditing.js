Ext.define("Ext.grid.plugin.CellEditing",{alias:"plugin.cellediting",extend:"Ext.grid.plugin.Editing",requires:["Ext.grid.CellEditor","Ext.util.DelayedTask"],lockableScope:"both",init:function(C){var A=this,B=A.lockingPartner;A.callParent(arguments);if(B){if(B.editors){A.editors=B.editors}else{A.editors=B.editors=new Ext.util.MixedCollection(false,function(D){return D.editorId})}}else{A.editors=new Ext.util.MixedCollection(false,function(D){return D.editorId})}},beforeGridHeaderDestroy:function(C){var B=this,G=B.grid.getColumnManager().getColumns(),D=G.length,A,F,E;for(A=0;A<D;A++){F=G[A];E=B.editors.getByKey(F.getItemId());if(!E&&F.hasEditor&&F.hasEditor()){E=F.getEditor()}Ext.destroy(E);B.removeFieldAccessors(F)}},onReconfigure:function(C,A,B){if(B){this.editors.clear()}this.callParent()},destroy:function(){var A=this;if(A.editors){A.editors.each(Ext.destroy,Ext);A.editors.clear()}A.callParent(arguments)},initCancelTriggers:function(){var A=this,C=A.grid,B=C.view;A.mon(C,{columnresize:A.cancelEdit,columnmove:A.cancelEdit,scope:A})},isCellEditable:function(C,D){var B=this,A=B.getEditingContext(C,D);if(B.grid.view.isVisible(true)&&A){D=A.column;C=A.record;if(D&&B.getEditor(C,D)){return true}}},startEdit:function(E,G,B){var F=this,D,C,A;if(!B){F.preventBeforeCheck=true;B=F.callParent(arguments);delete F.preventBeforeCheck;if(B===false){return false}}if(B&&F.grid.view.isVisible(true)){E=B.record;G=B.column;B.originalValue=B.value=E.get(G.dataIndex);C=(G&&G.getEditor(E))&&!(F.beforeEdit(B)===false||F.fireEvent("beforeedit",F,B)===false||B.cancel);if(C){A=F.getEditor(E,G);D=A.editing}else{return false}F.completeEdit(D);F.context=B;F.grid.view.cancelFocus();F.view.scrollCellIntoView(F.getCell(E,G));if(A){if(D){A.editing=false;if(Ext.isIE){A.selectSameEditor=true}}F.showEditor(A,B,B.value);return true}return false}},showEditor:function(B,D,E){var H=this,I=D.record,F=D.column,G=H.grid.getSelectionModel(),C=G.preventFocus,A=G.getCurrentPosition();if(!F.up(H.view.ownerCt)){return H.lockingPartner.showEditor(B,H.lockingPartner.getEditingContext(A.record,A.columnHeader),E)}H.setEditingContext(D);H.setActiveEditor(B);H.setActiveRecord(I);H.setActiveColumn(F);if(!A||!G.isCellSelected(H.view,I,F)){G.preventFocus=true;G.selectByPosition({row:I,column:F,view:H.view},true);G.preventFocus=C}if(Ext.isIE&&Ext.event.Event.type==="click"){Ext.Function.defer(B.startEdit,1,B,[H.getCell(I,F),E,D])}else{B.startEdit(H.getCell(I,F),E,D)}H.editing=true;H.scroll=H.view.el.getScroll()},completeEdit:function(B){var A=this.getActiveEditor();if(A){A.completeEdit(B);this.editing=false}},setEditingContext:function(A){this.context=A;if(this.lockingPartner){this.lockingPartner.context=A}},setActiveEditor:function(A){this.activeEditor=A;if(this.lockingPartner){this.lockingPartner.activeEditor=A}},getActiveEditor:function(){return this.activeEditor},setActiveColumn:function(A){this.activeColumn=A;if(this.lockingPartner){this.lockingPartner.activeColumn=A}},getActiveColumn:function(){return this.activeColumn},setActiveRecord:function(A){this.activeRecord=A;if(this.lockingPartner){this.lockingPartner.activeRecord=A}},getActiveRecord:function(){return this.activeRecord},getEditor:function(D,G){var B=this,C=B.editors,E=G.getItemId(),F=C.getByKey(E),A=B.grid.ownerLockable||B.grid;if(!F){F=G.getEditor(D);if(!F){return false}if(F instanceof Ext.grid.CellEditor){F.floating=true}else{F=new Ext.grid.CellEditor({floating:true,editorId:E,field:F})}F.field.excludeForm=true;if(F.ownerCt!==A){A.add(F);F.on({scope:B,specialkey:B.onSpecialKey,complete:B.onEditComplete,canceledit:B.cancelEdit});G.on("removed",B.onColumnRemoved,B)}C.add(F)}if(G.isTreeColumn){F.isForTree=G.isTreeColumn;F.addCls(Ext.baseCSSPrefix+"tree-cell-editor")}F.setGrid(B.grid);F.editingPlugin=B;return F},onColumnRemoved:function(E){var C=this,B=C.context,D,A=C.grid.ownerLockable||C.grid;if(B&&B.column===E){C.cancelEdit()}E.un("removed",C.onColumnRemoved,C);if(E.getEditor&&(D=E.getEditor())&&D.ownerCt===A){A.remove(D);D.un({scope:C,specialkey:C.onSpecialKey,complete:C.onEditComplete,canceledit:C.cancelEdit})}},setColumnField:function(C,B){var A=this.editors.getByKey(C.getItemId());Ext.destroy(A,C.field);this.editors.removeAtKey(C.getItemId());this.callParent(arguments)},getCell:function(A,B){return this.grid.getView().getCell(A,B)},onSpecialKey:function(A,D,B){var C;if(B.getKey()===B.TAB){B.stopEvent();if(A){A.onEditorTab(B)}C=A.up("tablepanel").getSelectionModel();if(C.onEditorTab){return C.onEditorTab(A.editingPlugin,B)}}},onEditComplete:function(A,F,C){var D=this,E=D.getActiveColumn(),B=D.context,G;if(E){G=B.record;D.setActiveEditor(null);D.setActiveColumn(null);D.setActiveRecord(null);B.value=F;if(!D.validateEdit()){D.editing=false;return}if(!G.isEqual(F,C)){G.set(E.dataIndex,F)}B.view.focusRow(B.rowIdx,100);D.fireEvent("edit",D,B);D.editing=false}},cancelEdit:function(){var B=this,A=B.context,C=B.getActiveEditor();B.setActiveEditor(null);B.setActiveColumn(null);B.setActiveRecord(null);if(C){if(C.field){B.context.value=("editedValue" in C)?C.editedValue:C.getValue();C.cancelEdit()}A.view.focusRow(A.rowIdx,100);B.callParent(arguments);return}return true},startEditByPosition:function(B){var D=this.grid.getColumnManager(),C,A;if(!B.isCellContext){B=new Ext.grid.CellContext(this.view).setPosition(B)}C=D.getHeaderIndex(B.columnHeader);B.setColumn(D.getVisibleHeaderClosestToIndex(C));return this.startEdit(B.record,B.columnHeader)}});
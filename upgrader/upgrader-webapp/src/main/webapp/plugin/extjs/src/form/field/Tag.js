Ext.define("Ext.form.field.Tag",{extend:"Ext.form.field.ComboBox",requires:["Ext.selection.Model","Ext.data.Store"],xtype:"tagfield",multiSelect:true,forceSelection:true,createNewOnEnter:false,createNewOnBlur:false,encodeSubmitValue:false,triggerOnClick:true,stacked:false,pinList:true,filterPickList:false,selectOnFocus:true,grow:true,growMin:false,growMax:false,fieldSubTpl:['<div id="{cmpId}-listWrapper" data-ref="listWrapper" class="'+Ext.baseCSSPrefix+'tagfield {fieldCls} {typeCls} {typeCls}-{ui}">','<ul id="{cmpId}-itemList" data-ref="itemList" class="'+Ext.baseCSSPrefix+'tagfield-list">','<li id="{cmpId}-inputElCt" data-ref="inputElCt" class="'+Ext.baseCSSPrefix+'tagfield-input">','<div id="{cmpId}-emptyEl" data-ref="emptyEl" class="{emptyCls}">{emptyText}</div>','<input id="{cmpId}-inputEl" data-ref="inputEl" type="{type}" ','<tpl if="name">name="{name}" </tpl>','<tpl if="value"> value="{[Ext.util.Format.htmlEncode(values.value)]}"</tpl>','<tpl if="size">size="{size}" </tpl>','<tpl if="tabIdx">tabIndex="{tabIdx}" </tpl>','<tpl if="disabled"> disabled="disabled"</tpl>','class="'+Ext.baseCSSPrefix+'tagfield-input-field {inputElCls}" autocomplete="off">',"</li>","</ul>","</div>",{disableFormats:true}],childEls:["listWrapper","itemList","inputEl","inputElCt","emptyEl"],emptyInputCls:Ext.baseCSSPrefix+"tagfield-emptyinput",initComponent:function(){var B=this,A=B.typeAhead;if(A&&!B.editable){Ext.Error.raise("If typeAhead is enabled the combo must be editable: true -- please change one of those settings.")}B.typeAhead=false;B.listConfig=Ext.apply({refreshSelmodelOnRefresh:false},B.listConfig);B.callParent();B.typeAhead=A;B.selectionModel=new Ext.selection.Model({store:B.valueStore,mode:"MULTI",lastFocused:null,onSelectChange:function(E,C,D,F){F()}});if(!Ext.isEmpty(B.delimiter)&&B.multiSelect){B.delimiterRegexp=new RegExp(String(B.delimiter).replace(/[$%()*+.?\[\\\]{|}]/g,"\\$&"))}},initEvents:function(){var A=this;A.callParent(arguments);if(!A.enableKeyEvents){A.mon(A.inputEl,"keydown",A.onKeyDown,A)}A.mon(A.inputEl,"paste",A.onPaste,A);A.mon(A.listWrapper,"click",A.onItemListClick,A);A.mon(A.selectionModel,{"selectionchange":A.onSelectionChange,"focuschange":A.onFocusChange,scope:A})},onBindStore:function(A){var B=this;if(A){B.valueStore=new Ext.data.Store({model:A.getModel()});B.mon(B.valueStore,{datachanged:B.onValueStoreChange,remove:B.onValueStoreRemove,scope:B});if(B.selectionModel){B.selectionModel.bindStore(B.valueStore)}B.store.addFilter(B.selectedFilter=new Ext.util.Filter({filterFn:function(C){return !B.valueStore.data.contains(C)},disabled:!B.filterPickList}))}},onUnbindStore:function(A){var C=this,B=C.valueStore;if(B){C.mun(B,{datachanged:C.onValueStoreChange,remove:C.onValueStoreRemove,scope:C});B.destroy()}if(C.selectionModel){C.selectionModel.destroy()}C.store.removeFilter(C.selectedFilter);C.valueStore=C.selectionModel=null;C.callParent(arguments)},onValueStoreRemove:function(){if(this.filterPickList){this.store.filter()}},onValueStoreChange:function(){if(this.filterPickList){this.store.filter()}this.applyMultiselectItemMarkup()},onSelectionChange:function(B,A){this.applyMultiselectItemMarkup();this.fireEvent("valueselectionchange",this,A)},onFocusChange:function(C,B,A){this.fireEvent("valuefocuschange",this,B,A)},createPicker:function(){var A=this,B=A.callParent(arguments);A.mon(B,{"beforerefresh":A.onBeforeListRefresh,scope:A});return B},onDestroy:function(){var A=this;Ext.destroyMembers(A,"valueStore","selectionModel");A.callParent(arguments)},getSubTplData:function(){var B=this,C=B.callParent(),A=B.emptyText&&C.value.length<1;C.value="";if(A){C.emptyText=B.emptyText;C.emptyCls=B.emptyCls;C.inputElCls=B.emptyInputCls}else{C.emptyText="";C.emptyCls=B.emptyInputCls;C.inputElCls=""}return C},afterRender:function(){var A=this;if(Ext.supports.Placeholder&&A.inputEl&&A.emptyText){delete A.inputEl.dom.placeholder}A.bodyEl.applyStyles("vertical-align:top");if(A.grow){if(Ext.isNumber(A.growMin)&&(A.growMin>0)){A.listWrapper.applyStyles("min-height:"+A.growMin+"px")}if(Ext.isNumber(A.growMax)&&(A.growMax>0)){A.listWrapper.applyStyles("max-height:"+A.growMax+"px")}}if(A.stacked===true){A.itemList.addCls(Ext.baseCSSPrefix+"tagfield-stacked")}if(!A.multiSelect){A.itemList.addCls(Ext.baseCSSPrefix+"tagfield-singleselect")}A.applyMultiselectItemMarkup();A.callParent(arguments)},findRecord:function(C,A){var B=this.store,D;if(!B){return false}D=B.queryBy(function(E){return E.isEqual(E.get(C),A)});return(D.getCount()>0)?D.first():false},onLoad:function(){var C=this,B=C.valueField,A=C.valueStore,D=false;if(A){if(!Ext.isEmpty(C.value)&&(A.getCount()==0)){C.setValue(C.value,false,true)}A.suspendEvents();A.each(function(E){var F=C.findRecord(B,E.get(B)),G=F?A.indexOf(E):-1;if(G>=0){A.removeAt(G);A.insert(G,F);D=true}});A.resumeEvents();if(D){A.fireEvent("datachanged",A)}}C.callParent(arguments)},isFilteredRecord:function(D){var A=this,E=A.store,C=A.valueField,B,F=false;B=E.findExact(C,D.get(C));F=((B===-1)&&(!E.snapshot||(A.findRecord(C,D.get(C))!==false)));F=F||(!F&&(B===-1)&&(A.forceSelection!==true)&&(A.valueStore.findExact(C,D.get(C))>=0));return F},doRawQuery:function(){var B=this,A=B.inputEl.dom.value;if(B.multiSelect){A=A.split(B.delimiter).pop()}B.doQuery(A,false,true)},onBeforeListRefresh:function(){this.ignoreSelection++},onListRefresh:function(){this.callParent(arguments);if(this.ignoreSelection>0){--this.ignoreSelection}},onListSelectionChange:function(E,F){var D=this,C=D.valueStore,A=[],B;if((D.ignoreSelection<=0)&&D.isExpanded){C.each(function(G){if(Ext.Array.contains(F,G)||D.isFilteredRecord(G)){A.push(G)}});A=Ext.Array.merge(A,F);B=Ext.Array.intersect(A,C.getRange()).length;if((B!=A.length)||(B!=D.valueStore.getCount())){D.setValue(A,false);if(!D.multiSelect||!D.pinList){Ext.defer(D.collapse,1,D)}if(C.getCount()>0){D.fireEvent("select",D,C.getRange())}}if(!D.pinList){D.inputEl.dom.value=""}if(!Ext.supports.TouchEvents){D.inputEl.focus();if(D.selectOnFocus){D.inputEl.dom.select()}}}},syncSelection:function(){var C=this,D=C.picker,B=C.valueField,A,E,F;if(D){A=D.store;E=[];if(C.valueStore){C.valueStore.each(function(G){var H=A.findExact(B,G.get(B));if(H>=0){E.push(A.getAt(H))}})}C.ignoreSelection++;F=D.getSelectionModel();F.deselectAll();if(E.length>0){F.select(E)}if(C.ignoreSelection>0){--C.ignoreSelection}}},getCursorPosition:function(){var A;if(Ext.isIE){A=document.selection.createRange();A.collapse(true);A.moveStart("character",-this.inputEl.dom.value.length);A=A.text.length}else{A=this.inputEl.dom.selectionStart}return A},hasSelectedText:function(){var A,B;if(Ext.isIE){A=document.selection;B=A.createRange();return(B.parentElement()==this.inputEl.dom)}else{return this.inputEl.dom.selectionStart!=this.inputEl.dom.selectionEnd}},onKeyDown:function(B,C){var H=this,F=B.getKey(),D=H.inputEl.dom.value,I=H.valueStore,A=H.selectionModel,E=false;if(H.readOnly||H.disabled||!H.editable){return}if(H.isExpanded&&(F==B.A&&B.ctrlKey)){H.select(H.getStore().getRange());A.setLastFocused(null);A.deselectAll();H.collapse();H.inputEl.focus();E=true}else{if((I.getCount()>0)&&((D=="")||((H.getCursorPosition()===0)&&!H.hasSelectedText()))){var G=(A.getCount()>0)?I.indexOf(A.getLastSelected()||A.getLastFocused()):-1;if((F==B.BACKSPACE)||(F==B.DELETE)){if(G>-1){if(A.getCount()>1){G=-1}H.valueStore.remove(A.getSelection())}else{H.valueStore.remove(H.valueStore.last())}A.clearSelections();H.setValue(H.valueStore.getRange());if(G>0){A.select(G-1)}E=true}else{if((F==B.RIGHT)||(F==B.LEFT)){if((G==-1)&&(F==B.LEFT)){A.select(I.last());E=true}else{if(G>-1){if(F==B.RIGHT){if(G<(I.getCount()-1)){A.select(G+1,B.shiftKey);E=true}else{if(!B.shiftKey){A.setLastFocused(null);A.deselectAll();E=true}}}else{if((F==B.LEFT)&&(G>0)){A.select(G-1,B.shiftKey);E=true}}}}}else{if(F==B.A&&B.ctrlKey){A.selectAll();E=B.A}}}H.inputEl.focus()}}if(E){H.preventKeyUpEvent=E;B.stopEvent();return}if(H.isExpanded&&(F==B.ENTER)&&H.picker.highlightedItem){H.preventKeyUpEvent=true}if(H.enableKeyEvents){H.callParent(arguments)}if(!B.isSpecialKey()&&!B.hasModifier()){H.selectionModel.setLastFocused(null);H.selectionModel.deselectAll();H.inputEl.focus()}},onKeyUp:function(B,D){var C=this,A=C.inputEl.dom.value;if(C.preventKeyUpEvent){B.stopEvent();if((C.preventKeyUpEvent===true)||(B.getKey()===C.preventKeyUpEvent)){delete C.preventKeyUpEvent}return}if(C.multiSelect&&(C.delimiterRegexp&&C.delimiterRegexp.test(A))||((C.createNewOnEnter===true)&&B.getKey()==B.ENTER)){A=Ext.Array.clean(A.split(C.delimiterRegexp));C.inputEl.dom.value="";C.setValue(C.valueStore.getRange().concat(A));C.inputEl.focus()}C.callParent([B,D])},onPaste:function(B){var D=this,A=D.inputEl.dom.value,C=(B&&B.browserEvent&&B.browserEvent.clipboardData)?B.browserEvent.clipboardData:false;if(D.multiSelect&&(D.delimiterRegexp&&D.delimiterRegexp.test(A))){if(C&&C.getData){if(/text\/plain/.test(C.types)){A=C.getData("text/plain")}else{if(/text\/html/.test(C.types)){A=C.getData("text/html")}}}A=Ext.Array.clean(A.split(D.delimiterRegexp));D.inputEl.dom.value="";D.setValue(D.valueStore.getRange().concat(A));D.inputEl.focus()}},onTypeAhead:function(){var E=this,C=E.displayField,H=E.inputEl.dom,A=E.getPicker(),G=E.store.findRecord(C,H.value),B,F,D;if(G){B=G.get(C);F=B.length;D=H.value.length;A.highlightItem(A.getNode(G));if(D!==0&&D!==F){H.value=B;E.selectText(D,B.length)}}},onItemListClick:function(A){var B=this,D=A.getTarget("."+Ext.baseCSSPrefix+"tagfield-item"),C=D?A.getTarget("."+Ext.baseCSSPrefix+"tagfield-item-close"):false;if(B.readOnly||B.disabled){return}A.stopPropagation();if(D){if(C){B.removeByListItemNode(D);if(B.valueStore.getCount()>0){B.fireEvent("select",B,B.valueStore.getRange())}}else{B.toggleSelectionByListItemNode(D,A.shiftKey)}if(!Ext.supports.TouchEvents){B.inputEl.focus()}}else{if(B.selectionModel.getCount()>0){B.selectionModel.setLastFocused(null);B.selectionModel.deselectAll()}if(B.triggerOnClick){B.onTriggerClick()}}},getMultiSelectItemMarkup:function(){var A=this;if(!A.multiSelectItemTpl){if(!A.labelTpl){A.labelTpl="{"+A.displayField+"}"}A.labelTpl=A.getTpl("labelTpl");A.multiSelectItemTpl=new Ext.XTemplate(['<tpl for=".">','<li class="    '+Ext.baseCSSPrefix+"tagfield-item ",'<tpl if="this.isSelected(values)">'," selected","</tpl>","{%","values = values.data;","%}",'" qtip="{'+A.displayField+'}">','<div class="'+Ext.baseCSSPrefix+'tagfield-item-text">{[this.getItemLabel(values)]}</div>','<div class="'+Ext.baseCSSPrefix+'tagfield-item-close"></div>',"</li>","</tpl>",{isSelected:function(B){return A.selectionModel.isSelected(B)},getItemLabel:function(B){return A.labelTpl.apply(B)}}])}if(!A.multiSelectItemTpl.isTemplate){A.multiSelectItemTpl=this.getTpl("multiSelectItemTpl")}return A.multiSelectItemTpl.apply(this.valueStore.getRange())},applyMultiselectItemMarkup:function(){var B=this,C=B.itemList,A;if(C){while((A=B.inputElCt.prev())!=null){A.destroy()}B.inputElCt.insertHtml("beforeBegin",B.getMultiSelectItemMarkup())}Ext.GlobalEvents.on({idle:function(){if(B.picker&&B.isExpanded){B.alignPicker()}if(B.hasFocus&&B.inputElCt&&B.listWrapper){B.inputElCt.scrollIntoView(B.listWrapper)}},single:true})},getRecordByListItemNode:function(D){var C=this,A=0,B=C.itemList.dom.firstChild;while(B&&B.nextSibling){if(B==D){break}A++;B=B.nextSibling}A=(B==D)?A:false;if(A===false){return false}return C.valueStore.getAt(A)},toggleSelectionByListItemNode:function(D,C){var B=this,A=B.getRecordByListItemNode(D),E=B.selectionModel;if(A){if(E.isSelected(A)){if(E.isFocused(A)){E.setLastFocused(null)}E.deselect(A)}else{E.select(A,C)}}},removeByListItemNode:function(C){var B=this,A=B.getRecordByListItemNode(C);if(A){B.valueStore.remove(A);B.setValue(B.valueStore.getRange())}},getRawValue:function(){var C=this,A=C.inputEl,B;C.inputEl=false;B=C.callParent(arguments);C.inputEl=A;return B},setRawValue:function(D){var C=this,A=C.inputEl,B;C.inputEl=false;B=C.callParent([D]);C.inputEl=A;return B},addValue:function(B){var A=this;if(B){A.setValue(Ext.Array.merge(A.value,Ext.Array.from(B)))}},removeValue:function(B){var A=this;if(B){A.setValue(Ext.Array.difference(A.value,Ext.Array.from(B)))}},setValue:function(D,L,F){var I=this,J=I.valueStore,H=I.valueField,B=[],K,C,E,G,A;if(Ext.isEmpty(D)){D=null}if(Ext.isString(D)&&I.multiSelect){D=D.split(I.delimiter)}D=Ext.Array.from(D,true);for(E=0,C=D.length;E<C;E++){K=D[E];if(!K||!K.isModel){G=J.findExact(H,K);if(G>=0){D[E]=J.getAt(G)}else{G=I.findRecord(H,K);if(!G){if(I.forceSelection){B.push(K)}else{G={};G[I.valueField]=K;G[I.displayField]=K;A=I.valueStore.getModel();G=new A(G)}}if(G){D[E]=G}}}}if((F!==true)&&(B.length>0)&&(I.queryMode==="remote")){var M={};M[I.valueParam||I.valueField]=B.join(I.delimiter);I.store.load({params:M,callback:function(){if(I.itemList){I.itemList.unmask()}I.setValue(D,L,true);I.autoSize();I.lastQuery=false}});return false}if(!I.multiSelect&&(D.length>0)){for(E=D.length-1;E>=0;E--){if(D[E].isModel){D=D[E];break}}if(Ext.isArray(D)){D=D[D.length-1]}}return I.callParent([D,L])},getValueRecords:function(){return this.valueStore.getRange()},getSubmitData:function(){var A=this,B=A.callParent(arguments);if(A.multiSelect&&A.encodeSubmitValue&&B&&B[A.name]){B[A.name]=Ext.encode(B[A.name])}return B},mimicBlur:function(){var A=this;if(A.selectOnTab&&A.picker&&A.picker.highlightedItem){A.inputEl.dom.value=""}A.callParent(arguments)},assertValue:function(){var C=this,B=C.inputEl.dom.value,A=!Ext.isEmpty(B)?C.findRecordByDisplay(B):false,D=false;if(!A&&!C.forceSelection&&C.createNewOnBlur&&!Ext.isEmpty(B)){D=B}else{if(A){D=A}}if(D){C.addValue(D)}C.inputEl.dom.value="";C.collapse()},checkChange:function(){if(!this.suspendCheckChange&&!this.isDestroyed){var D=this,C=D.valueStore,A=D.lastValue||"",E=D.valueField,F=Ext.Array.map(Ext.Array.from(D.value),function(G){if(G.isModel){return G.get(E)}return G},this).join(this.delimiter),B=D.isEqual(F,A);if(!B||((F.length>0&&C.getCount()<D.value.length))){C.suspendEvents();C.removeAll();if(Ext.isArray(D.valueModels)){C.add(D.valueModels)}C.resumeEvents();C.fireEvent("datachanged",C);if(!B){D.lastValue=F;D.fireEvent("change",D,F,A);D.onChange(F,A)}}}},isEqual:function(C,E){var H=Ext.Array.from,G=this.valueField,B,A,D,F;C=H(C);E=H(E);A=C.length;if(A!==E.length){return false}for(B=0;B<A;B++){D=C[B].isModel?C[B].get(G):C[B];F=E[B].isModel?E[B].get(G):E[B];if(D!==F){return false}}return true},applyEmptyText:function(){var C=this,D=C.emptyText,A,B;if(C.rendered&&D){B=Ext.isEmpty(C.value)&&!C.hasFocus;A=C.inputEl;if(B){A.dom.value="";C.emptyEl.setHtml(D);C.emptyEl.addCls(C.emptyCls);C.emptyEl.removeCls(C.emptyInputCls);C.listWrapper.addCls(C.emptyCls);C.inputEl.addCls(C.emptyInputCls)}else{C.emptyEl.addCls(C.emptyInputCls);C.emptyEl.removeCls(C.emptyCls);C.listWrapper.removeCls(C.emptyCls);C.inputEl.removeCls(C.emptyInputCls)}C.autoSize()}},preFocus:function(){var C=this,A=C.inputEl,B=(A.dom.value=="");C.emptyEl.addCls(C.emptyInputCls);C.emptyEl.removeCls(C.emptyCls);C.listWrapper.removeCls(C.emptyCls);C.inputEl.removeCls(C.emptyInputCls);if(C.selectOnFocus||B){A.dom.select()}},onFocus:function(){var B=this,A=B.focusCls,C=B.itemList;if(A&&C){C.addCls(A)}B.callParent(arguments)},onBlur:function(){var B=this,A=B.focusCls,C=B.itemList;if(A&&C){C.removeCls(A)}B.callParent(arguments)},renderActiveError:function(){var B=this,A=B.invalidCls,C=B.itemList,D=B.hasActiveError();if(A&&C){C[D?"addCls":"removeCls"](B.invalidCls+"-field")}B.callParent(arguments)},autoSize:function(){var A=this;if(A.grow&&A.rendered){A.autoSizing=true;A.updateLayout()}return A},afterComponentLayout:function(){var B=this,A;if(B.autoSizing){A=B.getHeight();if(A!==B.lastInputHeight){if(B.isExpanded){B.alignPicker()}B.fireEvent("autosize",B,A);B.lastInputHeight=A;B.autoSizing=false}}}});
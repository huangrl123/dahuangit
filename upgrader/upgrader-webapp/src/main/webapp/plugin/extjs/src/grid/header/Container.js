Ext.define("Ext.grid.header.Container",{extend:"Ext.container.Container",requires:["Ext.grid.ColumnLayout","Ext.grid.plugin.HeaderResizer","Ext.grid.plugin.HeaderReorderer"],uses:["Ext.grid.column.Column","Ext.grid.ColumnManager","Ext.menu.Menu","Ext.menu.CheckItem","Ext.menu.Separator"],border:true,alias:"widget.headercontainer",baseCls:Ext.baseCSSPrefix+"grid-header-ct",dock:"top",weight:100,defaultType:"gridcolumn",detachOnRemove:false,defaultWidth:100,sortAscText:"Sort Ascending",sortDescText:"Sort Descending",sortClearText:"Clear Sort",columnsText:"Columns",headerOpenCls:Ext.baseCSSPrefix+"column-header-open",menuSortAscCls:Ext.baseCSSPrefix+"hmenu-sort-asc",menuSortDescCls:Ext.baseCSSPrefix+"hmenu-sort-desc",menuColsIcon:Ext.baseCSSPrefix+"cols-icon",ddLock:false,dragging:false,sortable:true,enableColumnHide:true,initComponent:function(){var A=this;A.headerCounter=0;A.plugins=A.plugins||[];A.defaults=A.defaults||{};if(!A.isColumn){if(A.enableColumnResize){A.resizer=new Ext.grid.plugin.HeaderResizer();A.plugins.push(A.resizer)}if(A.enableColumnMove){A.reorderer=new Ext.grid.plugin.HeaderReorderer();A.plugins.push(A.reorderer)}}if(A.isColumn&&!A.isGroupHeader){if(!A.items||A.items.length===0){A.isContainer=false;A.layout={type:"container",calculate:Ext.emptyFn}}}else{A.layout=Ext.apply({type:"gridcolumn",align:"stretch"},A.initialConfig.layout);A.defaults.columnLines=A.columnLines;if(!A.isGroupHeader){A.isRootHeader=true;A.columnManager=new Ext.grid.ColumnManager(false,A);A.visibleColumnManager=new Ext.grid.ColumnManager(true,A);if(A.grid){A.grid.columnManager=A.columnManager;A.grid.visibleColumnManager=A.visibleColumnManager}}else{A.visibleColumnManager=new Ext.grid.ColumnManager(true,A);A.columnManager=new Ext.grid.ColumnManager(false,A)}}A.menuTask=new Ext.util.DelayedTask(A.updateMenuDisabledState,A);A.callParent()},initEvents:function(){var A=this,C=A.onHeaderCtEvent,B={click:C,dblclick:C,contextmenu:C,mouseover:A.onHeaderCtMouseOver,mouseout:A.onHeaderCtMouseOut,scope:A};if(Ext.supports.Touch){B.longpress=A.onHeaderCtLongPress}A.callParent();if(!A.isColumn&&!A.isGroupHeader){A.mon(A.el,B)}},onHeaderCtEvent:function(C,F){var D=this,G=D.getHeaderElByEvent(C),B,E,A;if(D.longPressFired){D.longPressFired=false;return}if(G&&!D.ddLock){B=Ext.getCmp(G.id);if(B){E=B[B.clickTargetName];if(C.within(E)){if(C.type==="click"||C.type==="tap"){A=B.onTitleElClick(C,E);if(A){D.onHeaderTriggerClick(A,C,Ext.supports.Touch?A.el:A.triggerEl)}else{D.onHeaderClick(B,C,F)}}else{if(C.type==="contextmenu"){D.onHeaderContextMenu(B,C,F)}else{if(C.type==="dblclick"&&B.resizable){B.onTitleElDblClick(C,E.dom)}}}}}}},onHeaderCtMouseOver:function(A,D){var E,B,C;if(!A.within(this.el,true)){E=A.getTarget("."+Ext.grid.column.Column.prototype.baseCls);B=E&&Ext.getCmp(E.id);if(B){C=B[B.clickTargetName];if(A.within(C)){B.onTitleMouseOver(A,C.dom)}}}},onHeaderCtMouseOut:function(B,E){var A="."+Ext.grid.column.Column.prototype.baseCls,G=B.getTarget(A),D=B.getRelatedTarget(A),C,F;if(G!==D){if(G){C=Ext.getCmp(G.id);if(C){F=C[C.clickTargetName];C.onTitleMouseOut(B,F.dom)}}if(D){C=Ext.getCmp(D.id);if(C){F=C[C.clickTargetName];C.onTitleMouseOver(B,F.dom)}}}},onHeaderCtLongPress:function(B){var C=this,D=C.getHeaderElByEvent(B),A=Ext.getCmp(D.id);if(!A.menuDisabled){C.longPressFired=true;C.showMenuBy(D,A)}},getHeaderElByEvent:function(A){return A.getTarget("."+Ext.grid.column.Column.prototype.baseCls)},isLayoutRoot:function(){if(this.hiddenHeaders){return false}return this.callParent()},getOwnerHeaderCt:function(){var A=this;return A.isRootHeader?A:A.up("[isRootHeader]")},onDestroy:function(){var A=this;if(A.menu){A.menu.un("hide",A.onMenuHide,A)}A.menuTask.cancel();A.callParent();Ext.destroy(A.visibleColumnManager,A.columnManager,A.menu);A.columnManager=A.visibleColumnManager=null},applyColumnsState:function(D){if(!D||!D.length){return}var G=this,I=G.items.items,B=I.length,F=0,E=D.length,H,K,C,J,A=false;for(H=0;H<E;H++){C=D[H];for(J=B;J--;){K=I[J];if(K.getStateId&&K.getStateId()==C.id){if(F!==J){this.items.insert(F,this.items.getAt(J));A=true}if(K.applyColumnState){K.applyColumnState(C)}++F;break}}}if(A){G.purgeCache()}},getColumnsState:function(){var A=this,C=[],B;A.items.each(function(D){B=D.getColumnState&&D.getColumnState();if(B){C.push(B)}});return C},onAdd:function(B){var A=this;if(!B.headerId){B.headerId=B.initialConfig.id||Ext.id(null,"header-")}if(B.sortable===undefined){B.sortable=A.sortable}if(!B.getStateId()){B.stateId=B.initialConfig.id||("h"+(++A.headerCounter))}if(!A._usedIDs){A._usedIDs={}}if(A._usedIDs[B.headerId]){Ext.log.warn(this.$className+" attempted to reuse an existing id: "+B.headerId)}A._usedIDs[B.headerId]=true;A.callParent(arguments);A.onHeadersChanged(B,A.isDDMoveInGrid)},move:function(C,B){var A=this,D=A.items.items[C];D.visibleFromIdx=A.getOwnerHeaderCt().visibleColumnManager.indexOf(D);A.callParent(arguments)},onMove:function(H,F,A){var E=this,C=E.getOwnerHeaderCt(),G=C.visibleColumnManager,B=1,D;E.onHeadersChanged(H,true);D=G.indexOf(H);if(D>=H.visibleFromIdx){D++}E.callParent(arguments);if(H.isGroupHeader){B=H.visibleColumnManager.getColumns().length}C.onHeaderMoved(H,B,H.visibleFromIdx,D)},onRemove:function(B){var A=this,C=A.ownerCt;A.callParent(arguments);if(!A._usedIDs){A._usedIDs={}}delete A._usedIDs[B.headerId];if(!A.destroying){if(!A.isDDMoveInGrid){A.onHeadersChanged(B,false)}if(A.isGroupHeader&&!A.items.getCount()&&C){if(B.rendered){A.detachComponent(B)}Ext.suspendLayouts();C.remove(A);Ext.resumeLayouts(true)}}},onHeadersChanged:function(B,D){var A,C=this.getOwnerHeaderCt();this.purgeHeaderCtCache(this);if(C){C.onColumnsChanged();if(!B.isGroupHeader){A=C.ownerCt;if(A&&!D){A.onHeadersChanged(C,B)}}}},onHeaderMoved:function(E,F,D,A){var B=this,C=B.ownerCt;if(B.rendered){if(C&&C.onHeaderMove){C.onHeaderMove(B,E,F,D,A)}B.fireEvent("columnmove",B,E,D,A)}},onColumnsChanged:function(){var A=this,D=A.menu,C,B;if(A.rendered){A.fireEvent("columnschanged",A);if(D&&(C=D.child("#columnItemSeparator"))){B=D.child("#columnItem");C.destroy();B.destroy()}}},lookupComponent:function(B){var A=this.callParent(arguments);if(!A.isGroupHeader&&A.width===undefined&&!A.flex){A.width=this.defaultWidth}return A},setSortState:function(){var B=this.up("[store]").store,F=this.visibleColumnManager.getColumns(),E=F.length,C,D,A;for(C=0;C<E;C++){D=F[C];A=B.getSorters().get(D.getSortParam());D.setSortState(A)}},getHeaderMenu:function(){var B=this.getMenu(),A;if(B){A=B.child("#columnItem");if(A){return A.menu}}return null},onHeaderVisibilityChange:function(D,B){var A=this,E=A.getHeaderMenu(),C;A.purgeHeaderCtCache(D.ownerCt);if(E){C=A.getMenuItemForHeader(E,D);if(C){C.setChecked(B,true)}if(E.isVisible()){A.menuTask.delay(50)}}},updateMenuDisabledState:function(C){var E=this,A=E.query(":not([hidden])"),B,F=A.length,H,G,D;if(!C){C=E.getMenu()}for(B=0;B<F;++B){H=A[B];G=E.getMenuItemForHeader(C,H);if(G){D=H.isHideable()?"enable":"disable";if(G.menu){D+="CheckChange"}G[D]()}}},getMenuItemForHeader:function(B,A){return A?B.down("menucheckitem[headerId="+A.id+"]"):null},onHeaderShow:function(C){var A=this,B=A.ownerCt;if(A.forceFit){delete A.flex}A.onHeaderVisibilityChange(C,true);if(!C.isGroupHeader){if(B){B.onHeaderShow(A,C)}}A.fireEvent("columnshow",A,C);A.fireEvent("columnschanged",this)},onHeaderHide:function(C){var A=this,B=A.ownerCt;A.onHeaderVisibilityChange(C,false);if(!C.isGroupHeader){if(B){B.onHeaderHide(A,C)}}A.fireEvent("columnhide",A,C);A.fireEvent("columnschanged",this)},tempLock:function(){this.ddLock=true;Ext.Function.defer(function(){this.ddLock=false},200,this)},onHeaderResize:function(C,D){var A=this,B=A.ownerCt;if(B){B.onHeaderResize(A,C,D)}A.fireEvent("columnresize",A,C,D)},onHeaderClick:function(B,A,C){B.fireEvent("headerclick",this,B,A,C);this.fireEvent("headerclick",this,B,A,C)},onHeaderContextMenu:function(B,A,C){B.fireEvent("headercontextmenu",this,B,A,C);this.fireEvent("headercontextmenu",this,B,A,C)},onHeaderTriggerClick:function(C,B,D){var A=this;if(C.fireEvent("headertriggerclick",A,C,B,D)!==false&&A.fireEvent("headertriggerclick",A,C,B,D)!==false){A.showMenuBy(D,C)}},showMenuBy:function(E,D){var F=this.getMenu(),B=F.down("#ascItem"),C=F.down("#descItem"),A;F.activeHeader=F.ownerButton=D;D.setMenuActive(true);A=D.sortable?"enable":"disable";if(B){B[A]()}if(C){C[A]()}F.showBy(E,"tl-bl?")},hideMenu:function(){if(this.menu){this.menu.hide()}},onMenuHide:function(A){A.activeHeader.setMenuActive(false)},moveHeader:function(B,A){this.tempLock();this.move(B,A)},purgeHeaderCtCache:function(A){while(A){A.purgeCache();if(A.isRootHeader){return}A=A.ownerCt}},purgeCache:function(){var B=this,A=B.visibleColumnManager,C=B.columnManager;B.gridVisibleColumns=B.gridDataColumns=B.hideableColumns=null;if(A){A.invalidate();C.invalidate()}},getMenu:function(){var A=this;if(!A.menu){A.menu=new Ext.menu.Menu({hideOnParentHide:false,items:A.getMenuItems(),listeners:{beforeshow:A.beforeMenuShow,hide:A.onMenuHide,scope:A}});A.fireEvent("menucreate",A,A.menu)}return A.menu},beforeMenuShow:function(E){var A=this,B=E.child("#columnItem"),D,C,E;if(!B){D=A.enableColumnHide?A.getColumnMenu(A):null;C=A.sortable?2:0;if(D&&D.length){E.insert(C,[{itemId:"columnItemSeparator",xtype:"menuseparator"},{itemId:"columnItem",text:A.columnsText,iconCls:A.menuColsIcon,menu:{items:D},hideOnClick:false}])}}A.updateMenuDisabledState(A.menu)},getMenuItems:function(){var B=this,A=[],C=B.enableColumnHide?B.getColumnMenu(B):null;if(B.sortable){A=[{itemId:"ascItem",text:B.sortAscText,iconCls:B.menuSortAscCls,handler:B.onSortAscClick,scope:B},{itemId:"descItem",text:B.sortDescText,iconCls:B.menuSortDescCls,handler:B.onSortDescClick,scope:B}]}if(C&&C.length){if(B.sortable){A.push({itemId:"columnItemSeparator",xtype:"menuseparator"})}A.push({itemId:"columnItem",text:B.columnsText,iconCls:B.menuColsIcon,menu:C,hideOnClick:false})}return A},onSortAscClick:function(){var B=this.getMenu(),A=B.activeHeader;A.sort("ASC")},onSortDescClick:function(){var B=this.getMenu(),A=B.activeHeader;A.sort("DESC")},getColumnMenu:function(F){var C=[],B=0,D,E=F.query(">gridcolumn[hideable]"),A=E.length,G;for(;B<A;B++){D=E[B];G=new Ext.menu.CheckItem({text:D.menuText||D.text,checked:!D.hidden,hideOnClick:false,headerId:D.id,menu:D.isGroupHeader?this.getColumnMenu(D):undefined,checkHandler:this.onColumnCheckChange,scope:this});C.push(G)}return C},onColumnCheckChange:function(C,B){var A=Ext.getCmp(C.headerId);if(A.rendered){A[B?"show":"hide"]()}else{A.hidden=!B}},getColumnCount:function(){return this.getGridColumns().length},getTableWidth:function(){var B=0,A=this.getVisibleGridColumns(),C=A.length,D;for(D=0;D<C;D++){B+=A[D].getCellWidth()||0}return B},getVisibleGridColumns:function(){if(this.gridVisibleColumns){return this.gridVisibleColumns}var C=this.getGridColumns(),E,B=[],D=C.length,A;for(A=0;A<D;A++){if(!C[A].hidden){E=C[A];E.visibleIndex=B.length;B[B.length]=E}}this.gridVisibleColumns=B;return B},getGridColumns:function(B,C){if(!B&&this.gridDataColumns){return this.gridDataColumns}var E=this,A=B||[],H,D,F,I,G;C=C||E.hidden;if(E.items){H=E.items.items;for(D=0,F=H.length;D<F;D++){I=H[D];if(I.isGroupHeader){I.getGridColumns(A,C)}else{I.hiddenAncestor=C;A.push(I)}}}if(!B){E.gridDataColumns=A}if(!B&&F){for(D=0,F=A.length;D<F;D++){I=A[D];I.fullColumnIndex=D;I.isFirstVisible=I.isLastVisible=false;if(!(I.hidden||I.hiddenAncestor)){if(!G){I.isFirstVisible=true}G=I}}if(G){G.isLastVisible=true}}return A},getHideableColumns:function(){var B=this,A=B.hideableColumns;if(!A){A=B.hideableColumns=B.query("[hideable]")}return A},getHeaderIndex:function(A){if(!this.columnManager){this.columnManager=this.getOwnerHeaderCt().columnManager}return this.columnManager.getHeaderIndex(A)},getHeaderAtIndex:function(A){if(!this.columnManager){this.columnManager=this.getOwnerHeaderCt().columnManager}return this.columnManager.getHeaderAtIndex(A)},getVisibleHeaderClosestToIndex:function(A){if(!this.visibleColumnManager){this.visibleColumnManager=this.getOwnerHeaderCt().visibleColumnManager}return this.visibleColumnManager.getVisibleHeaderClosestToIndex(A)},applyForceFit:function(E){var F=this,J=F.view,M=Ext.grid.plugin.HeaderResizer.prototype.minColWidth,K=false,L=Ext.grid.header.Container.prototype.defaultWidth,I=F.el.dom.clientWidth-(J.el.dom.scrollHeight>J.el.dom.clientHeight?Ext.getScrollbarSize().width:0),Q=0,O=F.getVisibleGridColumns(),P=E.hidden,A,N,C,G,D;function H(){for(N=0,A=O.length;N<A;N++){C=O[N];if(C===E){continue}C.flex=C.flex||C.width||C.getWidth();Q+=C.flex;C.width=null}}function B(){var R;for(N=0,A=O.length;N<A;N++){C=O[N];R=(C===E);if(K&&!R){C.flex=M;C.width=null}else{if(!R){D=C.flex||L;C.flex=Math.max(Math.ceil((D/Q)*I),M);C.width=null}}C.setWidth(C.width||C.flex)}}Ext.suspendLayouts();G=(I-((O.length+1)*M));E.flex=null;if(P){D=E.width||E.savedWidth;E.savedWidth=null}else{D=J.getMaxContentWidth(E)}if(D>G){E.width=G;K=true}else{E.width=D;I-=D+L;H()}B();Ext.resumeLayouts(true)},autoSizeColumn:function(A){var B=this.view;if(B){B.autoSizeColumn(A);if(this.forceFit){this.applyForceFit(A)}}}});
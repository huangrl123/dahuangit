Ext.define("Ext.selection.Model",{extend:"Ext.util.Observable",alternateClassName:"Ext.AbstractSelectionModel",requires:["Ext.data.StoreManager"],mixins:["Ext.util.StoreHolder"],allowDeselect:undefined,toggleOnClick:true,selected:null,pruneRemoved:true,suspendChange:0,constructor:function(B){var A=this;B=B||{};Ext.apply(A,B);A.modes={SINGLE:true,SIMPLE:true,MULTI:true};A.setSelectionMode(B.mode||A.mode);A.selected=new Ext.util.MixedCollection();A.callParent(arguments)},bindStore:function(A,B){var C=this;C.mixins.storeholder.bindStore.apply(C,arguments);if(C.store&&!B){C.refresh()}},getStoreListeners:function(){var A=this;return{add:A.onStoreAdd,clear:A.onStoreClear,remove:A.onStoreRemove,update:A.onStoreUpdate,load:A.onStoreLoad,refresh:A.onStoreRefresh}},suspendChanges:function(){++this.suspendChange},resumeChanges:function(){if(this.suspendChange){--this.suspendChange}},selectAll:function(C){var D=this,A=D.store.getRange(),B=0,E=A.length,F=D.getSelection().length;D.suspendChanges();for(;B<E;B++){D.doSelect(A[B],true,C)}D.resumeChanges();if(!C){D.maybeFireSelectionChange(D.getSelection().length!==F)}},deselectAll:function(D){var I=this,B=I.getSelection(),A={},E=I.store,C=B.length,F,H,G;for(F=0,H=B.length;F<H;F++){G=B[F];A[G.id]=E.indexOf(G)}B=Ext.Array.sort(B,function(K,L){var M=A[K.id],J=A[L.id];return M<J?-1:1});I.suspendChanges();I.doDeselect(B,D);I.resumeChanges();if(!D){I.maybeFireSelectionChange(I.getSelection().length!==C)}},getSelectionStart:function(){if(!this.selectionStart){this.setSelectionStart(this.lastFocused)}return this.selectionStart},setSelectionStart:function(A){this.selectionStart=A},selectWithEvent:function(K,A){var I=this,L=I.isSelected(K),D=A.shiftKey,E=A.ctrlKey,C=D&&I.getSelectionStart(),H=I.getSelection(),J=H.length,B=I.allowDeselect,F,G,M;switch(I.selectionMode){case"MULTI":if(D&&C){I.selectRange(C,K,E)}else{if(E&&L){I.doDeselect(K,false)}else{if(E){I.doSelect(K,true,false)}else{if(L&&!D&&!E&&J>1){F=[];for(G=0;G<J;++G){M=H[G];if(M!==K){F.push(M)}}I.doDeselect(F)}else{if(!L){I.doSelect(K,false)}}}}}break;case"SIMPLE":if(L){I.doDeselect(K)}else{I.doSelect(K,true)}break;case"SINGLE":if(B&&!E){B=I.toggleOnClick}if(B&&L){I.doDeselect(K)}else{I.doSelect(K,false)}break}if(!D){if(I.isSelected(K)){I.selectionStart=K}else{I.selectionStart=null}}},afterKeyNavigate:function(A,I){var G=this,C,D,J=G.isSelected(I),F=(G.selectionStart&&G.isSelected(G.lastFocused))?G.selectionStart:(G.selectionStart=G.lastFocused),H=A.getCharCode(),E=H===A.SPACE,B=H===A.UP||H===A.PAGE_UP?"up":(H===A.DOWN||H===A.DOWN?"down":null);switch(G.selectionMode){case"MULTI":if(E){if(A.shiftKey){G.selectRange(F,I,A.ctrlKey)}else{if(J){G.doDeselect(I,A.ctrlKey);G.setLastFocused(null);G.setLastFocused(I)}else{G.doSelect(I,A.ctrlKey)}}}else{if(A.shiftKey&&F){D=G.store.indexOf(F);C=G.store.indexOf(I);if(B==="up"&&D<=C){G.deselectRange(G.lastFocused,C+1)}else{if(B==="down"&&D>=C){G.deselectRange(G.lastFocused,C-1)}else{if(F!==I){G.selectRange(F,I,A.ctrlKey)}}}G.lastSelected=I;G.setLastFocused(I)}else{if(A.ctrlKey&&J){G.setLastFocused(I)}else{if(A.ctrlKey){G.setLastFocused(I)}else{G.doSelect(I,false)}}}}break;case"SIMPLE":if(J){if(G.allowDeselect){G.doDeselect(I)}}else{G.doSelect(I,true)}break;case"SINGLE":if(E){if(J){if(G.allowDeselect){G.doDeselect(I);G.setLastFocused(I)}}else{G.doSelect(I)}}else{if(A.ctrlKey){G.setLastFocused(I)}else{if(E&&G.allowDeselect&&J){G.doDeselect(I)}else{G.doSelect(I,false);G.setLastFocused(I)}}}break}if(!A.shiftKey){if(G.isSelected(I)){G.selectionStart=I}}},selectRange:function(J,F,M){var K=this,A=K.store,I=K.selected.items,B,H,L,E,G,D,C;if(K.isLocked()){return}B=K.normalizeRowRange(J,F);J=B[0];F=B[1];E=[];for(H=J;H<=F;H++){if(!K.isSelected(A.getAt(H))){E.push(A.getAt(H))}}if(!M){G=[];K.suspendChanges();for(H=0,L=I.length;H<L;++H){C=I[H];D=A.indexOf(C);if(D<J||D>F){G.push(C)}}for(H=0,L=G.length;H<L;++H){K.doDeselect(G[H])}K.resumeChanges()}if(E.length){K.doMultiSelect(E,true)}else{K.maybeFireSelectionChange(G.length>0)}},deselectRange:function(E,C){var F=this,G=F.store,B,D,A,H;if(F.isLocked()){return}B=F.normalizeRowRange(E,C);E=B[0];C=B[1];A=[];for(D=E;D<=C;D++){H=G.getAt(D);if(F.isSelected(H)){A.push(H)}}if(A.length){F.doDeselect(A)}},normalizeRowRange:function(D,C){var B=this.store,A;if(!Ext.isNumber(D)){D=B.indexOf(D)}D=Math.max(0,D);if(!Ext.isNumber(C)){C=B.indexOf(C)}C=Math.min(C,B.getCount()-1);if(D>C){A=C;C=D;D=A}return[D,C]},select:function(A,C,B){if(Ext.isDefined(A)&&!(Ext.isArray(A)&&!A.length)){this.doSelect(A,C,B)}},deselect:function(A,B){this.doDeselect(A,B)},doSelect:function(A,D,B){var C=this,E;if(C.locked||!C.store){return}if(typeof A==="number"){E=C.store.getAt(A);if(!E){return}A=[E]}if(C.selectionMode==="SINGLE"&&A){E=A.length?A[0]:A;C.doSingleSelect(E,B)}else{C.doMultiSelect(A,D,B)}},doMultiSelect:function(D,J,C){var H=this,F=H.selected,B=false,A,E,I,G,K;if(H.locked){return}D=!Ext.isArray(D)?[D]:D;I=D.length;if(!J&&F.getCount()>0){A=H.deselectDuringSelect(D,F.getRange(),C);if(A[0]){H.maybeFireSelectionChange(A[1]>0&&!C);return}}K=function(){F.add(G);B=true};for(E=0;E<I;E++){G=D[E];if(H.isSelected(G)){continue}H.lastSelected=G;H.onSelectChange(G,true,C,K)}if(!H.preventFocus){H.setLastFocused(G,C)}H.maybeFireSelectionChange(B&&!C)},deselectDuringSelect:function(B,E,A){var G=this,H=E.length,F=0,C=false,I,D;G.suspendChanges();for(D=0;D<H;++D){I=E[D];if(!Ext.Array.contains(B,I)){if(G.doDeselect(I,A)){++F}else{C=true}}}G.resumeChanges();return[C,F]},doDeselect:function(C,B){var G=this,E=G.selected,D=0,H,I,F=0,A=0,J;if(G.locked||!G.store){return false}if(typeof C==="number"){I=G.store.getAt(C);if(!I){return false}C=[I]}else{if(!Ext.isArray(C)){C=[C]}}J=function(){++A;E.remove(I)};H=C.length;G.suspendChanges();for(;D<H;D++){I=C[D];if(G.isSelected(I)){if(G.lastSelected===I){G.lastSelected=E.last();if(G.lastFocused===I){G.setLastFocused(null)}}++F;G.onSelectChange(I,false,B,J)}}G.resumeChanges();G.maybeFireSelectionChange(A>0&&!B);return A===F},doSingleSelect:function(D,C){var A=this,F=false,B=A.selected,E;if(A.locked){return}if(A.isSelected(D)){return}E=function(){if(B.getCount()){A.suspendChanges();if(!A.doDeselect(A.lastSelected,C)){A.resumeChanges();return false}A.resumeChanges()}B.add(D);A.lastSelected=D;F=true};A.onSelectChange(D,true,C,E);if(F){if(!C&&!A.preventFocus){A.setLastFocused(D)}A.maybeFireSelectionChange(!C)}},setLastFocused:function(C,D){var A=this,B=A.lastFocused;if(C!==B){A.lastFocused=C;A.onLastFocusChanged(B,C,D)}},isFocused:function(A){return A===this.getLastFocused()},maybeFireSelectionChange:function(A){var B=this;if(A&&!B.suspendChange){B.fireEvent("selectionchange",B,B.getSelection())}},getLastSelected:function(){return this.lastSelected},getLastFocused:function(){return this.lastFocused},getSelection:function(){return this.selected.getRange()},getSelectionMode:function(){return this.selectionMode},setSelectionMode:function(A){A=A?A.toUpperCase():"SINGLE";this.selectionMode=this.modes[A]?A:"SINGLE"},isLocked:function(){return this.locked},setLocked:function(A){this.locked=!!A},isRangeSelected:function(F,D){var E=this,A=E.store,B,C;C=E.normalizeRowRange(F,D);F=C[0];D=C[1];for(B=F;B<=D;B++){if(!E.isSelected(A.getAt(B))){return false}}return true},isSelected:function(A){A=Ext.isNumber(A)?this.store.getAt(A):A;return this.selected.contains(A)},hasSelection:function(){return this.selected.getCount()>0},pruneIf:function(){var E=this,G=E.selected,A=E.store,C=[],F=G.length,B,D;if(E.pruneRemoved){for(B=0;B<F;B++){D=G.getAt(B);if(A.indexOfId(D.id)===-1){C.push(D)}}if(C.length){for(B=0,F=C.length;B<F;B++){D=C[B];G.remove(D);E.onPrune(D)}E.maybeFireSelectionChange(true)}}},onPrune:Ext.emptyFn,refresh:function(){var I=this,B=I.store,C,D=[],K=[],H=I.getSelection(),J=H.length,F,A,G=0,E=I.getLastFocused();if(!B){return}for(;G<J;G++){F=H[G];if(B.indexOf(F)!==-1){D.push(F)}else{if(!I.pruneRemoved){C=B.getById(F.getId());if(C){D.push(C)}else{K.push(F)}}}if(I.mode==="SINGLE"&&K.length){break}}if(I.selected.getCount()!==(D.length+K.length)){A=true}I.clearSelections();if(B.indexOf(E)!==-1){I.setLastFocused(E,true)}if(D.length){I.doSelect(D,false,true)}if(K.length){I.selected.addAll(K);if(!I.lastSelected){I.lastSelected=K[K.length-1]}}I.maybeFireSelectionChange(A)},clearSelections:function(){this.selected.clear();this.lastSelected=null;this.setLastFocused(null)},onStoreAdd:Ext.emptyFn,onStoreClear:function(){if(this.selected.getCount()>0){this.clearSelections();this.maybeFireSelectionChange(true)}},onStoreRemove:function(A,B,D,E){var C=this;if(C.selectionStart&&Ext.Array.contains(B,C.selectionStart)){C.selectionStart=null}if(E||C.locked||!C.pruneRemoved){return}C.deselect(B)},deselectDeletedRecords:function(B){var E=this,G=E.selected,A,C=B.length,D=0,F;for(A=0;A<C;A++){F=B[A];if(G.remove(F)){if(E.lastSelected===F){E.lastSelected=null}if(E.getLastFocused()===F){E.setLastFocused(null)}++D}}if(D){E.maybeFireSelectionChange(true)}},getCount:function(){return this.selected.getCount()},onUpdate:Ext.emptyFn,destroy:function(){this.clearListeners();this.clearSelections()},onStoreUpdate:Ext.emptyFn,onStoreRefresh:function(){var F=this,A=F.getStore(),E=F.selected,G=F.lastSelected,H,C,D,I,B;if(F.store.isBufferedStore){return}H=E.items;C=H.length;if(G){F.lastSelected=A.getById(G.id)}for(D=0;D<C;++D){I=H[D];B=A.getById(I.id);if(B){F.selected.replace(B)}else{F.selected.remove(I)}}},onStoreLoad:Ext.emptyFn,onSelectChange:function(C,A,B,D){var E=this,F=A?"select":"deselect";if((B||E.fireEvent("before"+F,E,C))!==false&&D()!==false){if(!B){E.fireEvent(F,E,C)}}},onLastFocusChanged:function(B,A){if(A!=B){this.fireEvent("focuschange",this,B,A)}},onEditorKey:Ext.emptyFn,beforeViewRender:function(A){this.views=this.views||[];this.views.push(A);this.bindStore(A.getStore(),true)},resolveListenerScope:function(C){var A=this.view,B;if(A){B=A.resolveListenerScope(C)}return B||this.callParent([C])},onVetoUIEvent:Ext.emptyFn,bindComponent:Ext.emptyFn});
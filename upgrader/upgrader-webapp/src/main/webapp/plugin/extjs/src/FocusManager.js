Ext.define("Ext.FocusManager",{singleton:true,alternateClassName:["Ext.FocusMgr"],mixins:{observable:"Ext.util.Observable"},requires:["Ext.Component","Ext.ComponentManager","Ext.ComponentQuery","Ext.util.HashMap","Ext.util.KeyNav"],enabled:false,focusElementCls:Ext.baseCSSPrefix+"focus-element",focusFrameCls:Ext.baseCSSPrefix+"focus-frame",whitelist:["textfield"],constructor:function(A){var B=this,C=Ext.ComponentQuery;B.mixins.observable.constructor.call(B,A);B.focusTask=new Ext.util.DelayedTask(B.handleComponentFocus,B);Ext.override(Ext.Component,{onBlur:function(){this.callParent(arguments);if(B.enabled&&!this.hasFocus){Array.prototype.unshift.call(arguments,this);B.onComponentBlur.apply(B,arguments)}},onDestroy:function(){this.callParent(arguments);if(B.enabled){Array.prototype.unshift.call(arguments,this);B.onComponentDestroy.apply(B,arguments)}},onFocus:function(){this.callParent(arguments);if(B.enabled&&this.hasFocus){Array.prototype.unshift.call(arguments,this);B.onComponentFocus.apply(B,arguments)}}});Ext.override(Ext.Component,{afterHide:function(){this.callParent(arguments);if(B.enabled){Array.prototype.unshift.call(arguments,this);B.onComponentHide.apply(B,arguments)}}});B.focusData={};B.subscribers=new Ext.util.HashMap();B.focusChain={};Ext.apply(C.pseudos,{nextFocus:function(E,H,D){D=D||1;H=parseInt(H,10);var G=E.length,F=H,I;for(;;){if((F+=D)>=G){F=0}else{if(F<0){F=G-1}}if(F===H){return[]}if((I=E[F]).isFocusable()){return[I]}}return[]},prevFocus:function(D,E){return this.nextFocus(D,E,-1)},root:function(D){var F=D.length,G=[],E=0,H;for(;E<F;E++){H=D[E];if(!H.ownerCt){G.push(H)}}return G}})},getKeyNav:function(){var A=this;A.keyNav=A.keyNav||new Ext.util.KeyNav(Ext.getDoc(),{disabled:true,scope:A,backspace:A.focusLast,enter:A.navigateIn,esc:A.navigateOut,tab:A.navigateSiblings,space:A.navigateIn,del:A.focusLast,left:A.navigateSiblings,right:A.navigateSiblings,down:A.navigateSiblings,up:A.navigateSiblings});return A.keyNav},addXTypeToWhitelist:function(A){var B=this;if(Ext.isArray(A)){Ext.Array.forEach(A,B.addXTypeToWhitelist,B);return}if(!Ext.Array.contains(B.whitelist,A)){B.whitelist.push(A)}},clearComponent:function(A){clearTimeout(this.cmpFocusDelay);if(!A.isDestroyed){A.blur()}},disable:function(){var A=this;if(!A.enabled){return}delete A.options;A.enabled=false;A.removeDOM();A.getKeyNav().disable();A.fireEvent("disable",A)},enable:function(B){var A=this;if(B===true){B={focusFrame:true}}A.options=B=B||{};if(A.enabled){return}A.enabled=Ext.enableFocusManager=true;A.initDOM(B);A.getKeyNav().enable();A.focusEl.focus();delete A.focusedCmp;A.fireEvent("enable",A)},focusLast:function(A){var B=this;if(B.isWhitelisted(B.focusedCmp)){return true}if(B.previousFocusedCmp){B.previousFocusedCmp.focus()}},getRootComponents:function(){var C=Ext.ComponentQuery,A=C.query(":focusable:root:not([floating])"),B=C.query(":focusable:root[floating]");B.sort(function(E,D){return E.el.getZIndex()>D.el.getZIndex()});return B.concat(A)},initDOM:function(D){var A=this,C=A.focusFrameCls,F=Ext.ComponentQuery.query("{getFocusEl()}:not([focusListenerAdded])"),B=0,E=F.length;if(!Ext.isReady){return Ext.onReady(A.initDOM,A)}for(;B<E;B++){F[B].addFocusListener()}if(!A.focusEl){A.focusEl=Ext.getBody();A.focusEl.dom.tabIndex=-1}if(!A.focusFrame&&D.focusFrame){A.focusFrame=Ext.getBody().createChild({cls:C,children:[{cls:C+"-top"},{cls:C+"-bottom"},{cls:C+"-left"},{cls:C+"-right"}],style:"top: -100px; left: -100px;"});A.focusFrame.setVisibilityMode(Ext.Element.DISPLAY);A.focusFrame.hide().setLocalXY(0,0)}},isWhitelisted:function(A){return A&&Ext.Array.some(this.whitelist,function(B){return A.isXType(B)})},navigateIn:function(B){var C=this,E=C.focusedCmp,A,D;if(C.isWhitelisted(E)){return true}if(!E){A=C.getRootComponents()[0];if(A){if(A.getFocusEl()===C.focusEl){C.focusEl.blur()}A.focus()}}else{D=E.hasFocus?Ext.ComponentQuery.query(">:focusable",E)[0]:E;if(D){D.focus()}else{if(Ext.isFunction(E.onClick)){B.button=0;E.onClick(B);if(E.isVisible(true)){E.focus()}else{C.navigateOut()}}}}},navigateOut:function(A){var B=this,C;if(!B.focusedCmp||!(C=B.focusedCmp.up(":focusable"))){B.focusEl.focus()}else{C.focus()}return true},navigateSiblings:function(A,H,L){var I=this,C=H||I,J=A.getKey(),E=A.shiftKey||J==A.LEFT||J==A.UP,M=J===A.LEFT||J===A.RIGHT||J===A.UP||J===A.DOWN,F=E?"prev":"next",D,G,B,K;B=(C.focusedCmp&&C.focusedCmp.comp)||C.focusedCmp;if(!B&&!L){return true}if(M&&I.isWhitelisted(B)){return true}if(!B||B.is(":root")){K=I.getRootComponents()}else{L=L||B.up();if(L){K=L.getRefItems()}}if(K){D=B?Ext.Array.indexOf(K,B):-1;G=Ext.ComponentQuery.query(":"+F+"Focus("+D+")",K)[0];if(G&&B!==G){G.focus();return G}}},onComponentBlur:function(C,A){var B=this;if(B.focusedCmp===C){B.previousFocusedCmp=C;delete B.focusedCmp}if(B.focusFrame){B.focusFrame.hide()}},onComponentFocus:function(D,B){var C=this,A=C.focusChain,E;if(!D.isFocusable()){C.clearComponent(D);if(A[D.id]){return}E=D.up();if(E){A[D.id]=true;E.focus()}return}C.focusChain={};C.focusTask.delay(10,null,null,[D,D.getFocusEl()])},handleComponentFocus:function(F,H){var K=this,D,A,G,J,B,L,E,M,C,I,N;if(K.fireEvent("beforecomponentfocus",K,F,K.previousFocusedCmp)===false){K.clearComponent(F);return}K.focusedCmp=F;if(K.shouldShowFocusFrame(F)){D="."+K.focusFrameCls+"-";A=K.focusFrame;G=(H.dom?H:H.el).getBox();J=G.top;B=G.left;L=G.width;E=G.height;M=A.child(D+"top");C=A.child(D+"bottom");I=A.child(D+"left");N=A.child(D+"right");M.setWidth(L).setLocalXY(B,J);C.setWidth(L).setLocalXY(B,J+E-2);I.setHeight(E-2).setLocalXY(B,J+2);N.setHeight(E-2).setLocalXY(B+L-2,J+2);A.show()}K.fireEvent("componentfocus",K,F,K.previousFocusedCmp)},onComponentHide:function(C){var B=this,A=false,E=B.focusedCmp,D;if(E){A=C.hasFocus||(C.isContainer&&C.isAncestor(B.focusedCmp))}B.clearComponent(C);if(A&&(D=C.up(":focusable"))){D.focus()}else{B.focusEl.focus()}},onComponentDestroy:function(){},removeDOM:function(){var A=this;if(A.enabled||A.subscribers.length){return}Ext.destroy(A.focusFrame);delete A.focusEl;delete A.focusFrame},removeXTypeFromWhitelist:function(A){var B=this;if(Ext.isArray(A)){Ext.Array.forEach(A,B.removeXTypeFromWhitelist,B);return}Ext.Array.remove(B.whitelist,A)},setupSubscriberKeys:function(E,F){var B=this,A=E.getFocusEl(),C=F.scope,G={backspace:B.focusLast,enter:B.navigateIn,esc:B.navigateOut,scope:B},D=function(H){if(B.focusedCmp===E){return B.navigateSiblings(H,B,E)}else{return B.navigateSiblings(H)}};Ext.iterate(F,function(I,H){G[I]=function(J){var K=D(J);if(Ext.isFunction(H)&&H.call(C||E,J,K)===true){return true}return K}},B);return new Ext.util.KeyNav(A,G)},shouldShowFocusFrame:function(C){var B=this,A=B.options||{};if(!B.focusFrame||!C){return false}if(A.focusFrame){return true}if(B.focusData[C.id].focusFrame){return true}return false}});
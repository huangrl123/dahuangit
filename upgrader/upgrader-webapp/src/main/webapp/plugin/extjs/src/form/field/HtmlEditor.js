Ext.define("Ext.form.field.HtmlEditor",{extend:"Ext.form.FieldContainer",mixins:{field:"Ext.form.field.Field"},alias:"widget.htmleditor",alternateClassName:"Ext.form.HtmlEditor",requires:["Ext.tip.QuickTipManager","Ext.picker.Color","Ext.layout.container.VBox","Ext.toolbar.Item","Ext.toolbar.Toolbar","Ext.util.Format","Ext.layout.component.field.HtmlEditor"],componentLayout:"htmleditor",componentTpl:["{beforeTextAreaTpl}",'<textarea id="{id}-textareaEl" data-ref="textareaEl" name="{name}" tabIndex="-1" {inputAttrTpl}',' class="{textareaCls}" autocomplete="off">',"{[Ext.util.Format.htmlEncode(values.value)]}","</textarea>","{afterTextAreaTpl}","{beforeIFrameTpl}",'<iframe id="{id}-iframeEl" data-ref="iframeEl" name="{iframeName}" frameBorder="0" {iframeAttrTpl}',' src="{iframeSrc}" class="{iframeCls}"></iframe>',"{afterIFrameTpl}",{disableFormats:true}],stretchInputElFixed:true,subTplInsertions:["beforeTextAreaTpl","afterTextAreaTpl","beforeIFrameTpl","afterIFrameTpl","iframeAttrTpl","inputAttrTpl"],enableFormat:true,enableFontSize:true,enableColors:true,enableAlignments:true,enableLists:true,enableSourceEdit:true,enableLinks:true,enableFont:true,createLinkText:"Please enter the URL for the link:",defaultLinkValue:"http://",fontFamilies:["Arial","Courier New","Tahoma","Times New Roman","Verdana"],defaultValue:Ext.isOpera?"&#160;":"&#8203;",extraFieldBodyCls:Ext.baseCSSPrefix+"html-editor-wrap",defaultButtonUI:"default-toolbar",initialized:false,activated:false,sourceEditMode:false,iframePad:3,hideMode:"offsets",maskOnDisable:true,containerElCls:Ext.baseCSSPrefix+"html-editor-container",reStripQuotes:/^['"]*|['"]*$/g,initComponent:function(){var A=this;A.items=[A.createToolbar(),A.createInputCmp()];A.layout={type:"vbox",align:"stretch"};A.callParent(arguments);A.initField()},createInputCmp:function(){this.inputCmp=Ext.widget(this.getInputCmpCfg());return this.inputCmp},getInputCmpCfg:function(){var B=this,C=B.id+"-inputCmp",A={id:C,name:B.name,textareaCls:Ext.baseCSSPrefix+"hidden",value:B.value,iframeName:Ext.id(),iframeSrc:Ext.SSL_SECURE_URL,iframeCls:Ext.baseCSSPrefix+"htmleditor-iframe"};B.getInsertionRenderData(A,B.subTplInsertions);return{flex:1,xtype:"component",tpl:B.getTpl("componentTpl"),childEls:["iframeEl","textareaEl"],id:C,cls:Ext.baseCSSPrefix+"html-editor-input",data:A}},createToolbar:function(){this.toolbar=Ext.widget(this.getToolbarCfg());return this.toolbar},getToolbarCfg:function(){var D=this,G=[],C,A=Ext.quickTipsActive&&Ext.tip.QuickTipManager.isEnabled(),E=Ext.baseCSSPrefix,H,F;function B(K,J,I){return{itemId:K,cls:E+"btn-icon",iconCls:E+"edit-"+K,enableToggle:J!==false,scope:D,handler:I||D.relayBtnCmd,clickEvent:"mousedown",tooltip:A?D.buttonTips[K]||F:F,overflowText:D.buttonTips[K].title||F,tabIndex:-1}}if(D.enableFont&&!Ext.isSafari2){H=Ext.widget("component",{itemId:"fontSelect",renderTpl:['<select id="{id}-selectEl" data-ref="selectEl" class="'+E+'font-select">',"</select>"],childEls:["selectEl"],afterRender:function(){D.fontSelect=this.selectEl;Ext.Component.prototype.afterRender.apply(this,arguments)},onDisable:function(){var I=this.selectEl;if(I){I.dom.disabled=true}Ext.Component.prototype.onDisable.apply(this,arguments)},onEnable:function(){var I=this.selectEl;if(I){I.dom.disabled=false}Ext.Component.prototype.onEnable.apply(this,arguments)},listeners:{change:function(){D.win.focus();D.relayCmd("fontName",D.fontSelect.dom.value);D.deferFocus()},element:"selectEl"}});G.push(H,"-")}if(D.enableFormat){G.push(B("bold"),B("italic"),B("underline"))}if(D.enableFontSize){G.push("-",B("increasefontsize",false,D.adjustFont),B("decreasefontsize",false,D.adjustFont))}if(D.enableColors){G.push("-",{itemId:"forecolor",cls:E+"btn-icon",iconCls:E+"edit-forecolor",overflowText:D.buttonTips.forecolor.title,tooltip:A?D.buttonTips.forecolor||F:F,tabIndex:-1,menu:Ext.widget("menu",{plain:true,items:[{xtype:"colorpicker",allowReselect:true,focus:Ext.emptyFn,value:"000000",plain:true,clickEvent:"mousedown",handler:function(I,J){D.relayCmd("forecolor",Ext.isWebKit||Ext.isIE?"#"+J:J);this.up("menu").hide()}}]})},{itemId:"backcolor",cls:E+"btn-icon",iconCls:E+"edit-backcolor",overflowText:D.buttonTips.backcolor.title,tooltip:A?D.buttonTips.backcolor||F:F,tabIndex:-1,menu:Ext.widget("menu",{plain:true,items:[{xtype:"colorpicker",focus:Ext.emptyFn,value:"FFFFFF",plain:true,allowReselect:true,clickEvent:"mousedown",handler:function(I,J){if(Ext.isGecko){D.execCmd("useCSS",false);D.execCmd("hilitecolor","#"+J);D.execCmd("useCSS",true);D.deferFocus()}else{D.relayCmd(Ext.isOpera?"hilitecolor":"backcolor",Ext.isWebKit||Ext.isIE||Ext.isOpera?"#"+J:J)}this.up("menu").hide()}}]})})}if(D.enableAlignments){G.push("-",B("justifyleft"),B("justifycenter"),B("justifyright"))}if(!Ext.isSafari2){if(D.enableLinks){G.push("-",B("createlink",false,D.createLink))}if(D.enableLists){G.push("-",B("insertorderedlist"),B("insertunorderedlist"))}if(D.enableSourceEdit){G.push("-",B("sourceedit",true,function(){D.toggleSourceEdit(!D.sourceEditMode)}))}}for(C=0;C<G.length;C++){if(G[C].itemId!=="sourceedit"){G[C].disabled=true}}return{xtype:"toolbar",defaultButtonUI:D.defaultButtonUI,cls:Ext.baseCSSPrefix+"html-editor-tb",enableOverflow:true,items:G,listeners:{click:function(I){I.preventDefault()},element:"el"}}},getMaskTarget:function(){return Ext.isGecko?this.inputCmp.el:this.bodyEl},setReadOnly:function(C){var D=this,E=D.textareaEl,A=D.iframeEl,B;D.readOnly=C;if(E){E.dom.readOnly=C}if(D.initialized){B=D.getEditorBody();if(Ext.isIE){A.setDisplayed(false);B.contentEditable=!C;A.setDisplayed(true)}else{D.setDesignMode(!C)}if(B){B.style.cursor=C?"default":"text"}D.disableItems(C)}},getDocMarkup:function(){var B=this,A=B.iframeEl.getHeight()-B.iframePad*2;return Ext.String.format('<!DOCTYPE html><html><head><style type="text/css">'+(Ext.isOpera?"p{margin:0;}":"")+"body{border:0;margin:0;padding:{0}px;direction:"+(B.rtl?"rtl;":"ltr;")+(Ext.isIE8?Ext.emptyString:"min-")+"height:{1}px;box-sizing:border-box;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;cursor:text;background-color:white;"+(Ext.isIE?"":"font-size:12px;font-family:{2}")+"}</style></head><body></body></html>",B.iframePad,A,B.defaultFont)},getEditorBody:function(){var A=this.getDoc();return A.body||A.documentElement},getDoc:function(){return this.iframeEl.dom.contentDocument||this.getWin().document},getWin:function(){return this.iframeEl.dom.contentWindow||window.frames[this.iframeEl.dom.name]},initDefaultFont:function(){var A=this,D=0,H,G,F,I,E,B,C;if(!A.defaultFont){G=A.textareaEl.getStyle("font-family");G=Ext.String.capitalize(G.split(",")[0]);H=Ext.Array.clone(A.fontFamilies);Ext.Array.include(H,G);H.sort();A.defaultFont=G;F=A.down("#fontSelect").selectEl.dom;for(E=0,B=H.length;E<B;++E){G=H[E];C=G.toLowerCase();I=new Option(G,C);if(G===A.defaultFont){D=E}I.style.fontFamily=C;if(Ext.isIE){F.add(I)}else{F.options.add(I)}}F.options[D].selected=true}},isEqual:function(A,B){return this.isEqualAsString(A,B)},afterRender:function(){var B=this,A=B.inputCmp;B.callParent(arguments);B.iframeEl=A.iframeEl;B.textareaEl=A.textareaEl;B.inputEl=B.iframeEl;if(B.enableFont){B.initDefaultFont()}B.monitorTask=Ext.TaskManager.start({run:B.checkDesignMode,scope:B,interval:100})},initFrameDoc:function(){var A=this,C,B;Ext.TaskManager.stop(A.monitorTask);C=A.getDoc();A.win=A.getWin();C.open();C.write(A.getDocMarkup());C.close();B={run:function(){var D=A.getDoc();if(D.body||D.readyState==="complete"){Ext.TaskManager.stop(B);A.setDesignMode(true);Ext.defer(A.initEditor,10,A)}},interval:10,duration:10000,scope:A};Ext.TaskManager.start(B)},checkDesignMode:function(){var A=this,B=A.getDoc();if(B&&(!B.editorInitialized||A.getDesignMode()!=="on")){A.initFrameDoc()}},setDesignMode:function(A){var B=this,C=B.getDoc();if(C){if(B.readOnly){A=false}C.designMode=(/on|true/i).test(String(A).toLowerCase())?"on":"off"}},getDesignMode:function(){var A=this.getDoc();return !A?"":String(A.designMode).toLowerCase()},disableItems:function(E){var D=this.getToolbar().items.items,A,B=D.length,C;for(A=0;A<B;A++){C=D[A];if(C.getItemId()!=="sourceedit"){C.setDisabled(E)}}},toggleSourceEdit:function(C){var D=this,A=D.iframeEl,F=D.textareaEl,B=Ext.baseCSSPrefix+"hidden",E=D.getToolbar().getComponent("sourceedit");if(!Ext.isBoolean(C)){C=!D.sourceEditMode}D.sourceEditMode=C;if(E.pressed!==C){E.toggle(C)}if(C){D.disableItems(true);D.syncValue();A.addCls(B);F.removeCls(B);F.dom.removeAttribute("tabIndex");F.focus();D.inputEl=F}else{if(D.initialized){D.disableItems(D.readOnly)}D.pushValue();A.removeCls(B);F.addCls(B);F.dom.setAttribute("tabIndex",-1);D.deferFocus();D.inputEl=A}D.fireEvent("editmodechange",D,C);D.updateLayout()},createLink:function(){var A=prompt(this.createLinkText,this.defaultLinkValue);if(A&&A!=="http://"){this.relayCmd("createlink",A)}},clearInvalid:Ext.emptyFn,setValue:function(D){var C=this,B=C.textareaEl,A=C.inputCmp;if(D===null||D===undefined){D=""}if(B){B.dom.value=D}C.pushValue();if(!C.rendered&&C.inputCmp){C.inputCmp.data.value=D}C.mixins.field.setValue.call(C,D);return C},cleanHtml:function(A){A=String(A);if(Ext.isWebKit){A=A.replace(/\sclass="(?:Apple-style-span|Apple-tab-span|khtml-block-placeholder)"/gi,"")}if(A.charCodeAt(0)===parseInt(this.defaultValue.replace(/\D/g,""),10)){A=A.substring(1)}return A},syncValue:function(){var E=this,C,G,A,F,D,B;if(E.initialized){C=E.getEditorBody();A=C.innerHTML;B=E.textareaEl.dom;if(Ext.isWebKit){F=C.getAttribute("style");D=F.match(/text-align:(.*?);/i);if(D&&D[1]){A='<div style="'+D[0]+'">'+A+"</div>"}}A=E.cleanHtml(A);if(E.fireEvent("beforesync",E,A)!==false){if(Ext.isGecko&&B.value===""&&A==="<br>"){A=""}if(B.value!==A){B.value=A;G=true}E.fireEvent("sync",E,A);if(G){E.checkChange()}}}},getValue:function(){var A=this,B;if(!A.sourceEditMode){A.syncValue()}B=A.rendered?A.textareaEl.dom.value:A.value;A.value=B;return B},pushValue:function(){var A=this,B;if(A.initialized){B=A.textareaEl.dom.value||"";if(!A.activated&&B.length<1){B=A.defaultValue}if(A.fireEvent("beforepush",A,B)!==false){A.getEditorBody().innerHTML=B;if(Ext.isGecko){A.setDesignMode(false);A.setDesignMode(true)}A.fireEvent("push",A,B)}}},focus:function(B,D){var A=this,C,E;if(D){if(!A.focusTask){A.focusTask=new Ext.util.DelayedTask(A.focus)}A.focusTask.delay(Ext.isNumber(D)?D:10,null,A,[B,false])}else{if(B){if(A.textareaEl&&A.textareaEl.dom){C=A.textareaEl.dom.value}if(C&&C.length){A.execCmd("selectall",true)}}E=A.getFocusEl();if(E&&E.focus){E.focus()}}return A},initEditor:function(){var D=this,E,A,G,C,F;if(D.destroying||D.isDestroyed){return}E=D.getEditorBody();A=D.textareaEl.getStyle(["font-size","font-family","background-image","background-repeat","background-color","color"]);A["background-attachment"]="fixed";E.bgProperties="fixed";Ext.DomHelper.applyStyles(E,A);G=D.getDoc();C=Ext.get(G);if(C){try{C.clearListeners()}catch(B){}F=D.onEditorEvent.bind(D);C.on({mousedown:F,dblclick:F,click:F,keyup:F,delegated:false,buffer:100});F=D.onRelayedEvent;C.on({mousedown:F,mousemove:F,mouseup:F,click:F,dblclick:F,delegated:false,scope:D});if(Ext.isGecko){C.on("keypress",D.applyCommand,D)}if(D.fixKeys){C.on("keydown",D.fixKeys,D)}if(D.fixKeysAfter){C.on("keyup",D.fixKeysAfter,D)}if(Ext.isIE9){Ext.get(G.documentElement).on("focus",D.focus,D)}if(Ext.isIE8){C.on("focusout",function(){D.savedSelection=G.selection.type!=="None"?G.selection.createRange():null},D);C.on("focusin",function(){if(D.savedSelection){D.savedSelection.select()}},D)}Ext.getWin().on("beforeunload",D.beforeDestroy,D);G.editorInitialized=true;D.initialized=true;D.pushValue();D.setReadOnly(D.readOnly);D.fireEvent("initialize",D)}},beforeDestroy:function(){var B=this,D=B.monitorTask,E,C;if(D){Ext.TaskManager.stop(D)}if(B.rendered){Ext.getWin().un(B.beforeDestroy,B);E=B.getDoc();if(E){Ext.get(E).clearListeners();if(E.hasOwnProperty){for(C in E){try{if(E.hasOwnProperty(C)){delete E[C]}}catch(A){}}}}B.iframeEl.destroy();delete B.iframeEl;delete B.textareaEl;delete B.toolbar;delete B.inputCmp}B.callParent()},onRelayedEvent:function(D){var C=this.iframeEl,B=Ext.fly(C).getTrueXY(),E=D.getXY(),A=D.getXY();D.xy=[B[0]+A[0],B[1]+A[1]];D.injectEvent(C);D.xy=E},onFirstFocus:function(){var B=this,C,D;B.activated=true;B.disableItems(B.readOnly);if(Ext.isGecko){B.win.focus();C=B.win.getSelection();if(C.focusNode&&!B.getValue().length){D=C.getRangeAt(0);D.selectNodeContents(B.getEditorBody());D.collapse(true);B.deferFocus()}try{B.execCmd("useCSS",true);B.execCmd("styleWithCSS",false)}catch(A){}}B.fireEvent("activate",B)},adjustFont:function(C){var B=C.getItemId()==="increasefontsize"?1:-1,A=this.getDoc().queryCommandValue("FontSize")||"2",D=Ext.isString(A)&&A.indexOf("px")!==-1,E;A=parseInt(A,10);if(D){if(A<=10){A=1+B}else{if(A<=13){A=2+B}else{if(A<=16){A=3+B}else{if(A<=18){A=4+B}else{if(A<=24){A=5+B}else{A=6+B}}}}}A=Ext.Number.constrain(A,1,6)}else{E=Ext.isSafari;if(E){B*=2}A=Math.max(1,A+B)+(E?"px":0)}this.relayCmd("FontSize",A)},onEditorEvent:function(){this.updateToolbar()},updateToolbar:function(){var G=this,C,H,D,E,B,I,A,F;if(G.readOnly){return}if(!G.activated){G.onFirstFocus();return}D=G.getToolbar().items.map;E=G.getDoc();if(G.enableFont&&!Ext.isSafari2){I=E.queryCommandValue("fontName");B=(I?I.split(",")[0].replace(G.reStripQuotes,""):G.defaultFont).toLowerCase();A=G.fontSelect.dom;if(B!==A.value||B!==I){A.value=B}}function J(){var L;for(C=0,H=arguments.length,B;C<H;C++){B=arguments[C];try{L=E.queryCommandState(B)}catch(K){L=false}D[B].toggle(L)}}if(G.enableFormat){J("bold","italic","underline")}if(G.enableAlignments){J("justifyleft","justifycenter","justifyright")}if(!Ext.isSafari2&&G.enableLists){J("insertorderedlist","insertunorderedlist")}F=G.toolbar.query("menu");for(C=0;C<F.length;C++){F[C].hide()}G.syncValue()},relayBtnCmd:function(A){this.relayCmd(A.getItemId())},relayCmd:function(A,B){Ext.defer(function(){var C=this;if(!this.isDestroyed){C.win.focus();C.execCmd(A,B);C.updateToolbar()}},10,this)},execCmd:function(B,C){var A=this,D=A.getDoc();D.execCommand(B,false,(C===undefined?null:C));A.syncValue()},applyCommand:function(B){if(B.ctrlKey){var C=this,D=B.getCharCode(),A;if(D>0){D=String.fromCharCode(D);switch(D){case"b":A="bold";break;case"i":A="italic";break;case"u":A="underline";break}if(A){C.win.focus();C.execCmd(A);C.deferFocus();B.preventDefault()}}}},insertAtCursor:function(B){var A=this,C;if(A.activated){A.win.focus();if(Ext.isIE){C=A.getDoc().selection.createRange();if(C){C.pasteHTML(B);A.syncValue();A.deferFocus()}}else{A.execCmd("InsertHTML",B);A.deferFocus()}}},fixKeys:(function(){var A;if(Ext.isIE){return function(C){var E=this,H=C.getKey(),B=E.getDoc(),D=E.readOnly,G,F;if(H===C.TAB){C.stopEvent();if(!D){G=B.selection.createRange();if(G){if(G.collapse){G.collapse(true);G.pasteHTML("&#160;&#160;&#160;&#160;")}E.deferFocus()}}}else{if(H===C.ENTER){if(!D){if(Ext.isIE10m){G=B.selection.createRange();if(G){F=G.parentElement();if(!F||F.tagName.toLowerCase()!=="li"){C.stopEvent();G.pasteHTML("<br />");G.collapse(false);G.select()}}}else{G=B.getSelection().getRangeAt(0);if(G&&G.commonAncestorContainer.parentNode.tagName.toLowerCase()!=="li"){C.stopEvent();A=B.createElement("div");G.insertNode(A)}}}}}}}if(Ext.isOpera){return function(B){var D=this,E=B.getKey(),C=D.readOnly;if(E===B.TAB){B.stopEvent();if(!C){D.win.focus();D.execCmd("InsertHTML","&#160;&#160;&#160;&#160;");D.deferFocus()}}}}return null}()),fixKeysAfter:(function(){if(Ext.isIE){return function(B){var D=this,F=B.getKey(),A=D.getDoc(),C=D.readOnly,E;if(!C&&(F===B.BACKSPACE||F===B.DELETE)){E=A.body.innerHTML;if(E==="<p>&nbsp;</p>"||E==="<P>&nbsp;</P>"){A.body.innerHTML=""}}}}return null}()),getToolbar:function(){return this.toolbar},buttonTips:{bold:{title:"Bold (Ctrl+B)",text:"Make the selected text bold.",cls:Ext.baseCSSPrefix+"html-editor-tip"},italic:{title:"Italic (Ctrl+I)",text:"Make the selected text italic.",cls:Ext.baseCSSPrefix+"html-editor-tip"},underline:{title:"Underline (Ctrl+U)",text:"Underline the selected text.",cls:Ext.baseCSSPrefix+"html-editor-tip"},increasefontsize:{title:"Grow Text",text:"Increase the font size.",cls:Ext.baseCSSPrefix+"html-editor-tip"},decreasefontsize:{title:"Shrink Text",text:"Decrease the font size.",cls:Ext.baseCSSPrefix+"html-editor-tip"},backcolor:{title:"Text Highlight Color",text:"Change the background color of the selected text.",cls:Ext.baseCSSPrefix+"html-editor-tip"},forecolor:{title:"Font Color",text:"Change the color of the selected text.",cls:Ext.baseCSSPrefix+"html-editor-tip"},justifyleft:{title:"Align Text Left",text:"Align text to the left.",cls:Ext.baseCSSPrefix+"html-editor-tip"},justifycenter:{title:"Center Text",text:"Center text in the editor.",cls:Ext.baseCSSPrefix+"html-editor-tip"},justifyright:{title:"Align Text Right",text:"Align text to the right.",cls:Ext.baseCSSPrefix+"html-editor-tip"},insertunorderedlist:{title:"Bullet List",text:"Start a bulleted list.",cls:Ext.baseCSSPrefix+"html-editor-tip"},insertorderedlist:{title:"Numbered List",text:"Start a numbered list.",cls:Ext.baseCSSPrefix+"html-editor-tip"},createlink:{title:"Hyperlink",text:"Make the selected text a hyperlink.",cls:Ext.baseCSSPrefix+"html-editor-tip"},sourceedit:{title:"Source Edit",text:"Switch to source editing mode.",cls:Ext.baseCSSPrefix+"html-editor-tip"}},privates:{deferFocus:function(){this.focus(false,true)},getFocusEl:function(){var B=this,A=B.win;return A&&!B.sourceEditMode?A:B.textareaEl}}});
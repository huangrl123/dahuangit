Ext.define("Ext.layout.Context",{requires:["Ext.perf.Monitor","Ext.util.Queue","Ext.layout.ContextItem","Ext.layout.Layout","Ext.fx.Anim","Ext.fx.Manager"],remainingLayouts:0,state:0,constructor:function(A){var B=this;Ext.apply(B,A);B.items={};B.layouts={};B.blockCount=0;B.cycleCount=0;B.flushCount=0;B.calcCount=0;B.animateQueue=B.newQueue();B.completionQueue=B.newQueue();B.finalizeQueue=B.newQueue();B.finishQueue=B.newQueue();B.flushQueue=B.newQueue();B.invalidateData={};B.layoutQueue=B.newQueue();B.invalidQueue=[];B.triggers={data:{},dom:{}}},callLayout:function(B,A){this.currentLayout=B;B[A](this.getCmp(B.owner))},cancelComponent:function(H,P,M){var F=this,L=H,K=!H.isComponent,A=K?L.length:1,E,D,B,N,J,O,G,C,I,Q;for(E=0;E<A;++E){if(K){H=L[E]}if(M&&H.ownerCt){Q=this.items[H.ownerCt.el.id];if(Q){Ext.Array.remove(Q.childItems,F.getCmp(H))}}if(!P){G=F.invalidQueue;B=G.length;if(B){F.invalidQueue=O=[];for(D=0;D<B;++D){C=G[D];I=C.item.target;if(I!=H&&!I.isDescendantOf(H)){O.push(C)}}}}J=H.componentLayout;F.cancelLayout(J);if(J.getLayoutItems){N=J.getLayoutItems();if(N.length){F.cancelComponent(N,true)}}if(H.isContainer&&!H.collapsed){J=H.layout;F.cancelLayout(J);N=J.getVisibleItems();if(N.length){F.cancelComponent(N,true)}}}},cancelLayout:function(B){var A=this;A.completionQueue.remove(B);A.finalizeQueue.remove(B);A.finishQueue.remove(B);A.layoutQueue.remove(B);if(B.running){A.layoutDone(B)}B.ownerContext=null},clearTriggers:function(F,D){var G=F.id,B=this.triggers[D?"dom":"data"],H=B&&B[G],C=(H&&H.length)||0,E,I,A;for(E=0;E<C;++E){A=H[E];I=A.item;B=D?I.domTriggers:I.triggers;delete B[A.prop][G]}},flush:function(){var C=this,D=C.flushQueue.clear(),A=D.length,B;if(A){++C.flushCount;for(B=0;B<A;++B){D[B].flush()}}},flushAnimations:function(){var B=this,D=B.animateQueue.clear(),C=D.length,A;if(C){for(A=0;A<C;A++){if(D[A].target.animate!==false){D[A].flushAnimations()}}Ext.fx.Manager.runner()}},flushInvalidates:function(){var D=this,G=D.invalidQueue,A=G&&G.length,F,E,B,C;D.invalidQueue=[];if(A){E=[];for(C=0;C<A;++C){F=(B=G[C]).item.target;if(!F.container.isDetachedBody){E.push(F);if(B.options){D.invalidateData[F.id]=B.options}}}D.invalidate(E,null)}},flushLayouts:function(C,F,H){var A=this,G=H?A[C].items:A[C].clear(),B=G.length,D,E;if(B){for(D=0;D<B;++D){E=G[D];if(!E.running){A.callLayout(E,F)}}A.currentLayout=null}},getCmp:function(A){return this.getItem(A,A.el)},getEl:function(C,A){var B=this.getItem(A,A);if(!B.parent){B.parent=C;if(C.children.length){C.children.push(B)}else{C.children=[B]}}return B},getItem:function(D,A){var E=A.id,C=this.items,B=C[E]||(C[E]=new Ext.layout.ContextItem({context:this,target:D,el:A}));return B},handleFailure:function(){var B=this.layouts,C,A;Ext.failedLayouts=(Ext.failedLayouts||0)+1;for(A in B){C=B[A];if(B.hasOwnProperty(A)){C.running=false;C.ownerContext=null}}if(Ext.repoDevMode&&!this.pageAnalyzerMode){Ext.Error.raise("Layout run failed")}else{Ext.log.error("Layout run failed")}},invalidate:function(N,P){var G=this,L=!N.isComponent,I,B,D,E,J,C,O,A,M,K,F,H,Q;for(E=0,A=L?N.length:1;E<A;++E){J=L?N[E]:N;if(J.rendered&&!J.hidden){B=J.ownerLayout;M=J.componentLayout;D=!M.ownerContext;Q=false;if((!B||!B.needsItemSize)&&J.liquidLayout){Q=true}if(!Q||(B&&B.setsItemSize)){C=G.getCmp(J);K=(J.isContainer&&!J.collapsed)?J.layout:null;F=G.invalidateData[C.id];delete G.invalidateData[C.id];H=C.init(P,F)}if(Q){continue}if(F){G.processInvalidate(F,C,"before")}if(M.beforeLayoutCycle){M.beforeLayoutCycle(C)}if(K&&K.beforeLayoutCycle){K.beforeLayoutCycle(C)}H=C.initContinue(H);I=true;if(M.getLayoutItems){M.renderChildren();O=M.getLayoutItems();if(O.length){G.invalidate(O,true)}}if(K){I=false;K.renderChildren();if(K.needsItemSize||K.activeItemCount){O=K.getVisibleItems();if(O.length){G.invalidate(O,true)}}}C.initDone(I);G.resetLayout(M,C,D);if(K){G.resetLayout(K,C,D)}C.initAnimation();if(F){G.processInvalidate(F,C,"after")}}}G.currentLayout=null},layoutDone:function(A){var B=A.ownerContext;A.running=false;if(A.isComponentLayout){if(B.measuresBox){B.onBoxMeasured()}B.setProp("done",true)}else{B.setProp("containerLayoutDone",true)}--this.remainingLayouts;++this.progressCount},newQueue:function(){return new Ext.util.Queue()},processInvalidate:function(D,C,E){if(D[E]){var A=this,B=A.currentLayout;A.currentLayout=D.layout||null;D[E](C,D);A.currentLayout=B}},queueAnimation:function(A){this.animateQueue.add(A)},queueCompletion:function(A){this.completionQueue.add(A)},queueFinalize:function(A){this.finalizeQueue.add(A)},queueFlush:function(A){this.flushQueue.add(A)},chainFns:function(F,H,D){var A=this,E=F.layout,G=H.layout,B=F[D],C=H[D];return function(I){var J=A.currentLayout;if(B){A.currentLayout=E;B.call(F.scope||F,I,F)}A.currentLayout=G;C.call(H.scope||H,I,H);A.currentLayout=J}},purgeInvalidates:function(){var H=this,B=[],C=H.invalidQueue,K=C.length,I,G,J,E,F,D,A;for(I=0;I<K;++I){F=C[I];D=F.item.target;A=true;for(G=B.length;G--;){J=B[G];E=J.item.target;if(D.isDescendant(E)){A=false;break}if(E.isDescendant(D)){Ext.Array.erase(B,G,1)}}if(A){B.push(F)}}H.invalidQueue=B},queueInvalidate:function(K,E){var J=this,G=[],F=J.invalidQueue,C=F.length,H,B,D,A,I;if(K.isComponent){K=J.getCmp(H=K)}else{H=K.target}K.invalid=true;while(C--){B=F[C];D=B.item.target;if(H.isDescendantOf(D)){return}if(D==H){if(!(A=B.options)){B.options=E}else{if(E){if(E.widthModel){A.widthModel=E.widthModel}if(E.heightModel){A.heightModel=E.heightModel}if(!(I=A.state)){A.state=E.state}else{if(E.state){Ext.apply(I,E.state)}}if(E.before){A.before=J.chainFns(A,E,"before")}if(E.after){A.after=J.chainFns(A,E,"after")}}}return}if(!D.isDescendantOf(H)){G.push(B)}}G.push({item:K,options:E});J.invalidQueue=G},queueItemLayouts:function(A){var C=A.isComponent?A:A.target,B=C.componentLayout;if(!B.pending&&!B.invalid&&!B.done){this.queueLayout(B)}B=C.layout;if(B&&!B.pending&&!B.invalid&&!B.done){this.queueLayout(B)}},queueLayout:function(A){this.layoutQueue.add(A);A.pending=true},removeEl:function(D,A){var E=A.id,B=D.children,C=this.items;if(B){Ext.Array.remove(B,C[E])}delete C[E]},resetLayout:function(C,D,A){var B=this;B.currentLayout=C;C.done=false;C.pending=true;C.firedTriggers=0;B.layoutQueue.add(C);if(A){B.layouts[C.id]=C;C.running=true;if(C.finishedLayout){B.finishQueue.add(C)}++B.remainingLayouts;++C.layoutCount;C.ownerContext=D;C.beginCount=0;C.blockCount=0;C.calcCount=0;C.triggerCount=0;if(!C.initialized){C.initLayout()}C.beginLayout(D)}else{++C.beginCount;if(!C.running){++B.remainingLayouts;C.running=true;if(C.isComponentLayout){D.unsetProp("done")}B.completionQueue.remove(C);B.finalizeQueue.remove(C)}}C.beginLayoutCycle(D,A)},run:function(){var B=this,C=false,A=100;B.purgeInvalidates();B.flushInvalidates();B.state=1;B.totalCount=B.layoutQueue.getCount();B.flush();while((B.remainingLayouts||B.invalidQueue.length)&&A--){if(B.invalidQueue.length){B.flushInvalidates()}if(B.runCycle()){C=false}else{if(!C){B.flush();C=true;B.flushLayouts("completionQueue","completeLayout")}else{if(!B.invalidQueue.length){B.state=2;break}}}if(!(B.remainingLayouts||B.invalidQueue.length)){B.flush();B.flushLayouts("completionQueue","completeLayout");B.flushLayouts("finalizeQueue","finalizeLayout")}}return B.runComplete()},runComplete:function(){var A=this;A.state=2;if(A.remainingLayouts){A.handleFailure();return false}A.flush();A.flushLayouts("finishQueue","finishedLayout",true);A.flushLayouts("finishQueue","notifyOwner");A.flush();A.flushAnimations();return true},runCycle:function(){var D=this,C=D.layoutQueue.clear(),A=C.length,B;++D.cycleCount;D.progressCount=0;for(B=0;B<A;++B){D.runLayout(D.currentLayout=C[B])}D.currentLayout=null;return D.progressCount>0},runLayout:function(B){var A=this,C=A.getCmp(B.owner);B.pending=false;if(C.state.blocks){return}B.done=true;++B.calcCount;++A.calcCount;B.calculate(C);if(B.done){A.layoutDone(B);if(B.completeLayout){A.queueCompletion(B)}if(B.finalizeLayout){A.queueFinalize(B)}}else{if(!B.pending&&!B.invalid&&!(B.blockCount+B.triggerCount-B.firedTriggers)){A.queueLayout(B)}}},setItemSize:function(D,G,A){var F=D,E=1,C,B;if(D.isComposite){F=D.elements;E=F.length;D=F[0]}else{if(!D.dom&&!D.el){E=F.length;D=F[0]}}for(B=0;B<E;){C=this.get(D);C.setSize(G,A);D=F[++B]}},debugHooks:{$enabled:false,pageAnalyzerMode:true,logOn:{0:0},cancelComponent:function(A){if(this.logOn.cancelComponent){Ext.log("cancelCmp: ",A.id)}this.callParent(arguments)},cancelLayout:function(A){if(this.logOn.cancelLayout){Ext.log("cancelLayout: ",this.getLayoutName(A))}this.callParent(arguments)},callLayout:function(C,B){var D=this.accumByType[C.type],A=D&&D.enter();this.callParent(arguments);if(D){A.leave()}},checkRemainingLayouts:function(){var C=this,B=0,A,D;for(A in C.layouts){D=C.layouts[A];if(C.layouts.hasOwnProperty(A)&&D.running){++B}}if(C.remainingLayouts!=B){Ext.Error.raise({msg:"Bookkeeping error me.remainingLayouts"})}},flush:function(){if(this.logOn.flush){var A=this.flushQueue;Ext.log("--- Flush ",A&&A.getCount())}return this.callParent(arguments)},flushInvalidates:function(){if(this.logOn.flushInvalidate){Ext.log(">> flushInvalidates")}var A=this.callParent(arguments);if(this.logOn.flushInvalidate){Ext.log("<< flushInvalidates")}return A},getCmp:function(B){var A=this.callParent(arguments);if(!A.wrapsComponent){Ext.Error.raise({msg:B.id+" is not a component"})}return A},getEl:function(C,B){var A=this.callParent(arguments);if(A&&A.wrapsComponent){Ext.Error.raise({msg:C.id+"/"+B.id+" is a component (expected element)"})}return A},getLayoutName:function(A){return A.owner.id+"<"+A.type+">"},layoutDone:function(C){var A=this,B=A.getLayoutName(C);if(A.logOn.layoutDone){Ext.log("layoutDone: ",B," ( ",A.remainingLayouts," running)")}if(!C.running){Ext.Error.raise({msg:B+" is already done"})}if(!A.remainingLayouts){Ext.Error.raise({msg:B+" finished but no layouts are running"})}A.callParent(arguments)},layoutTreeHasFailures:function(D,E){var C=this;function B(F){var H=!F.done,G,I;if(F.done){for(G in C.layouts){if(C.layouts.hasOwnProperty(G)){I=C.layouts[G];if(I.owner.ownerLayout===F){if(B(I)){H=true}}}}}return H}if(B(D)){return true}function A(F){var G,H;E[F.id]=1;for(G in C.layouts){if(C.layouts.hasOwnProperty(G)){H=C.layouts[G];if(H.owner.ownerLayout===F){A(H)}}}}A(D);return false},queueLayout:function(A){if(A.done||A.blockCount||A.pending){Ext.Error.raise({msg:this.getLayoutName(A)+" should not be queued for layout"})}if(this.logOn.queueLayout){Ext.log("Queue ",this.getLayoutName(A))}return this.callParent(arguments)},reportLayoutResult:function(J,E){var L=this,C=J.owner,B=L.getCmp(C),A=[],F=[],M,H,I,G,K,O,N,D;E[J.id]=1;for(M in J.blockedBy){if(J.blockedBy.hasOwnProperty(M)){A.push(J.blockedBy[M])}}A.sort();for(M in L.triggersByLayoutId[J.id]){if(L.triggersByLayoutId[J.id].hasOwnProperty(M)){H=L.triggersByLayoutId[J.id][M];F.push({name:M,info:H})}}F.sort(function(Q,P){return Q.name<P.name?-1:(P.name<Q.name?1:0)});Ext.log({indent:1},(J.done?"++":"--"),L.getLayoutName(J),(B.isBoxParent?" [isBoxParent]":""),(B.boxChildren?" - boxChildren: "+B.state.boxesMeasured+"/"+B.boxChildren.length:""),B.boxParent?(" - boxParent: "+B.boxParent.id):""," - size: ",B.widthModel.name,"/",B.heightModel.name);if(!J.done||L.reportOnSuccess){if(A.length){++Ext.log.indent;Ext.log({indent:1},"blockedBy:  count=",J.blockCount);G=A.length;for(I=0;I<G;I++){Ext.log(A[I])}Ext.log.indent-=2}if(F.length){++Ext.log.indent;Ext.log({indent:1},"triggeredBy: count="+J.triggerCount);G=F.length;for(I=0;I<G;I++){D=H.info||H;O=D.item;N=(O.setBy&&O.setBy[D.name])||"?";H=F[I];Ext.log(H.name," (",O.props[D.name],") dirty: ",(O.dirty?!!O.dirty[D.name]:false),", setBy: ",N)}Ext.log.indent-=2}}for(M in L.layouts){if(L.layouts.hasOwnProperty(M)){K=L.layouts[M];if(!K.done&&K.owner.ownerLayout===J){L.reportLayoutResult(K,E)}}}for(M in L.layouts){if(L.layouts.hasOwnProperty(M)){K=L.layouts[M];if(K.done&&K.owner.ownerLayout===J){L.reportLayoutResult(K,E)}}}--Ext.log.indent},resetLayout:function(F){var D=this,A=F.type,E=D.getLayoutName(F),C=D.accumByType[A],B;if(D.logOn.resetLayout){Ext.log("resetLayout: ",E," ( ",D.remainingLayouts," running)")}if(!D.state){if(!C&&D.profileLayoutsByType){D.accumByType[A]=C=Ext.Perf.get("layout_"+F.type)}D.numByType[A]=(D.numByType[A]||0)+1}B=C&&C.enter();D.callParent(arguments);if(C){B.leave()}D.checkRemainingLayouts()},round:function(A){return Math.round(A*1000)/1000},run:function(){var M=this,P,B,N,H,I,J,A,E,L,D,F,C,K,G,O;M.accumByType={};M.calcsByType={};M.numByType={};M.timesByType={};M.triggersByLayoutId={};Ext.log.indentSize=3;Ext.log("==================== LAYOUT ====================");B=Ext.perf.getTimestamp();P=M.callParent(arguments);B=Ext.perf.getTimestamp()-B;if(M.logOn.boxParent&&M.boxParents){for(N in M.boxParents){if(M.boxParents.hasOwnProperty(N)){A=M.boxParents[N];E=A.boxChildren;L=E.length;Ext.log("boxParent: ",A.id);for(I=0;I<L;++I){Ext.log(" --> ",E[I].id)}}}}if(P){Ext.log("----------------- SUCCESS -----------------")}else{Ext.log({level:"error"},"----------------- FAILURE -----------------")}for(N in M.layouts){if(M.layouts.hasOwnProperty(N)){J=M.layouts[N];if(J.running){Ext.log.error("Layout left running: ",M.getLayoutName(J))}if(J.ownerContext){Ext.log.error("Layout left connected: ",M.getLayoutName(J))}}}if(!P||M.reportOnSuccess){D={};F=0;for(N in M.layouts){if(M.layouts.hasOwnProperty(N)){J=M.layouts[N];if(M.items[J.owner.el.id].isTopLevel){if(M.reportOnSuccess||M.layoutTreeHasFailures(J,D)){M.reportLayoutResult(J,D)}}}}for(N in M.layouts){if(M.layouts.hasOwnProperty(N)){J=M.layouts[N];if(!D[J.id]){if(!F){Ext.log("----- Unreported!! -----")}++F;M.reportLayoutResult(J,D)}}}}Ext.log("Cycles: ",M.cycleCount,", Flushes: ",M.flushCount,", Calculates: ",M.calcCount," in ",M.round(B)," msec");Ext.log("Calculates by type:");C=[];for(N in M.numByType){if(M.numByType.hasOwnProperty(N)){K=M.numByType[N];C.push({type:N,total:K,calcs:M.calcsByType[N],multiple:Math.round(M.calcsByType[N]/K*10)/10,calcTime:M.round(M.timesByType[N]),avgCalcTime:M.round(M.timesByType[N]/M.calcsByType[N])})}}C.sort(function(R,Q){return Q.calcTime-R.calcTime});G=C.length;for(I=0;I<G;I++){O=C[I];Ext.log(O.type,": ",O.total," in ",O.calcs," tries (",O.multiple,"x) at ",O.calcTime," msec (avg ",O.avgCalcTime," msec)")}return P},runCycle:function(){if(this.logOn.runCycle){Ext.log(">>> Cycle ",this.cycleCount," (queue length: ",this.layoutQueue.length,")")}return this.callParent(arguments)},runLayout:function(F){var D=this,A=F.type,C=D.accumByType[A],B,E,G;if(D.logOn.calculate){Ext.log("-- calculate ",this.getLayoutName(F))}B=C&&C.enter();G=Ext.perf.getTimestamp();E=D.callParent(arguments);G=Ext.perf.getTimestamp()-G;if(C){B.leave()}D.calcsByType[A]=(D.calcsByType[A]||0)+1;D.timesByType[A]=(D.timesByType[A]||0)+G;return E}}});
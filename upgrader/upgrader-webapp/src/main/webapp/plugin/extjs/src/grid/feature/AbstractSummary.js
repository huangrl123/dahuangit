Ext.define("Ext.grid.feature.AbstractSummary",{extend:"Ext.grid.feature.Feature",alias:"feature.abstractsummary",summaryRowCls:Ext.baseCSSPrefix+"grid-row-summary",summaryRowSelector:"."+Ext.baseCSSPrefix+"grid-row-summary",readDataOptions:{recordCreator:Ext.identityFn},summaryRowTpl:{fn:function(A,B,C){if(B.record.isSummary&&this.summaryFeature.showSummaryRow){this.summaryFeature.outputSummaryRecord(B.record,B,A,C)}else{this.nextTpl.applyOut(B,A,C)}},priority:1000},showSummaryRow:true,init:function(){var A=this;A.view.summaryFeature=A;A.rowTpl=A.view.self.prototype.rowTpl;A.view.addRowTpl(A.summaryRowTpl).summaryFeature=A;A.summaryData={};A.groupInfo={};if(!A.summaryTableCls){A.summaryTableCls=Ext.baseCSSPrefix+"grid-item"}},toggleSummaryRow:function(A){this.showSummaryRow=arguments.length===1?!!A:!this.showSummaryRow},createRenderer:function(F,D){var B=this,E=D.ownerGroup,A=E?B.summaryData[E]:B.summaryData,C=F.dataIndex||F.id;return function(){return F.summaryRenderer?F.summaryRenderer(D.data[C],A,C):D.data[C]}},outputSummaryRecord:function(C,H,B){var A=H.view,J=A.rowValues,D=H.columns||A.headerCt.getVisibleGridColumns(),I=D.length,F,E,G={view:A,record:C,rowStyle:"",rowClasses:[this.summaryRowCls],itemClasses:[],recordIndex:-1,rowId:A.getRowId(C),columns:D};for(F=0;F<I;F++){E=D[F];E.savedRenderer=E.renderer;if(E.summaryType||E.summaryRenderer){E.renderer=this.createRenderer(E,C)}else{E.renderer=Ext.emptyFn}}A.rowValues=G;A.self.prototype.rowTpl.applyOut(G,B,parent);A.rowValues=J;for(F=0;F<I;F++){E=D[F];E.renderer=E.savedRenderer;E.savedRenderer=null}},getSummary:function(B,A,E,F){var D=!!F,C=D?F:B;if(A){if(Ext.isFunction(A)){if(D){return C.aggregate(E,A)}else{return C.aggregate(A,null,false,[E])}}switch(A){case"count":return C.count(E);case"min":return C.min(E);case"max":return C.max(E);case"sum":return C.sum(E);case"average":return C.average(E);default:return""}}},generateSummaryData:function(){var F=this,H=F.view.store,J=H.getGroups().items,L=H.getProxy().getReader(),K=J.length,O=F.getGroupField(),N={},A=F.lockingPartner,P,I,G,Q,E,B,C,D,M;if(F.remoteRoot&&L.rawData){B=true;D={};Q=L.getRootProperty();L.setRootProperty(F.remoteRoot);L.buildExtractors(true);E=L.getRoot(L.rawData)||[];K=E.length;for(P=0;P<K;++P){C=L.extractRecordData(E[P],F.readDataOptions);D[C[O]]=C}L.setRootProperty(Q);L.buildExtractors(true)}for(P=0;P<K;++P){I=J[P];M=F.getGroupInfo(I);if(B||H.updating||M.lastGeneration!==I.generation){G=F.populateRecord(I,M,D);if(!A||(F.view.ownerCt===F.view.ownerCt.ownerLockable.normalGrid)){M.lastGeneration=I.generation}}else{G=F.getAggregateRecord(I)}N[I.getGroupKey()]=G}return N},setSummaryData:function(B,C,D,A){if(A){if(!this.summaryData[A]){this.summaryData[A]={}}this.summaryData[A][C]=D}else{this.summaryData[C]=D}},populateRecord:function(G,L,M){var A=this,N=A.grid.ownerLockable?A.grid.ownerLockable.view:A.view,K=A.view.getStore(),I=A.getAggregateRecord(G),D=N.headerCt.getGridColumns(),B=D.length,H=G.getGroupKey(),E,F,O,C,P,J;I.beginEdit();if(M){E=M[H];for(F in E){if(E.hasOwnProperty(F)){if(F!==I.idProperty){I.set(F,E[F])}}}}for(O=0;O<B;++O){C=D[O];P=C.dataIndex||C.id;if(!M){J=A.getSummary(K,C.summaryType,P,G);I.set(P,J)}else{J=I.get(dataIndex)}A.setSummaryData(I,C.id,J,H)}I.ownerGroup=H;I.endEdit(true);I.commit();return I},getGroupInfo:function(B){var E=this.groupInfo,A=B.getGroupKey(),D=E[A],C;if(!D){C=this.view.getStore().getModel();D=E[A]={lastGeneration:null,aggregateRecord:new C()}}return D},getAggregateRecord:function(B,C){var D=this,A;if(C===true||B.dirty||!B.aggregateRecord){A=new (D.view.store.getModel())();B.aggregateRecord=A;A.isNonData=A.isSummary=true}return B.aggregateRecord}});
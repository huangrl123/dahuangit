Ext.define("Ext.grid.RowEditor",{extend:"Ext.form.Panel",alias:"widget.roweditor",requires:["Ext.tip.ToolTip","Ext.util.KeyNav","Ext.grid.RowEditorButtons"],saveBtnText:"Update",cancelBtnText:"Cancel",errorsText:"Errors",dirtyText:"You need to commit or cancel your changes",lastScrollLeft:0,lastScrollTop:0,border:false,errorCls:Ext.baseCSSPrefix+"grid-row-editor-errors-item",buttonUI:"default",hideMode:"offsets",initComponent:function(){var B=this,D=B.editingPlugin.grid,C=Ext.container.Container,A;B.cls=Ext.baseCSSPrefix+"grid-editor "+Ext.baseCSSPrefix+"grid-row-editor";B.layout={type:"hbox",align:"middle"};B.lockable=D.lockable;if(B.lockable){B.items=[B.lockedColumnContainer=new C({id:D.id+"-locked-editor-cells",layout:{type:"hbox",align:"middle"},margin:"0 1 0 0"}),B.normalColumnContainer=new C({flex:1,id:D.id+"-normal-editor-cells",layout:{type:"hbox",align:"middle"}})]}else{B.lockedColumnContainer=B.normalColumnContainer=B}B.callParent(arguments);if(B.fields){B.addFieldsForColumn(B.fields,true);B.insertColumnEditor(B.fields);delete B.fields}B.mon(Ext.GlobalEvents,{scope:B,show:B.repositionIfVisible});A=B.getForm();A.trackResetOnLoad=true;A.on("validitychange",B.onValidityChange,B)},onGridResize:function(){var D=this,B=D.getClientWidth(),E=D.editingPlugin.grid,C=E.body,A=D.getFloatingButtons();D.setLocalX(C.getOffsetsTo(E)[0]+C.getBorderWidth("l")-E.el.getBorderWidth("l"));D.setWidth(B);A.setLocalX((B-A.getWidth())/2)},syncAllFieldWidths:function(){var A=this;Ext.Array.each(A.query("[isEditorComponent]"),function(B){if(B.column.isVisible()){A.onColumnShow(B.column)}},A)},syncFieldWidth:function(C){var A=C.getEditor(),B;A._marginWidth=(A._marginWidth||A.el.getMargin("lr"));B=C.getWidth()-A._marginWidth;A.setWidth(B);if(A.xtype==="displayfield"){A.inputWidth=B}},onValidityChange:function(B,C){var A=this;if(A.errorSummary&&A.isVisible()){A[C?"hideToolTip":"showToolTip"]()}A.updateButton(C);A.isValid=C},updateButton:function(A){var B=this.floatingButtons;if(B){B.child("#update").setDisabled(!A)}else{this.updateButtonDisabled=!A}},afterRender:function(){var B=this,A=B.editingPlugin,D=A.grid,C=D.lockable?D.normalGrid.view:D.view;B.callParent(arguments);B.scrollingView=C;B.scrollingViewEl=C.el;C.on("scroll",B.onViewScroll,B);B.mon(B.el,{click:Ext.emptyFn,stopPropagation:true});B.mon(D,{resize:B.onGridResize,scope:B});B.el.swallowEvent(["keypress","keydown"]);B.fieldScroller=B.normalColumnContainer.layout.innerCt;B.fieldScroller.dom.style.overflow="hidden";B.fieldScroller.on({scroll:B.onFieldContainerScroll,scope:B});B.initKeyNav();B.mon(A.view,{beforerefresh:B.onBeforeViewRefresh,refresh:B.onViewRefresh,itemremove:B.onViewItemRemove,scope:B});B.preventReposition=true;B.syncAllFieldWidths();delete B.preventReposition},initKeyNav:function(){var B=this,A=B.editingPlugin;B.keyNav=new Ext.util.KeyNav(B.el,{enter:A.completeEdit,esc:A.onEscKey,scope:A})},onBeforeViewRefresh:function(C){var A=this,B=C.el.dom;if(A.el.dom.parentNode===B){B.removeChild(A.el.dom)}},onViewRefresh:function(D){var B=this,A=B.context,C;if(A&&(C=D.getRow(A.record))){A.row=C;B.reposition();if(B.tooltip&&B.tooltip.isVisible()){B.tooltip.setTarget(A.row)}}else{B.editingPlugin.cancelEdit()}},onViewItemRemove:function(C,D,B,E){if(!E.refreshing){var A=this.context;if(A&&C===A.record){this.editingPlugin.cancelEdit()}}},onViewScroll:function(){var G=this,D=G.editingPlugin.view.el,B=G.scrollingView,C=B.getScrollY(),E=B.getScrollX(),F=E!==G.lastScrollLeft,A=C!==G.lastScrollTop,H;G.lastScrollTop=C;G.lastScrollLeft=E;if(G.isVisible()){H=Ext.getDom(G.context.row);if(H&&D.contains(H)){if(A){G.context.row=H;G.reposition(null,true);if((G.tooltip&&G.tooltip.isVisible())||G.hiddenTip){G.repositionTip()}G.syncEditorClip()}}else{G.setLocalY(-400)}}if(G.rendered&&F){G.syncFieldsHorizontalScroll()}},syncFieldsHorizontalScroll:function(){this.fieldScroller.setScrollLeft(this.lastScrollLeft)},onFieldContainerScroll:function(){this.scrollingView.setScrollX(this.getFieldScrollerScrollX())},getFieldScrollerScrollX:function(){return this.fieldScroller.getScrollLeft()},onColumnResize:function(C,B){var A=this;if(A.rendered&&!A.editingPlugin.reconfiguring){A.onGridResize();A.onViewScroll();if(!C.isGroupHeader){A.syncFieldWidth(C);A.repositionIfVisible()}}},onColumnHide:function(A){if(!this.editingPlugin.reconfiguring&&!A.isGroupHeader){A.getEditor().hide();this.repositionIfVisible()}},onColumnShow:function(B){var A=this;if(A.rendered&&!A.editingPlugin.reconfiguring&&!B.isGroupHeader&&B.getEditor){B.getEditor().show();A.syncFieldWidth(B);if(!A.preventReposition){this.repositionIfVisible()}}},onColumnMove:function(C,J,B){var A=this,H=C.isLocked(),E=H?A.lockedColumnContainer:A.normalColumnContainer,D,F,I,K,G;if(C.isGroupHeader){Ext.suspendLayouts();K=B>J;G=K?1:0;D=C.getGridColumns();for(F=0,I=D.length;F<I;++F){C=D[F];B=C.getIndex();if(K){++G}A.setColumnEditor(C,B+G,E)}Ext.resumeLayouts(true)}else{A.setColumnEditor(C,C.getIndex(),E)}},setColumnEditor:function(C,B,A){this.addFieldsForColumn(C);A.insert(B,C.getEditor())},onColumnAdd:function(A){if(A.isGroupHeader){A=A.getGridColumns()}this.addFieldsForColumn(A);this.insertColumnEditor(A);this.preventReposition=false},insertColumnEditor:function(E){var C=this,B,D,A;if(Ext.isArray(E)){for(A=0,D=E.length;A<D;A++){C.insertColumnEditor(E[A])}return}if(!E.getEditor){return}B=E.isLocked()?C.lockedColumnContainer:C.normalColumnContainer;B.insert(E.getIndex(),E.getEditor());C.needsSyncFieldWidths=true},destroyColumnEditor:function(E){var B=this,D,C,A;if(Ext.isArray(E)){for(A=0,C=E.length;A<C;A++){B.removeColumnEditor(E[A])}return}if(E.hasEditor()&&(D=E.getEditor())){D.destroy()}},getFloatingButtons:function(){var B=this,A=B.floatingButtons;if(!A){B.floatingButtons=A=new Ext.grid.RowEditorButtons({rowEditor:B})}return A},repositionIfVisible:function(B){var A=this,C=A.view;if(B&&(B===A||!B.el.isAncestor(C.el))){return}if(A.isVisible()&&C.isVisible(true)){A.reposition()}},isDescendantOf:function(){return false},getRefOwner:function(){return this.editingPlugin.grid},getRefItems:function(B){var C=this,A;if(C.lockable){A=[C.lockedColumnContainer];A.push.apply(A,C.lockedColumnContainer.getRefItems(B));A.push(C.normalColumnContainer);A.push.apply(A,C.normalColumnContainer.getRefItems(B))}else{A=C.callParent(arguments)}A.push.apply(A,C.getFloatingButtons().getRefItems(B));return A},reposition:function(C,F){var G=this,D=G.context,E=D&&D.row,H=0,A,J,B,I;if(E&&Ext.isElement(E)){B=G.syncButtonPosition(G.getScrollDelta());if(!G.editingPlugin.grid.rowLines){H=-parseInt(Ext.fly(E).first().getStyle("border-bottom-width"),10)}A=G.calculateLocalRowTop(E);J=G.calculateEditorTop(A)+H;if(!F){I=function(){if(B){G.scrollingViewEl.scrollBy(0,B,true)}G.focusContextCell()}}G.syncEditorClip();if(C){G.animate(Ext.applyIf({to:{top:J},duration:C.duration||125,callback:I},C))}else{G.setLocalY(J);if(I){I()}}}},getScrollDelta:function(){var C=this,D=C.scrollingViewEl.dom,A=C.context,B=C.body,E=0;if(A){E=Ext.fly(A.row).getOffsetsTo(D)[1]-B.getBorderPadding().beforeY;if(E>0){E=Math.max(E+C.getHeight()+C.floatingButtons.getHeight()-D.clientHeight-B.getBorderWidth("b"),0)}}return E},calculateLocalRowTop:function(A){var B=this.editingPlugin.grid;return Ext.fly(A).getOffsetsTo(B)[1]-B.el.getBorderWidth("t")+this.lastScrollTop},calculateEditorTop:function(A){return A-this.body.getBorderPadding().beforeY-this.lastScrollTop},getClientWidth:function(){var B=this,C=B.editingPlugin.grid,A;if(B.lockable){A=C.lockedGrid.getWidth()+C.normalGrid.view.el.dom.clientWidth-1}else{A=C.view.el.dom.clientWidth}return A},getEditor:function(A){var B=this;if(Ext.isNumber(A)){return B.query("[isEditorComponent]")[A]}else{if(A.isHeader&&!A.isGroupHeader){return A.getEditor()}}},addFieldsForColumn:function(F,C){var D=this,A,B,E;if(Ext.isArray(F)){for(A=0,B=F.length;A<B;A++){D.addFieldsForColumn(F[A],C)}return}if(F.getEditor){E=F.getEditor(null,D.getDefaultFieldCfg());if(F.align==="right"){E.fieldStyle="text-align:right"}if(F.xtype==="actioncolumn"){E.fieldCls+=" "+Ext.baseCSSPrefix+"form-action-col-field"}if(D.isVisible()&&D.context){if(E.is("displayfield")){D.renderColumnData(E,D.context.record,F)}else{E.suspendEvents();E.setValue(D.context.record.get(F.dataIndex));E.resumeEvents()}}if(F.hidden){D.onColumnHide(F)}else{if(F.rendered&&!C){D.onColumnShow(F)}}}},getDefaultFieldCfg:function(){return{xtype:"displayfield",getModelData:function(){return null}}},loadRecord:function(G){var F=this,A=F.getForm(),I=A.getFields(),H=I.items,B=H.length,C,E,D;for(C=0;C<B;C++){H[C].suspendEvents()}A.loadRecord(G);for(C=0;C<B;C++){H[C].resumeEvents()}if(A.hasInvalidField()===A.wasValid){delete A.wasValid}D=A.isValid();if(F.errorSummary){if(D){F.hideToolTip()}else{F.showToolTip()}}F.updateButton(D);E=F.query(">displayfield");B=E.length;for(C=0;C<B;C++){F.renderColumnData(E[C],G)}},renderColumnData:function(J,L,M){var K=this,N=K.editingPlugin.grid,O=N.headerCt,A=K.scrollingView,B=A.dataSource,C=M||J.column,I=L.get(C.dataIndex),E=C.editRenderer||C.renderer,D,F,H,G=C.usingDefaultRenderer&&!C.scope?C:C.scope;if(E){D={tdCls:"",style:""};F=B.indexOf(L);H=O.getHeaderIndex(C);I=E.call(G||O.ownerCt,I,D,L,F,H,B,A)}J.setRawValue(I);J.resetOriginalValue()},beforeEdit:function(){var A=this,B;if(A.isVisible()&&A.errorSummary&&!A.autoCancel&&A.isDirty()){B=A.getScrollDelta();if(B){A.scrollingViewEl.scrollBy(0,B,true)}A.showToolTip();return false}},startEdit:function(D,E){var B=this,C=B.editingPlugin,F=C.grid,A=B.context=C.context;if(!B.rendered){B.width=B.getClientWidth();B.render(F.el,F.el.dom.firstChild);B.getFloatingButtons().render(B.el);B.onViewScroll()}else{B.syncFieldsHorizontalScroll()}A.grid.getSelectionModel().select(D);if(B.isVisible()){B.reposition(true)}else{B.show()}B.onGridResize();B.loadRecord(D)},syncButtonPosition:function(D){var C=this,E=C.getFloatingButtons(),F=C.scrollingView,A=F.el.dom,B=C.getScrollDelta()-(A.scrollHeight-F.getScrollY()-C.scrollingViewEl.dom.clientHeight);if(B>0){if(!C._buttonsOnTop){E.setButtonPosition("top");C._buttonsOnTop=true}D=0}else{if(C._buttonsOnTop!==false){E.setButtonPosition("bottom");C._buttonsOnTop=false}}return D},syncEditorClip:function(){var C=this,B=C.getScrollDelta(),A;if(B){C.isOverflowing=true;A=C.floatingButtons.getHeight();if(B>0){C.clipBottom(Math.max(C.getHeight()-B+A,-A))}else{if(B<0){B=Math.abs(B);C.clipTop(Math.max(B,0))}}}else{if(C.isOverflowing){C.clearClip();C.isOverflowing=false}}},focusContextCell:function(){var B=this.context.column,A;if(!B.isDestroyed){A=this.getEditor(B);if(A&&A.focus){A.focus()}}},cancelEdit:function(){var D=this,C=D.getForm(),F=C.getFields(),E=F.items,A=E.length,B;D.hide();C.clearInvalid();for(B=0;B<A;B++){E[B].suspendEvents()}C.reset();for(B=0;B<A;B++){E[B].resumeEvents()}},completeEdit:function(){var B=this,A=B.getForm();if(!A.isValid()){return false}A.updateRecord(B.context.record);B.hide();return true},onShow:function(){var A=this;A.callParent(arguments);if(A.needsSyncFieldWidths){A.suspendLayouts();A.syncAllFieldWidths();A.resumeLayouts(true)}delete A.needsSyncFieldWidths;A.reposition()},onHide:function(){var A=this;A.callParent(arguments);if(A.tooltip){A.hideToolTip()}if(A.context){A.context.view.focusRow(A.context.record);A.context=null}},isDirty:function(){var B=this,A=B.getForm();return A.isDirty()},getToolTip:function(){return this.tooltip||(this.tooltip=new Ext.tip.ToolTip({cls:Ext.baseCSSPrefix+"grid-row-editor-errors",title:this.errorsText,autoHide:false,closable:true,closeAction:"disable",anchor:"left",anchorToTarget:false}))},hideToolTip:function(){var B=this,A=B.getToolTip();if(A.rendered){A.disable()}B.hiddenTip=false},showToolTip:function(){var B=this,A=B.getToolTip();A.showAt([0,0]);A.update(B.getErrors());B.repositionTip();A.enable()},repositionTip:function(){var H=this,G=H.getToolTip(),C=H.context,E=Ext.get(C.row),D=H.scrollingViewEl,K=D.dom.clientHeight,B=H.lastScrollTop,A=B+K,J=E.getHeight(),I=E.getOffsetsTo(H.context.view.body)[1],F=I+J;if(F>B&&I<A){G.showAt(G.getAlignToXY(D,"tl-tr",[15,E.getOffsetsTo(D)[1]]));H.hiddenTip=false}else{G.hide();H.hiddenTip=true}},getErrors:function(){var D=this,A=[],E=D.query(">[isFormField]"),B=E.length,C;for(C=0;C<B;C++){A=A.concat(Ext.Array.map(E[C].getErrors(),D.createErrorListItem))}if(!A.length&&!D.autoCancel&&D.isDirty()){A[0]=D.createErrorListItem(D.dirtyText)}return'<ul class="'+Ext.plainListCls+'">'+A.join("")+"</ul>"},createErrorListItem:function(A){return'<li class="'+this.errorCls+'">'+A+"</li>"},beforeDestroy:function(){Ext.destroy(this.floatingButtons,this.tooltip);this.callParent()},clipBottom:function(A){this.el.setStyle("clip","rect(-1000px auto "+A+"px auto)")},clipTop:function(A){this.el.setStyle("clip","rect("+A+"px auto 1000px auto)")},clearClip:function(A){this.el.setStyle("clip",Ext.isIE8?"rect(-1000px auto 1000px auto)":"auto")}});
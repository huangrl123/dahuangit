Ext.define("Ext.grid.plugin.BufferedRenderer",{extend:"Ext.AbstractPlugin",alias:"plugin.bufferedrenderer",isBufferedRenderer:true,lockableScope:"both",numFromEdge:2,trailingBufferZone:10,leadingBufferZone:20,synchronousRender:true,scrollToLoadBuffer:200,viewSize:100,rowHeight:21,position:0,lastScrollDirection:1,bodyTop:0,scrollHeight:0,init:function(D){var B=this,C=D.view,A={scroll:B.onViewScroll,resize:B.onViewResize,refresh:B.onViewRefresh,columnschanged:B.checkVariableRowHeight,scope:B,destroyable:true};if(D.isTree||D.ownerLockable&&D.ownerLockable.isTree){C.blockRefresh=false;C.loadMask=true}if(C.positionBody){A.refresh=B.onViewRefresh}B.grid=D;B.view=C;B.isRTL=C.getInherited().rtl;C.bufferedRenderer=B;C.preserveScrollOnRefresh=true;C.animate=false;B.bindStore(C.dataSource);if(C.hasOwnProperty("rowHeight")){B.rowHeight=C.rowHeight}B.position=0;B.gridListeners=D.on("reconfigure",B.onReconfigure,B);B.viewListeners=C.on(A)},checkVariableRowHeight:function(){var A=this,B=A.grid;A.variableRowHeight=A.view.hasVariableRowHeight();if(B.ownerLockable){B.ownerLockable.syncRowHeight=A.variableRowHeight}},bindStore:function(A){var C=this,D=C.view,B=D.dataSource,E=B&&B.isFeatureStore;if(E===A.isFeatureStore){if(C.store){C.unbindStore()}C.storeListeners=A.on({scope:C,groupchange:C.onStoreGroupChange,clear:C.onStoreClear,destroyable:true});C.store=A}if(C.view.componentLayout.layoutCount){C.onViewResize(C.view,0,C.view.getHeight())}},onReconfigure:function(B,A){if(A&&A!==this.store){this.bindStore(A)}},unbindStore:function(){this.storeListeners.destroy();this.store=null},onStoreClear:function(){var A=this,B=A.view;if(B.rendered&&!A.store.isDestroyed){if(A.scrollTop!==0){A.bodyTop=A.scrollTop=A.position=A.scrollHeight=0;A.view.setScrollY(0)}A.lastScrollDirection=A.scrollOffset=null;if(!B.hasOwnProperty("rowHeight")){delete A.rowHeight}}},onStoreGroupChange:function(A){var B=this;delete B.rowHeight;B.stretchView(B.view,B.getScrollHeight())},onViewRefresh:function(){var B=this,C=B.view,A=B.scrollHeight,D;B.checkVariableRowHeight();if(B.variableRowHeight&&!C.componentLayoutCounter){C.on({boxready:B.onViewRefresh,scope:B,single:true});return}if(!C.hasOwnProperty("rowHeight")&&C.all.getCount()){delete B.rowHeight}D=B.getScrollHeight();if(D!=A){B.stretchView(C,D)}if(B.refreshing){return}if(B.scrollTop!==C.getScrollY()){B.onViewScroll()}else{if(!B.hasOwnProperty("bodyTop")){B.bodyTop=C.all.startIndex*B.rowHeight;C.setScrollY(B.bodyTop)}B.setBodyTop(B.bodyTop);if(C.all.getCount()){Ext.on({idle:function(){if(!C.isDestroyed){B.onViewResize(C,null,C.getHeight())}},single:true})}}},onViewResize:function(E,F,B,D,C){var A=this,G;A.tableTopBorderWidth=E.body.getBorderWidth("t");if(!C||B!==C){G=Math.ceil(B/A.rowHeight)+A.trailingBufferZone+A.leadingBufferZone;A.viewSize=A.setViewSize(G);A.viewClientHeight=E.el.dom.clientHeight}},stretchView:function(C,F){var B=this,D=(B.store.isBufferedStore?B.store.getTotalCount():B.store.getCount()),A=C.getTargetEl(),E;if(B.scrollTop>F){B.position=B.scrollTop=F-C.body.dom.offsetHeight;B.view.setScrollY(B.scrollTop)}if(B.bodyTop>F){C.body.translate(null,B.bodyTop=B.position)}if(C.scrollManager){C.scrollManager.scroller.setSize({x:C.headerCt.getTableWidth(),y:F});C.scrollManager.refresh()}if(!C.scrollManager||Ext.supports.touchScroll===1){if(!B.stretcher){A=C.getTargetEl();if(C.refreshCounter){C.fixedNodes++}E={style:{width:"1px",height:"1px","marginTop":(F-1)+"px",position:"absolute"}};E.style[B.isRTL?"right":"left"]=0;B.stretcher=A.createChild(E,A.dom.firstChild)}if(B.hasOwnProperty("viewSize")&&D<=B.viewSize){B.stretcher.dom.style.display="none"}else{B.stretcher.dom.style.marginTop=(F-1)+"px";B.stretcher.dom.style.display=""}}},setViewSize:function(F){if(F!==this.viewSize){this.scrollTop=this.view.getScrollY();var G=this,E=G.store,A=G.view,B=A.all,I=B.getCount(),C,D,H=G.view.lockingPartner&&G.view.lockingPartner.bufferedRenderer;G.viewSize=F;if(E.isBufferedStore){E.setViewSize(F)}if(I){C=A.all.startIndex;D=Math.min(C+F-1,(E.isBufferedStore?E.getTotalCount():E.getCount())-1);if(!(C===B.startIndex&&D===B.endIndex)){if(H){H.disable()}A.clearViewEl(true);G.renderRange(C,D);if(H){H.enable()}}}}return F},getViewRange:function(){var B=this,D=B.view.all,A=B.store,C=0;if(D.getCount()){C=D.startIndex}else{if(A.isBufferedStore){if(!A.currentPage){A.currentPage=1}C=D.startIndex=(A.currentPage-1)*(A.pageSize||1);A.currentPage=1}}if(A.data.getCount()){return A.getRange(C,C+B.viewSize-1)}else{return[]}},onReplace:function(E,J,F,G){var H=this,A=H.view,B=A.all,C=B.getCount(),I=E.getCount(),D=B.first(true);if(!C||J<=B.endIndex||(C<H.viewSize&&G.length>F.length)||I<C){H.refreshView();C=B.getCount();if(G.length<F.length){I=E.isBufferedStore?E.getTotalCount():I;if(B.endIndex===I-1&&C<H.viewSize&&C<I){B.scroll(E.getRange(Math.max(0,I-H.viewSize),B.startIndex-1),-1,0);if(I>H.viewSize){H.setBodyTop(H.bodyTop-D.offsetTop)}}if(I<=H.viewSize){if(H.stretcher){H.setBodyTop(0);H.stretcher.dom.style.display="none"}}else{if(H.bodyTop+A.body.dom.offsetHeight-1>H.scrollHeight){H.setBodyTop(H.scrollHeight-(A.body.dom.offsetHeight-1))}}}}else{H.refreshing=true;H.onViewRefresh();H.refreshing=true}},scrollTo:function(J,D,A,K){var E=this,I=E.view,O=I.el.dom,H=E.store,P=H.isBufferedStore?H.getTotalCount():H.getCount(),L,Q,B,G,N,C,M,F;if((C=I.dataSource.groupingFeature)&&(C.collapsible!==false)){J=Math.min(Math.max(J,0),I.store.getCount()-1);F=I.store.getAt(J);M=C.getGroup(F);if(M.isCollapsed){C.expand(M.getGroupKey());P=H.isBufferedStore?H.getTotalCount():H.getCount()}J=C.indexOf(F)}else{J=Math.min(Math.max(J,0),P-1)}L=Math.max(Math.min(J-(Math.floor((E.leadingBufferZone+E.trailingBufferZone)/2)),P-E.viewSize+1),0);N=Math.max(L*E.rowHeight-E.tableTopBorderWidth,0);Q=Math.min(L+E.viewSize-1,P-1);H.getRange(L,Q,{callback:function(S,T,R){E.renderRange(T,R,true);B=H.data.getRange(J,J+1)[0];G=I.getNode(B);I.body.translate(null,E.bodyTop=N);E.position=E.scrollTop=N=Math.min(Math.max(0,N-I.body.getOffsetsTo(G)[1]),O.scrollHeight-O.clientHeight);I.setScrollY(N);if(Ext.isIE){I.setScrollY(N)}if(D){I.selModel.select(B)}if(A){A.call(K||E,J,B)}}})},onViewScroll:function(){var F=this,A=F.store,H=(A.isBufferedStore?A.getTotalCount():A.getCount()),E,C,D=F.scrollTop=F.view.getScrollY(),B=false,G=F.view.lockingPartner&&F.view.lockingPartner.bufferedRenderer;if(!(F.disabled||H<F.viewSize)){E=D-F.position;C=E>0?1:-1;if(Math.abs(E)>=20||(C!==F.lastScrollDirection)){F.lastScrollDirection=C;B=F.handleViewScroll(F.lastScrollDirection)}}if(!B){if(G&&G.scrollTop!==D){G.view.setScrollY(G.position=D)}}},handleViewScroll:function(A){var E=this,C=E.view.all,F=E.store,B=E.viewSize,D=(F.isBufferedStore?F.getTotalCount():F.getCount())-1,G,H;if(A==-1){if(C.startIndex){if(E.topOfViewCloseToEdge()){G=Math.max(0,E.getLastVisibleRowIndex()+E.trailingBufferZone-B)}}}else{if(C.endIndex<D){if(E.bottomOfViewCloseToEdge()){G=Math.max(0,E.getFirstVisibleRowIndex()-E.trailingBufferZone)}}}if(G!=null){H=Math.min(G+B-1,D);if(E.variableRowHeight&&H===C.endIndex&&H<D){H++;E.viewSize=B++;if(F.isBufferedStore){F.setViewSize(E.viewSize)}}if(G!==C.startIndex||H!==C.endIndex){E.renderRange(G,H);return true}}},bottomOfViewCloseToEdge:function(){var A=this;if(A.variableRowHeight){return A.bodyTop+A.view.body.dom.offsetHeight<A.scrollTop+A.view.lastBox.height+(A.numFromEdge*A.rowHeight)}else{return(A.view.all.endIndex-A.getLastVisibleRowIndex())<A.numFromEdge}},topOfViewCloseToEdge:function(){var A=this;if(A.variableRowHeight){return A.bodyTop>A.scrollTop-(A.numFromEdge*A.rowHeight)}else{return(A.getFirstVisibleRowIndex()-A.view.all.startIndex)<A.numFromEdge}},refreshView:function(C){var A=this,E=A.view.all,B=A.store,F=(B.isBufferedStore?B.getTotalCount():B.getCount())-1,D;C=Math.max(0,Math.min(C==null?E.startIndex:C,F-(A.viewSize-A.leadingBufferZone)+1));D=Math.min(E.startIndex+A.viewSize-1,F);B.getRange(C,D,{callback:A.doRefreshView,scope:A})},doRefreshView:function(H,E,C,F){var G=this,A=G.view,B=A.all,D=B.getCount(),I;if(A.refreshCounter){A.refreshing=G.refreshing=true;A.clearViewEl(true);if(H.length){I=A.doAdd(H,E);A.refreshSize(B.getCount()!==D);A.fireEvent("refresh",A,H)}A.selModel.onLastFocusChanged(null,A.selModel.lastFocused,true);A.refreshNeeded=A.refreshing=G.refreshing=false}else{A.refresh()}},renderRange:function(E,D,F){var C=this,B=C.view.all,A=C.store;if(!(E===B.startIndex&&D===B.endIndex)){if(A.rangeCached(E,D)){C.cancelLoad();if(C.synchronousRender||F){C.onRangeFetched(null,E,D)}else{if(!C.renderTask){C.renderTask=new Ext.util.DelayedTask(C.onRangeFetched,C,null,false)}C.renderTask.delay(1,null,null,[null,E,D])}}else{C.attemptLoad(E,D)}}},onRangeFetched:function(C,J,H,M,R){var F=this,N=F.view,B,P=N.all,G,D=0,K,Q,A=F.view.lockingPartner&&F.view.lockingPartner.bufferedRenderer,L,O,E,I=F.variableRowHeight;if(N.isDestroyed){return}if(C){F.scrollTop=F.view.getScrollY()}else{C=F.store.getRange(J,H);if(!C){return}}if(I){K=F.scrollTop-F.rowHeight*(F.scrollTop<F.position?F.leadingBufferZone:F.trailingBufferZone)}else{K=J*F.rowHeight-F.tableTopBorderWidth}if(J<P.startIndex&&H>P.endIndex){O=P.startIndex-J;N.clearViewEl(true);L=N.doAdd(C,J);N.fireEvent("itemadd",C,J,L);for(E=0;E<O;E++){D-=L[E].offsetHeight}F.setBodyTop(F.bodyTop+D);return}if(F.teleported||J>P.endIndex||H<P.startIndex){N.clearViewEl(true);Q=K;F.teleported=false}if(!P.getCount()){L=N.doAdd(C,J);N.fireEvent("itemadd",C,J,L)}else{if(H>P.endIndex){G=Math.max(J-P.startIndex,0);if(I){D=P.item(P.startIndex+G,true).offsetTop}P.scroll(Ext.Array.slice(C,P.endIndex+1-J),1,G,J,H);if(I){Q=F.bodyTop+D}else{Q=K}}else{G=Math.max(P.endIndex-H,0);B=P.startIndex;P.scroll(Ext.Array.slice(C,0,P.startIndex-J),-1,G,J,H);if(I){Q=F.bodyTop-P.item(B,true).offsetTop;if(!P.startIndex){if(Q){N.setScrollY(F.position=(F.scrollTop-=Q));Q=0}}else{if(Q<0){D=P.startIndex*F.rowHeight;N.setScrollY(F.position=(F.scrollTop+=D));Q=F.bodyTop+D}}}else{Q=K}}}F.position=F.scrollTop;Q=Math.max(Math.floor(Q),0);if(N.positionBody){F.setBodyTop(Q)}if(A&&!A.disabled&&!R){A.onRangeFetched(null,J,H,M,true);if(A.bodyTop!==Q){A.setBodyTop(Q)}if(A.scrollTop!==F.scrollTop){A.view.setScrollY(A.scrollTop=A.position=F.scrollTop)}}},setBodyTop:function(D){var C=this,E=C.view,A=C.store,B=E.body;B.translate((C.isRTL&&Ext.supports.xOriginBug&&E.scrollFlags.y)?Ext.getScrollbarSize().width:null,C.bodyTop=D);if(C.variableRowHeight){if(E.all.endIndex===(A.isBufferedStore?A.getTotalCount():A.getCount())-1){C.stretchView(E,C.bodyTop+B.dom.offsetHeight-1)}else{if(C.bodyTop+B.dom.offsetHeight-1>C.scrollHeight){C.stretchView(E,C.scrollHeight+=((A.isBufferedStore?A.getTotalCount():A.getCount())-E.all.endIndex)*C.rowHeight)}}}},getFirstVisibleRowIndex:function(I,F,B,E){var J=this,A=J.view,K=A.all,C=K.elements,G=J.viewClientHeight,H,L,D=J.bodyTop;if(K.getCount()&&J.variableRowHeight){if(!arguments.length){I=K.startIndex;F=K.endIndex;B=J.scrollTop;E=B+G;if(D>E||D+A.body.dom.offsetHeight<B){J.teleported=true;return Math.floor(J.scrollTop/J.rowHeight)}H=I+Math.min(J.numFromEdge+((J.lastScrollDirection===-1)?J.leadingBufferZone:J.trailingBufferZone),Math.floor((F-I)/2))}else{H=I+Math.floor((F-I)/2)}L=D+C[H].offsetTop;if(L+C[H].offsetHeight<B){return J.getFirstVisibleRowIndex(H+1,F,B,E)}if(L<=B){return H}else{if(H!==I){return J.getFirstVisibleRowIndex(I,H-1,B,E)}}}return Math.floor(J.scrollTop/J.rowHeight)},getLastVisibleRowIndex:function(I,F,B,E){var K=this,A=K.view,L=A.all,C=L.elements,G=K.viewClientHeight,H,M,J,D=K.bodyTop;if(L.getCount()&&K.variableRowHeight){if(!arguments.length){I=L.startIndex;F=L.endIndex;B=K.scrollTop;E=B+G;if(D>E||D+A.body.dom.offsetHeight<B){K.teleported=true;return Math.floor(K.scrollTop/K.rowHeight)+Math.ceil(G/K.rowHeight)}H=F-Math.min(K.numFromEdge+((K.lastScrollDirection===1)?K.leadingBufferZone:K.trailingBufferZone),Math.floor((F-I)/2))}else{H=I+Math.floor((F-I)/2)}M=D+C[H].offsetTop;if(M>E){return K.getLastVisibleRowIndex(I,H-1,B,E)}J=M+C[H].offsetHeight;if(J>=E){return H}else{if(H!==F){return K.getLastVisibleRowIndex(H+1,F,B,E)}}}return K.getFirstVisibleRowIndex()+Math.ceil(G/K.rowHeight)},getScrollHeight:function(D){var F=this,A=F.view,B=A.all,E=F.store,G=E.isBufferedStore?E.getTotalCount():E.getCount(),H,C;if(!G){return 0}if(!F.hasOwnProperty("rowHeight")){if(H=B.getCount()){F.rowHeight=F.variableRowHeight?Math.floor(A.body.dom.clientHeight/H):B.first(true).offsetHeight}}C=Math.floor(G*F.rowHeight);if(!D){if(C&&(B.endIndex===G-1)){C=Math.max(C,F.bodyTop+A.body.dom.offsetHeight-1)}}return F.scrollHeight=C},attemptLoad:function(C,B){var A=this;if(A.scrollToLoadBuffer){if(!A.loadTask){A.loadTask=new Ext.util.DelayedTask(A.doAttemptLoad,A,[])}A.loadTask.delay(A.scrollToLoadBuffer,A.doAttemptLoad,A,[C,B])}else{A.store.getRange(C,B,{callback:A.onRangeFetched,scope:A,fireEvent:false})}},cancelLoad:function(){if(this.loadTask){this.loadTask.cancel()}},doAttemptLoad:function(B,A){this.store.getRange(B,A,{callback:this.onRangeFetched,scope:this,fireEvent:false})},destroy:function(){var A=this,B=A.view;if(B&&B.el){B.un("scroll",A.onViewScroll,A)}Ext.destroy(A.viewListeners,A.storeListeners,A.gridListeners)}},function(A){if(Ext.supports.Touch){A.prototype.leadingBufferZone=A.prototype.trailingBufferZone=2;A.prototype.numFromEdge=1}});
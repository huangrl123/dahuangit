Ext.define("Ext.grid.header.DropZone",{extend:"Ext.dd.DropZone",colHeaderCls:Ext.baseCSSPrefix+"column-header",proxyOffsets:[-4,-9],constructor:function(B){var A=this;A.headerCt=B;A.ddGroup=A.getDDGroup();A.autoGroup=true;A.callParent([B.el])},destroy:function(){this.callParent();Ext.destroy(this.topIndicator,this.bottomIndicator)},getDDGroup:function(){return"header-dd-zone-"+this.headerCt.up("[scrollerOwner]").id},getTargetFromEvent:function(A){return A.getTarget("."+this.colHeaderCls)},getTopIndicator:function(){if(!this.topIndicator){this.topIndicator=Ext.getBody().createChild({role:"presentation",cls:Ext.baseCSSPrefix+"col-move-top","data-sticky":true,html:"&#160;"});this.indicatorXOffset=Math.floor((this.topIndicator.dom.offsetWidth+1)/2)}return this.topIndicator},getBottomIndicator:function(){if(!this.bottomIndicator){this.bottomIndicator=Ext.getBody().createChild({role:"presentation",cls:Ext.baseCSSPrefix+"col-move-bottom","data-sticky":true,html:"&#160;"})}return this.bottomIndicator},getLocation:function(A,D){var C=A.getXY()[0],E=Ext.fly(D).getRegion(),B;if((E.right-C)<=(E.right-E.left)/2){B="after"}else{B="before"}return{pos:B,header:Ext.getCmp(D.id),node:D}},positionIndicator:function(Q,N,K){var F=this,B=Q.header,V=F.getLocation(K,N),W=V.header,U=V.pos,P,O,I,D,L,R,G,M,E,J,A,C,H,S,T;if(W===F.lastTargetHeader&&U===F.lastDropPos){return}P=B.nextSibling("gridcolumn:not([hidden])");O=B.previousSibling("gridcolumn:not([hidden])");F.lastTargetHeader=W;F.lastDropPos=U;if(!W.draggable&&U==="before"&&W.getIndex()===0){return false}Q.dropLocation=V;if((B!==W)&&((U==="before"&&P!==W)||(U==="after"&&O!==W))&&!W.isDescendantOf(B)){C=Ext.dd.DragDropManager.getRelated(F);H=C.length;S=0;for(;S<H;S++){T=C[S];if(T!==F&&T.invalidateDrop){T.invalidateDrop()}}F.valid=true;I=F.getTopIndicator();D=F.getBottomIndicator();if(U==="before"){L="bc-tl";R="tc-bl"}else{L="bc-tr";R="tc-br"}G=I.getAlignToXY(W.el,L);M=D.getAlignToXY(W.el,R);E=F.headerCt.el;J=E.getX()-F.indicatorXOffset;A=E.getX()+E.getWidth();G[0]=Ext.Number.constrain(G[0],J,A);M[0]=Ext.Number.constrain(M[0],J,A);I.setXY(G);D.setXY(M);I.show();D.show()}else{F.invalidateDrop()}},invalidateDrop:function(){this.valid=false;this.hideIndicators()},onNodeOver:function(E,B,A,C){var G=this,F=C.header,D,H,J,I;if(C.header.el.dom===E){D=false}else{C.isLock=C.isUnlock=C.crossPanel=false;H=G.getLocation(A,E).header;D=(F.ownerCt===H.ownerCt);if(!D&&(!F.ownerCt.sealed&&!H.ownerCt.sealed)){D=true;J=F.up("tablepanel");I=H.up("tablepanel");if(J!==I){C.crossPanel=true;C.isLock=I.isLocked&&!J.isLocked;C.isUnlock=!I.isLocked&&J.isLocked;if((C.isUnlock&&F.lockable===false)||(C.isLock&&!F.isLockable())){D=false}}}}if(D){G.positionIndicator(C,E,A)}else{G.valid=false}return G.valid?G.dropAllowed:G.dropNotAllowed},hideIndicators:function(){var A=this;A.getTopIndicator().hide();A.getBottomIndicator().hide();A.lastTargetHeader=A.lastDropPos=null},onNodeOut:function(){this.hideIndicators()},onNodeDrop:function(M,G,E,D){if(this.valid){var C=D.header,R=D.dropLocation,T=R.header,H=C.ownerCt,I=T.ownerCt,O=H===I,P=H.items.indexOf(D.header),S=I.items.indexOf(T),K=this.headerCt,J=K.visibleColumnManager,N=J.getHeaderIndex(C),Q=T.isGroupHeader?I.items.indexOf(T):J.getHeaderIndex(T),A=C.isGroupHeader?C.query(":not([hidden]):not([isGroupHeader])").length:1,F=T.isGroupHeader?(R.pos==="after"):J.getHeaderIndex(T)>J.getHeaderIndex(C),L,B;if(R.pos==="after"){S++;Q+=T.isGroupHeader?T.query(":not([hidden]):not([isGroupHeader])").length:1}if(D.isLock){L=H.up("[scrollerOwner]");L.lock(C,S,I)}else{if(D.isUnlock){L=H.up("[scrollerOwner]");L.unlock(C,S,I)}else{this.invalidateDrop();B=C.getWidth();if(O){if(S>P){S-=1}if(S===P){K.onHeaderMoved(C,A,N,Q);return}}Ext.suspendLayouts();if(O){I.move(P,S)}else{if(F&&(Q===S)){S-=1}H.isDDMoveInGrid=I.isDDMoveInGrid=!D.crossPanel;H.remove(C,false);I.insert(S,C);H.isDDMoveInGrid=I.isDDMoveInGrid=false}if(I.isGroupHeader){if(!O){C.savedFlex=C.flex;delete C.flex;C.width=B}}else{if(C.savedFlex){C.flex=C.savedFlex;delete C.width}}Ext.resumeLayouts(true);if(!O){K.onHeaderMoved(C,A,N,Q)}}}}}});
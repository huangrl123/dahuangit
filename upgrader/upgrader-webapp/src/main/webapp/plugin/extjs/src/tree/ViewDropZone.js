Ext.define("Ext.tree.ViewDropZone",{extend:"Ext.view.DropZone",allowParentInserts:false,allowContainerDrops:false,appendOnly:false,expandDelay:500,indicatorCls:Ext.baseCSSPrefix+"tree-ddindicator",expandNode:function(A){var B=this.view;this.expandProcId=false;if(!A.isLeaf()&&!A.isExpanded()){B.expand(A);this.expandProcId=false}},queueExpand:function(A){this.expandProcId=Ext.Function.defer(this.expandNode,this.expandDelay,this,[A])},cancelExpand:function(){if(this.expandProcId){clearTimeout(this.expandProcId);this.expandProcId=false}},getPosition:function(B,D){var A=this.view,G=A.getRecord(D),H=B.getY(),F=G.isLeaf(),C=false,I=Ext.fly(D).getRegion(),E;if(G.isRoot()){return"append"}if(this.appendOnly){return F?false:"append"}if(!this.allowParentInserts){C=G.hasChildNodes()&&G.isExpanded()}E=(I.bottom-I.top)/(F?2:3);if(H>=I.top&&H<(I.top+E)){return"before"}else{if(!C&&(F||(H>=(I.bottom-E)&&H<=I.bottom))){return"after"}else{return"append"}}},isValidDropPoint:function(I,J,B,C,D){if(!I||!D.item){return false}var A=this.view,H=A.getRecord(I),F=D.records,G=F.length,E=F.length,K,L;if(!(H&&J&&G)){return false}for(K=0;K<E;K++){L=F[K];if(L.isNode&&L.contains(H)){return false}}if(J==="append"&&H.get("allowDrop")===false){return false}else{if(J!=="append"&&H.parentNode.get("allowDrop")===false){return false}}if(Ext.Array.contains(F,H)){return false}return A.fireEvent("nodedragover",H,J,D,C)!==false},onNodeOver:function(F,B,C,D){var G=this.getPosition(C,F),J=this.dropNotAllowed,A=this.view,E=A.getRecord(F),I=this.getIndicator(),H=0;this.cancelExpand();if(G==="append"&&!this.expandProcId&&!Ext.Array.contains(D.records,E)&&!E.isLeaf()&&!E.isExpanded()){this.queueExpand(E)}if(this.isValidDropPoint(F,G,B,C,D)){this.valid=true;this.currentPosition=G;this.overRecord=E;I.setWidth(Ext.fly(F).getWidth());H=Ext.fly(F).getY()-Ext.fly(A.el).getY()-1;if(G==="before"){J=E.isFirst()?Ext.baseCSSPrefix+"tree-drop-ok-above":Ext.baseCSSPrefix+"tree-drop-ok-between";I.showAt(0,H);B.proxy.show()}else{if(G==="after"){J=E.isLast()?Ext.baseCSSPrefix+"tree-drop-ok-below":Ext.baseCSSPrefix+"tree-drop-ok-between";H+=Ext.fly(F).getHeight();I.showAt(0,H);B.proxy.show()}else{J=Ext.baseCSSPrefix+"tree-drop-ok-append";I.hide()}}}else{this.valid=false}this.currentCls=J;return J},onNodeOut:function(A,D,C,B){this.valid=false;this.getIndicator().hide()},onContainerOver:function(C,A,B){return this.allowContainerDrops?this.dropAllowed:A.getTarget("."+this.indicatorCls)?this.currentCls:this.dropNotAllowed},onContainerDrop:function(C,A,B){if(this.allowContainerDrops){this.valid=true;this.currentPosition="append";this.overRecord=this.view.store.getRoot();this.onNodeDrop(this.overRecord,C,A,B)}},notifyOut:function(){this.callParent(arguments);this.cancelExpand()},handleNodeDrop:function(D,G,I){var K=this,H=K.view,E=G?G.parentNode:H.panel.getRootNode(),N=H.store.getModel(),C,L,A,M,F,J,O,B;if(D.copy){C=D.records;D.records=[];for(L=0,A=C.length;L<A;L++){M=C[L];if(M.isNode){D.records.push(M.copy())}else{D.records.push(new N(Ext.apply({},M.data)))}}}K.cancelExpand();if(I==="before"){F=E.insertBefore;J=[null,G];G=E}else{if(I==="after"){if(G.nextSibling){F=E.insertBefore;J=[null,G.nextSibling]}else{F=E.appendChild;J=[null]}G=E}else{if(!(G.isExpanded()||G.isLoading())){O=true}F=G.appendChild;J=[null]}}B=function(){var Q,P;Ext.suspendLayouts();for(L=0,A=D.records.length;L<A;L++){M=D.records[L];if(!M.isNode){if(M.isModel){M=new N(M.data,M.getId())}else{M=new N(M)}D.records[L]=M}J[0]=M;F.apply(G,J)}if(K.sortOnDrop){G.sort(G.getOwnerTree().store.getSorters().sortFn)}Ext.resumeLayouts(true);if(Ext.enableFx&&K.dropHighlight){Q=K.dropHighlightColor;for(L=0;L<A;L++){P=H.getNode(D.records[L]);if(P){Ext.fly(P).highlight(Q)}}}};if(O){G.expand(false,B)}else{if(G.isLoading()){G.on({expand:B,delay:1,single:true})}else{B()}}}});